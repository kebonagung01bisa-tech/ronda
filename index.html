<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Ronda RT001/RW005 KebonAgung</title>
    <!-- Menggunakan Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome untuk Ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .page-content { display: none; }
        .page-content.active { display: block; }
        .tab-btn.active { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: 600; }
        .rotate-180 { transform: rotate(180deg); }
        /* Kustom Scrollbar untuk Thumbnail Foto */
        .hide-scroll::-webkit-scrollbar { height: 6px; }
        .hide-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .hide-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .hide-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans min-h-screen pb-10">

    <!-- LOGIN SCREEN (LOCK) -->
    <div id="login-screen" class="fixed inset-0 bg-blue-700 z-[300] flex flex-col items-center justify-center text-white transition-opacity duration-500">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-gray-800 transform transition-all scale-100" id="login-box">
            <div class="text-center mb-6">
                <div class="bg-blue-50 p-3 rounded-full inline-block mb-3 shadow-inner">
                    <img src="https://i.ibb.co.com/rRk3kXpr/LOGO-KABUPATEN-KEBUMEN.png" alt="Logo Kabupaten Kebumen" class="h-14 mx-auto object-contain" style="mix-blend-mode: multiply;">
                </div>
                <h2 class="text-2xl font-bold text-blue-800 leading-tight">E-Ronda</h2>
                <p class="text-sm text-gray-500 mt-1">Sistem Keamanan & Kas Warga</p>
            </div>
            
            <div id="login-error" class="bg-red-50 text-red-600 text-xs text-center p-2 rounded mb-4 hidden border border-red-200 font-bold">
                Kredensial yang Anda masukkan salah!
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kode Lingkungan / RT</label>
                <input type="text" id="input-kode-rt" class="w-full border-2 border-gray-300 rounded-lg p-3 text-center text-lg font-bold tracking-widest focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none mb-4 uppercase transition" placeholder="Cth: KBN01" onkeypress="if(event.key === 'Enter') document.getElementById('input-pin').focus()">
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">PIN Akses Warga / Admin</label>
                <input type="password" id="input-pin" class="w-full border-2 border-gray-300 rounded-lg p-3 text-center text-2xl tracking-[0.5em] focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none mb-6 font-mono transition" placeholder="••••" onkeypress="if(event.key === 'Enter') prosesLogin()">
            </div>
            
            <button onclick="prosesLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-md flex items-center justify-center">
                <i class="fa-solid fa-lock-open mr-2"></i> Buka Aplikasi
            </button>
            
            <div class="mt-6 pt-4 border-t border-gray-100 text-[10px] text-center text-gray-400">
                <i class="fa-solid fa-shield-halved mr-1"></i> Data dienkripsi dan diisolasi per lingkungan RT. Hubungi Pengurus untuk meminta Kode Lingkungan dan PIN Anda.
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER (Tersembunyi sebelum login) -->
    <div id="app-container" class="hidden">
        
        <!-- LOADING INDICATOR -->
        <div id="loading-overlay" class="fixed inset-0 bg-gray-100/80 z-40 flex justify-center items-center rounded-lg backdrop-blur-sm transition-opacity duration-500 pointer-events-none opacity-0">
            <div class="text-center">
                <i class="fa-solid fa-circle-notch fa-spin text-blue-600 text-4xl mb-3"></i>
                <p class="text-blue-800 font-bold animate-pulse">Menghubungkan ke Database Cloud...</p>
            </div>
        </div>

        <!-- Navbar -->
        <nav class="bg-blue-600 text-white shadow-md relative z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Header Title dengan Logo Baru -->
                    <div class="flex items-center">
                        <div class="bg-white p-1 rounded-full mr-3 shadow-md h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center shrink-0">
                            <img src="https://i.ibb.co.com/rRk3kXpr/LOGO-KABUPATEN-KEBUMEN.png" alt="Logo Kabupaten Kebumen" class="max-h-full max-w-full object-contain" style="mix-blend-mode: multiply;">
                        </div>
                        <div class="flex flex-col">
                            <span class="font-bold text-lg md:text-xl tracking-tight leading-tight">E-Ronda RT001/RW005</span>
                            <span class="text-xs font-normal leading-tight text-blue-100 hidden md:block mt-0.5">
                                <i class="fa-solid fa-map-location-dot mr-1"></i> Dk.KebonAgung, Jatinegara, Sempor, Kebumen
                            </span>
                        </div>
                    </div>
                    
                    <!-- Role Indicator & Logout -->
                    <div class="flex items-center space-x-3">
                        <div class="hidden sm:flex flex-col items-end mr-2">
                            <span class="text-[10px] text-blue-200 uppercase font-bold tracking-wider">Status Akses</span>
                            <span id="nav-role-badge" class="bg-blue-800 text-white text-xs font-bold px-2 py-0.5 rounded shadow-inner">Admin</span>
                        </div>
                        <button onclick="logoutAplikasi()" class="bg-red-500 hover:bg-red-600 text-white p-2 sm:px-4 sm:py-2 rounded-lg text-sm font-bold shadow-md transition flex items-center">
                            <i class="fa-solid fa-power-off sm:mr-2"></i> <span class="hidden sm:inline">Keluar</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Menu Tabs -->
        <div class="bg-white shadow mb-6 relative z-0">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8 overflow-x-auto hide-scroll" id="nav-tabs">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                        <i class="fa-solid fa-chart-line mr-1"></i> Dashboard
                    </button>
                    <button onclick="switchTab('presensi')" id="tab-presensi" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                        <i class="fa-solid fa-clipboard-user mr-1"></i> Presensi Ronda
                    </button>
                    <button onclick="switchTab('keuangan')" id="tab-keuangan" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                        <i class="fa-solid fa-wallet mr-1"></i> Tagihan & Denda
                    </button>
                    <button onclick="switchTab('kas-lainnya')" id="tab-kas-lainnya" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                        <i class="fa-solid fa-money-bill-transfer mr-1"></i> Kas Lainnya
                    </button>
                    <button onclick="switchTab('realisasi')" id="tab-realisasi" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                        <i class="fa-solid fa-camera-retro mr-1"></i> Realisasi Anggaran
                    </button>
                    <button onclick="switchTab('aspirasi')" id="tab-aspirasi" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                        <i class="fa-solid fa-bullhorn mr-1"></i> Aspirasi & Rencana
                    </button>
                    <button onclick="switchTab('warga')" id="tab-warga" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                        <i class="fa-solid fa-users mr-1"></i> Jadwal & Warga
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content (Milik App Container) -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">

            <!-- DASHBOARD -->
            <div id="page-dashboard" class="page-content active">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Transparansi Dashboard</h2>
                    <span id="badge-role" class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded border border-blue-400">Mode Admin</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <!-- Card Saldo Kas -->
                    <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500 cursor-pointer hover:shadow-lg hover:border-green-600 transition relative overflow-hidden group" onclick="bukaModalMutasi()">
                        <div class="absolute inset-0 bg-green-50 opacity-0 group-hover:opacity-100 transition"></div>
                        <div class="relative flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100 text-green-500 mr-4 group-hover:scale-110 transition">
                                    <i class="fa-solid fa-money-bill-wave text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 font-semibold uppercase">Total Kas Terkumpul</p>
                                    <p class="text-2xl font-bold text-gray-800" id="dash-kas">Rp 0</p>
                                </div>
                            </div>
                            <div class="text-green-500 opacity-30 group-hover:opacity-100 transition">
                                <i class="fa-solid fa-chevron-right text-xl"></i>
                            </div>
                        </div>
                        <div class="relative mt-3 text-xs text-green-700 font-medium opacity-0 group-hover:opacity-100 transition">
                            <i class="fa-solid fa-hand-pointer mr-1"></i> Klik untuk riwayat mutasi
                        </div>
                    </div>
                    <!-- Card Piutang Denda -->
                    <div class="bg-white rounded-lg shadow p-6 border-l-4 border-red-500">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-red-100 text-red-500 mr-4">
                                <i class="fa-solid fa-file-invoice-dollar text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 font-semibold uppercase">Denda Belum Dibayar</p>
                                <p class="text-2xl font-bold text-gray-800" id="dash-piutang">Rp 0</p>
                            </div>
                        </div>
                    </div>
                    <!-- Card Total Warga -->
                    <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-500 mr-4">
                                <i class="fa-solid fa-users-viewfinder text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 font-semibold uppercase">Total Warga Aktif</p>
                                <p class="text-2xl font-bold text-gray-800" id="dash-warga">0 Orang</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white shadow rounded-lg p-6 border-t-4 border-blue-600">
                    <h3 class="text-lg font-semibold mb-3"><i class="fa-solid fa-circle-info text-blue-500 mr-2"></i>Informasi & Aturan</h3>
                    <ul class="list-disc list-inside text-gray-600 space-y-1">
                        <li>Sistem ini terhubung ke <b>Database Cloud</b>. Perubahan tersimpan secara real-time.</li>
                        <li>Warga wajib mengikuti jadwal ronda. Jika berhalangan/absen akan dikenakan denda kedisiplinan.</li>
                        <li>Besaran tarif denda bervariasi tergantung status warga yang sudah disepakati.</li>
                        <li>Uang hasil denda 100% masuk ke Kas RT. Pengeluaran serta bukti foto realisasinya transparan.</li>
                    </ul>
                </div>
            </div>

            <!-- PRESENSI RONDA (Hanya Admin) -->
            <div id="page-presensi" class="page-content">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0"><i class="fa-solid fa-triangle-exclamation text-yellow-400"></i></div>
                        <div class="ml-3"><p class="text-sm text-yellow-700">Halaman ini hanya dapat diakses oleh Admin/Pengurus untuk mendata kehadiran.</p></div>
                    </div>
                </div>
                <h2 class="text-2xl font-bold mb-4">Catat Presensi Ronda</h2>
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Tanggal</label>
                            <input type="date" id="input-tanggal-presensi" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500" onchange="loadPresensi()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jadwal Regu Hari</label>
                            <input type="text" id="input-hari-presensi" class="w-full border-gray-300 bg-gray-100 rounded-md shadow-sm border p-2 font-bold text-blue-800" readonly>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Warga</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status/Tipe</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi Presensi</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-presensi" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                    <div id="pesan-kosong-presensi" class="p-6 text-center text-gray-500 hidden">
                        Pilih tanggal untuk melihat jadwal warga. Jika tidak ada, berarti tidak ada jadwal ronda di hari tersebut.
                    </div>
                </div>
            </div>

            <!-- KAS & DENDA (Tagihan & Denda) -->
            <div id="page-keuangan" class="page-content">
                <h2 class="text-2xl font-bold mb-4">Tagihan & Denda</h2>
                
                <div class="bg-white shadow rounded-lg overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Daftar Tagihan & Riwayat Denda</h3>
                    </div>
                    <div class="p-4 bg-gray-50">
                        <div id="container-denda" class="flex flex-col gap-3"></div>
                    </div>
                </div>
            </div>

            <!-- KAS LAINNYA (Pemasukan & Pengeluaran Lainnya) -->
            <div id="page-kas-lainnya" class="page-content">
                <h2 class="text-2xl font-bold mb-4">Pemasukan & Pengeluaran Lainnya</h2>
                
                <!-- Form Catat Kas Lainnya (Hanya Admin) -->
                <div id="form-kas-lainnya" class="bg-white shadow rounded-lg p-6 mb-6 border-t-4 border-green-500 hidden">
                    <h3 class="text-lg font-semibold mb-4 text-green-800"><i class="fa-solid fa-money-bill-transfer mr-2"></i>Catat Pemasukan / Pengeluaran Manual</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Transaksi</label>
                            <select id="input-kas-jenis" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-green-500 focus:border-green-500">
                                <option value="Pemasukan">Pemasukan (+)</option>
                                <option value="Pengeluaran">Pengeluaran (-)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="input-kas-tgl" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nominal (Rp)</label>
                            <input type="text" id="input-kas-nominal" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-green-500 focus:border-green-500" placeholder="0" oninput="formatInputRupiah(this)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan Detail</label>
                            <input type="text" id="input-kas-ket" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-green-500 focus:border-green-500" placeholder="Cth: Donasi, Beli Kopi...">
                        </div>
                    </div>
                    <div class="mt-4 text-right">
                        <button onclick="simpanKasLainnya()" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700 transition shadow font-semibold">
                            <i class="fa-solid fa-save mr-1"></i> Simpan Transaksi
                        </button>
                    </div>
                </div>

                <!-- List Baris Ringkas -->
                <div class="bg-white shadow rounded-lg overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Riwayat Pemasukan & Pengeluaran Lainnya</h3>
                    </div>
                    <div class="p-4 bg-gray-50">
                        <div id="container-kas-lainnya" class="flex flex-col gap-3"></div>
                    </div>
                </div>
            </div>

            <!-- REALISASI ANGGARAN (PENGELUARAN & BUKTI) -->
            <div id="page-realisasi" class="page-content">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <div>
                        <h2 class="text-2xl font-bold">Realisasi Anggaran</h2>
                        <p class="text-sm text-gray-600">Laporan transparan penggunaan uang kas RT.</p>
                    </div>
                    <button id="btn-tambah-realisasi" onclick="bukaModalPengeluaran()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition shadow text-sm font-semibold whitespace-nowrap hidden">
                        <i class="fa-solid fa-plus mr-1"></i> Catat Pengeluaran
                    </button>
                </div>

                <!-- Grid Kontainer untuk Card Pengeluaran -->
                <div id="container-realisasi" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Konten digenerate via Javascript -->
                </div>
            </div>

            <!-- ASPIRASI & RENCANA PEMBANGUNAN -->
            <div id="page-aspirasi" class="page-content">
                <!-- Rencana Pembangunan -->
                <div class="mb-10">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Rencana Pembangunan RT01</h2>
                            <p class="text-sm text-gray-600">Program kerja dan rencana pengurus RT ke depan.</p>
                        </div>
                        <button id="btn-tambah-rencana" onclick="bukaModalRencana()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition shadow text-sm font-semibold whitespace-nowrap hidden">
                            <i class="fa-solid fa-plus mr-1"></i> Tambah Rencana
                        </button>
                    </div>
                    <div id="container-rencana" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <!-- Aspirasi Warga -->
                <div class="border-t border-gray-200 pt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Suara & Aspirasi Warga</h2>
                    <p class="text-sm text-gray-600 mb-4">Sampaikan kritik, saran, atau ide Anda untuk lingkungan kita di sini.</p>
                    
                    <!-- Form Tambah Aspirasi -->
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                            <div>
                                <input type="text" id="form-aspirasi-nama" placeholder="Nama Anda (Boleh Anonim/Dikosongkan)" class="w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 text-sm">
                            </div>
                        </div>
                        <textarea id="form-aspirasi-teks" placeholder="Tuliskan aspirasi, usulan, atau kritik membangun..." class="w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 text-sm mb-3" rows="3"></textarea>
                        <div class="text-right">
                            <button onclick="simpanAspirasi()" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700 transition shadow-sm text-sm font-bold">
                                <i class="fa-solid fa-paper-plane mr-1"></i> Kirim Aspirasi
                            </button>
                        </div>
                    </div>

                    <!-- List Aspirasi -->
                    <div id="container-aspirasi" class="space-y-4"></div>
                </div>
            </div>

            <!-- DATA WARGA (Admin + Warga) - COLLAPSIBLE -->
            <div id="page-warga" class="page-content">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                    <h2 class="text-2xl font-bold">Daftar Jadwal Regu & Warga</h2>
                    <div class="flex space-x-2 w-full md:w-auto">
                        <button id="btn-kelola-tipe" onclick="bukaModalTipe()" class="flex-1 md:flex-none bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 transition text-sm font-semibold shadow-sm">
                            <i class="fa-solid fa-tags mr-1"></i> Tipe & Denda
                        </button>
                        <button id="btn-tambah-warga" onclick="bukaModalWarga()" class="flex-1 md:flex-none bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 transition text-sm font-semibold shadow-sm">
                            <i class="fa-solid fa-user-plus mr-1"></i> Tambah Warga
                        </button>
                    </div>
                </div>
                <!-- Grid 2 Kolom -->
                <div id="container-warga" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-8"></div>
            </div>

        </main>
    </div> <!-- END APP CONTAINER -->

    <!-- Modal Tambah/Edit Warga -->
    <div id="modal-warga" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden">
            <div class="px-6 py-4 border-b bg-gray-50">
                <h3 id="modal-warga-title" class="text-lg font-bold text-gray-800">Tambah Warga Baru</h3>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="form-id-warga">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="form-nama" class="w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status / Tipe Warga</label>
                    <select id="form-tipe" class="w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500"></select>
                    <p class="text-xs text-gray-500 mt-1">*Tambahkan tipe di menu 'Tipe & Denda'.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jadwal Ronda</label>
                    <select id="form-jadwal" class="w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500">
                        <option value="Senin">Senin</option><option value="Selasa">Selasa</option><option value="Rabu">Rabu</option>
                        <option value="Kamis">Kamis</option><option value="Jumat">Jumat</option><option value="Sabtu">Sabtu</option><option value="Minggu">Minggu</option>
                    </select>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3 border-t">
                <button onclick="tutupModalWarga()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 font-medium">Batal</button>
                <button onclick="simpanWarga()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium">Simpan Data</button>
            </div>
        </div>
    </div>

    <!-- Modal Kelola Tipe & Tarif Denda -->
    <div id="modal-tipe" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b bg-purple-50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-purple-900"><i class="fa-solid fa-tags mr-2"></i>Pengaturan Tipe & Tarif Denda</h3>
                <button onclick="tutupModalTipe()" class="text-gray-500 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                    <h4 class="text-sm font-bold text-gray-700 mb-3">Tambah Tipe Baru</h4>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="input-nama-tipe" placeholder="Nama Tipe" class="flex-1 border border-gray-300 rounded-md p-2 text-sm">
                        <input type="text" id="input-nominal-tipe" placeholder="Denda (Rp)" class="w-full sm:w-32 border border-gray-300 rounded-md p-2 text-sm" oninput="formatInputRupiah(this)">
                        <button onclick="tambahTipe()" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 text-sm font-bold"><i class="fa-solid fa-plus"></i> Tambah</button>
                    </div>
                </div>
                <table class="min-w-full divide-y divide-gray-200 border rounded-lg overflow-hidden shadow-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-bold text-gray-600 uppercase">Nama Tipe</th>
                            <th class="px-4 py-2 text-left text-xs font-bold text-gray-600 uppercase">Denda</th>
                            <th class="px-4 py-2 text-center text-xs font-bold text-gray-600 uppercase">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabel-tipe-denda" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Mutasi Kas (Histori Singkat Dashboard) -->
    <div id="modal-mutasi" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-green-50 rounded-t-lg">
                <h3 class="text-lg font-bold text-green-900"><i class="fa-solid fa-book-open text-green-600 mr-2"></i>Riwayat Singkat Kas RT</h3>
                <button onclick="tutupModalMutasi()" class="text-gray-500 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-sm text-gray-600">Saldo Kas Saat Ini: <br> <span class="font-bold text-2xl text-green-600" id="mutasi-total-kas">Rp 0</span></p>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Tanggal</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Jenis</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Keterangan</th>
                                <th class="px-4 py-3 text-right text-xs font-bold text-gray-600 uppercase">Nominal</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-mutasi" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Form Catat Pengeluaran & Upload Foto -->
    <div id="modal-pengeluaran" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg border-t-4 border-red-500 max-h-[95vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4 text-red-700" id="modal-pengeluaran-title"><i class="fa-solid fa-money-check-dollar mr-2"></i>Catat Realisasi Pengeluaran</h3>
            <div class="space-y-4">
                <input type="hidden" id="form-pengeluaran-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                    <input type="date" id="form-pengeluaran-tgl" class="w-full border border-gray-300 rounded-md p-2 focus:ring-red-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nominal (Rp)</label>
                    <input type="text" id="form-pengeluaran-nominal" class="w-full border border-gray-300 rounded-md p-2 focus:ring-red-500" placeholder="50.000" oninput="formatInputRupiah(this)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Keperluan / Keterangan</label>
                    <textarea id="form-pengeluaran-ket" class="w-full border border-gray-300 rounded-md p-2 focus:ring-red-500" rows="2" placeholder="Contoh: Beli kopi, servis lampu jalan..."></textarea>
                </div>
                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-1"><i class="fa-solid fa-camera mr-1"></i> Upload Bukti Foto (Bisa ditambah lebih dari 1)</label>
                    <input type="file" id="form-pengeluaran-bukti" multiple accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100 cursor-pointer" onchange="previewBukti(this)">
                    <p class="text-[11px] text-gray-500 mt-1 italic">*Gambar otomatis dikompresi Firebase (Max 1MB). Tambah gambar berulang kali diperbolehkan.</p>
                    
                    <div class="flex justify-between items-center mt-3">
                        <span class="text-xs font-semibold text-gray-600">Preview Foto:</span>
                        <button type="button" onclick="clearBukti()" class="text-[10px] text-red-500 hover:text-red-700 bg-red-50 px-2 py-1 rounded border border-red-200 hidden shadow-sm" id="btn-clear-bukti"><i class="fa-solid fa-trash mr-1"></i> Hapus Semua</button>
                    </div>
                    <div id="preview-bukti-container" class="mt-2 flex flex-wrap gap-2 hide-scroll pb-1"></div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="tutupModalPengeluaran()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 font-medium">Batal</button>
                <button id="btn-simpan-pengeluaran" onclick="simpanPengeluaran()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 font-medium shadow-md flex items-center">
                    Simpan Laporan
                </button>
            </div>
        </div>
    </div>

    <!-- Lightbox Modal untuk Zoom Gambar -->
    <div id="modal-lightbox" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[100] p-4 transition-opacity cursor-zoom-out" onclick="tutupLightbox()">
        <img id="lightbox-img" src="" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl cursor-default" onclick="event.stopPropagation()">
        <button onclick="tutupLightbox()" class="absolute top-5 right-5 text-white hover:text-gray-300 text-4xl cursor-pointer"><i class="fa-solid fa-times"></i></button>
    </div>

    <!-- Modal Rencana Pembangunan -->
    <div id="modal-rencana" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md border-t-4 border-blue-500">
            <h3 class="text-lg font-bold mb-4 text-blue-800" id="modal-rencana-title"><i class="fa-solid fa-clipboard-list mr-2"></i>Form Rencana Pembangunan</h3>
            <div class="space-y-4">
                <input type="hidden" id="form-rencana-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Judul / Nama Program</label>
                    <input type="text" id="form-rencana-judul" class="w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 text-sm" placeholder="Contoh: Perbaikan Pos Kamling">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status Pengerjaan</label>
                    <select id="form-rencana-status" class="w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 text-sm">
                        <option value="Direncanakan">Direncanakan</option>
                        <option value="Sedang Berjalan">Sedang Berjalan</option>
                        <option value="Selesai">Selesai</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Detail</label>
                    <textarea id="form-rencana-deskripsi" class="w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 text-sm" rows="3" placeholder="Jelaskan detail rencana pembangunan..."></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="tutupModalRencana()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 text-sm font-medium">Batal</button>
                <button onclick="simpanRencana()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium shadow-md">Simpan Rencana</button>
            </div>
        </div>
    </div>

    <!-- Modal Tanggapan Aspirasi (Admin) -->
    <div id="modal-tanggapan" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md border-t-4 border-green-500">
            <h3 class="text-lg font-bold mb-4 text-green-800"><i class="fa-solid fa-reply mr-2"></i>Beri Tanggapan RT</h3>
            <div class="space-y-4">
                <input type="hidden" id="form-tanggapan-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Komentar / Jawaban Admin</label>
                    <textarea id="form-tanggapan-teks" class="w-full border border-gray-300 rounded-md p-2 focus:ring-green-500 text-sm" rows="4" placeholder="Tuliskan tanggapan pengurus RT..."></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="tutupModalTanggapan()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 text-sm font-medium">Batal</button>
                <button onclick="simpanTanggapan()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm font-medium shadow-md">Kirim Tanggapan</button>
            </div>
        </div>
    </div>

    <!-- Modal Edit Kas Lainnya -->
    <div id="modal-edit-kas" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-[70] p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md border-t-4 border-yellow-500">
            <div class="px-6 py-4 border-b bg-yellow-50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-yellow-900"><i class="fa-solid fa-pen-to-square mr-2"></i>Edit Transaksi Kas</h3>
                <button onclick="tutupModalEditKas()" class="text-gray-500 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-kas-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Transaksi</label>
                    <select id="edit-kas-jenis" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-yellow-500 text-sm">
                        <option value="Pemasukan">Pemasukan (+)</option>
                        <option value="Pengeluaran">Pengeluaran (-)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                    <input type="date" id="edit-kas-tgl" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-yellow-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nominal (Rp)</label>
                    <input type="text" id="edit-kas-nominal" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-yellow-500 text-sm" oninput="formatInputRupiah(this)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan Detail</label>
                    <input type="text" id="edit-kas-ket" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-yellow-500 text-sm">
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-between space-x-3 border-t">
                <button id="btn-hapus-kas-modal" class="bg-red-100 text-red-600 px-4 py-2 rounded-md hover:bg-red-200 text-sm font-bold transition shadow-sm" title="Hapus Transaksi"><i class="fa-solid fa-trash"></i></button>
                <div class="flex space-x-2">
                    <button onclick="tutupModalEditKas()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 text-sm font-medium">Batal</button>
                    <button onclick="simpanEditKas()" class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 text-sm font-medium shadow-md">Simpan Perubahan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modal -->
    <div id="custom-dialog" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-[200] p-4 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-100 transition-transform">
            <div class="p-6 text-center">
                <div id="dialog-icon" class="mb-4 text-5xl"></div>
                <h3 id="dialog-title" class="text-xl font-bold text-gray-800 mb-2">Konfirmasi</h3>
                <p id="dialog-message" class="text-sm text-gray-600 mb-6 leading-relaxed"></p>
                <div class="flex justify-center space-x-3">
                    <button id="btn-dialog-cancel" class="bg-gray-100 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-200 font-bold transition shadow-sm hidden">Batal</button>
                    <button id="btn-dialog-ok" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 font-bold transition shadow-sm">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Sukses (Toast) -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded shadow-xl transition-opacity duration-300 opacity-0 pointer-events-none z-[400] border-l-4 border-green-500 flex items-center font-medium">
        <i class="fa-solid fa-circle-check text-green-400 mr-3 text-lg"></i> <span id="toast-msg">Berhasil!</span>
    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script>
        // --- KONFIGURASI KEAMANAN (Ubah Ini Sebelum Dibagikan!) ---
        // SECRET_KODE_RT: Digunakan untuk memisahkan data antar RT di database.
        const SECRET_KODE_RT = 'KBN01'; 
        const PIN_WARGA = '12345'; // PIN untuk sekadar melihat data
        const PIN_ADMIN = '987654'; // PIN khusus pengurus RT

        // --- SISTEM LOGIN ---
        function prosesLogin() {
            const inputKode = document.getElementById('input-kode-rt').value.trim().toUpperCase();
            const inputPin = document.getElementById('input-pin').value;
            
            if (inputKode !== SECRET_KODE_RT) {
                tampilkanError('Kode Lingkungan tidak valid/tidak ditemukan!');
                return;
            }

            if (inputPin === PIN_ADMIN) {
                userRole = 'admin';
                masukAplikasi(inputKode);
            } else if (inputPin === PIN_WARGA) {
                userRole = 'warga';
                masukAplikasi(inputKode);
            } else {
                tampilkanError('PIN yang Anda masukkan salah!');
            }
        }

        function tampilkanError(msg) {
            const errorBox = document.getElementById('login-error');
            errorBox.innerText = msg;
            errorBox.classList.remove('hidden');
            document.getElementById('input-pin').value = '';
            document.getElementById('login-box').classList.add('animate-bounce');
            setTimeout(() => document.getElementById('login-box').classList.remove('animate-bounce'), 500);
        }

        function masukAplikasi(kodeRT) {
            sessionStorage.setItem('ronda_logged_in', 'true');
            sessionStorage.setItem('ronda_role', userRole);
            sessionStorage.setItem('ronda_kode_rt', kodeRT); // Simpan nama ruangan database
            
            // Sembunyikan layar login dan tampilkan aplikasi
            document.getElementById('login-screen').classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                
                document.getElementById('loading-overlay').classList.remove('opacity-0', 'pointer-events-none');
                
                initFirebase().then(() => {
                    terapkanRoleUI();
                });
            }, 500);
        }

        function logoutAplikasi() {
            showDialog('confirm', 'Keluar Aplikasi', 'Anda yakin ingin mengunci kembali aplikasi?', () => {
                sessionStorage.removeItem('ronda_logged_in');
                sessionStorage.removeItem('ronda_role');
                window.location.reload(); // Muat ulang halaman untuk membersihkan memori dan state
            });
        }

        function cekSesi() {
            const isLoggedIn = sessionStorage.getItem('ronda_logged_in');
            const savedKodeRT = sessionStorage.getItem('ronda_kode_rt');
            
            // Verifikasi sesi memastikan bahwa Kode RT sudah pernah terekam
            if (isLoggedIn === 'true' && savedKodeRT) {
                userRole = sessionStorage.getItem('ronda_role') || 'warga';
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                
                initFirebase().then(() => {
                    terapkanRoleUI();
                });
            } else {
                 sessionStorage.clear(); // Bersihkan sesi rusak jika ada
            }
        }

        // --- CUSTOM DIALOG & UI HELPERS ---
        function showDialog(type, title, message, onConfirm) {
            const dialog = document.getElementById('custom-dialog');
            const icon = document.getElementById('dialog-icon');
            const btnCancel = document.getElementById('btn-dialog-cancel');
            const btnOk = document.getElementById('btn-dialog-ok');
            
            document.getElementById('dialog-title').innerText = title;
            document.getElementById('dialog-message').innerText = message;

            const newBtnOk = btnOk.cloneNode(true);
            const newBtnCancel = btnCancel.cloneNode(true);
            btnOk.parentNode.replaceChild(newBtnOk, btnOk);
            btnCancel.parentNode.replaceChild(newBtnCancel, btnCancel);

            if (type === 'alert') {
                icon.innerHTML = '<i class="fa-solid fa-circle-exclamation text-yellow-500"></i>';
                newBtnCancel.classList.add('hidden');
                newBtnOk.className = "bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold shadow-sm";
                newBtnOk.innerText = "Mengerti";
                newBtnOk.onclick = () => { dialog.classList.add('hidden'); if(onConfirm) onConfirm(); };
            } else if (type === 'confirm') {
                icon.innerHTML = '<i class="fa-solid fa-circle-question text-blue-500"></i>';
                newBtnCancel.classList.remove('hidden');
                newBtnOk.className = "bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-bold shadow-sm";
                newBtnOk.innerText = "Ya, Lanjutkan";
                newBtnCancel.onclick = () => { dialog.classList.add('hidden'); };
                newBtnOk.onclick = () => { dialog.classList.add('hidden'); if(onConfirm) onConfirm(); };
            }

            dialog.classList.remove('hidden');
        }

        function formatInputRupiah(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value) {
                input.value = parseInt(value, 10).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            } else {
                input.value = '';
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-10');
            setTimeout(() => toast.classList.add('opacity-0', 'pointer-events-none', 'translate-y-10'), 3000);
        }

        // --- GLOBAL STATE ---
        let userRole = 'admin'; 
        const namaHari = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        
        let pengaturanDenda = [];
        let dataWarga = [];
        let dataDenda = [];
        let dataMutasi = [];
        let dataPresensi = {};
        let dataRencana = [];
        let dataAspirasi = [];
        let tempBuktiBase64 = []; 

        function getNominalDenda(tipeText) {
            const p = pengaturanDenda.find(x => x.tipe === tipeText);
            return p ? p.nominal : 0; 
        }

        function hitungTotalKas() {
            return dataMutasi.reduce((total, m) => m.jenis === 'Pemasukan' ? total + m.nominal : total - m.nominal, 0);
        }

        const formatRp = (angka) => {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
        };

        // --- FIREBASE SETUP ---
        let db, collection, doc, setDoc, deleteDoc, onSnapshot;
        let currentUser = null;

        // DYNAMIC HELPER: Membuat Path Database Terisolasi berdasarkan Kode RT
        // Contoh: Jika kode RT "KBN01", tabel warga akan bernama "KBN01_warga"
        const getColl = (name) => {
            const prefix = sessionStorage.getItem('ronda_kode_rt') || 'DEFAULT';
            return collection(db, `${prefix}_${name}`);
        };

        async function initFirebase() {
            try {
                // Dynamic Import Library Firebase
                const appModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const authModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const firestoreModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                
                db = firestoreModule.getFirestore;
                collection = firestoreModule.collection;
                doc = firestoreModule.doc;
                setDoc = firestoreModule.setDoc;
                deleteDoc = firestoreModule.deleteDoc;
                onSnapshot = firestoreModule.onSnapshot;

                // Paste konfigurasi dari Langkah 2 di sini
                const firebaseConfig = {
                    apiKey: "AIzaSyAmQN1gOPKs6Up2rxLK0d94t1_9f3flRAw",
                    authDomain: "e-ronda-kebonagung.firebaseapp.com",
                    projectId: "e-ronda-kebonagung",
                    storageBucket: "e-ronda-kebonagung.firebasestorage.app",
                    messagingSenderId: "892632721018",
                    appId: "1:892632721018:web:f412f57a7de8f010d9bdc3"
                };

                const app = appModule.initializeApp(firebaseConfig);
                const auth = authModule.getAuth(app);
                db = firestoreModule.getFirestore(app);

                // Cukup gunakan signInAnonymously
                await authModule.signInAnonymously(auth);

                // Kembalikan Promise yang terselesaikan ketika auth state berubah menjadi log in
                return new Promise((resolve) => {
                    authModule.onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUser = user;
                            setupRealtimeListeners();
                            const loadingOverlay = document.getElementById('loading-overlay');
                            if(loadingOverlay) {
                                loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
                            }
                            resolve(); // Selesaikan inisialisasi
                        }
                    });
                });
                
            } catch(e) {
                console.error("Firebase init error:", e);
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                     loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
                }
                showDialog('alert', 'Error Server', 'Gagal terhubung ke Database Cloud. Periksa koneksi internet Anda.');
                return Promise.reject(e); // Tolak inisialisasi jika ada error
            }
        }

        // --- REAL-TIME DATA SYNC ---
        function setupRealtimeListeners() {
            if (!currentUser) return;

            // Warga
            onSnapshot(getColl('warga'), (snap) => {
                if(snap.empty && dataWarga.length === 0) {
                    // Seed (Pancing) Data Default jika database kosong (Baru pertama kali run)
                    const baseWarga = [
                        { id: 1, nama: 'Eko hadi', tipe: 'Reguler', jadwal: 'Senin' }, { id: 2, nama: 'Nanang', tipe: 'Reguler', jadwal: 'Senin' },
                        { id: 8, nama: 'Dodo', tipe: 'Reguler', jadwal: 'Selasa' }, { id: 13, nama: 'Suminem', tipe: 'Janda', jadwal: 'Selasa' },
                        { id: 15, nama: 'Samirin', tipe: 'Reguler', jadwal: 'Rabu' }, { id: 22, nama: 'Sadimin', tipe: 'Reguler', jadwal: 'Kamis' },
                        { id: 29, nama: 'Sidik', tipe: 'Reguler', jadwal: 'Jumat' }, { id: 36, nama: 'Kirno', tipe: 'Reguler', jadwal: 'Sabtu' },
                        { id: 43, nama: 'Minarto', tipe: 'Reguler', jadwal: 'Minggu' }
                    ];
                    baseWarga.forEach(w => setDoc(doc(getColl('warga'), w.id.toString()), w));
                } else {
                    dataWarga = snap.docs.map(d => d.data());
                    if(document.getElementById('page-warga') && document.getElementById('page-warga').classList.contains('active')) renderTabelWarga();
                    updateDashboard();
                    if(document.getElementById('page-presensi') && document.getElementById('page-presensi').classList.contains('active')) loadPresensi();
                }
            }, (err) => console.error(err));

            // Pengaturan Denda
            onSnapshot(getColl('pengaturan_denda'), (snap) => {
                if(snap.empty && pengaturanDenda.length === 0) {
                    [{ id: 1, tipe: 'Reguler', nominal: 10000 }, { id: 2, tipe: 'Janda', nominal: 5000 }].forEach(p => {
                        setDoc(doc(getColl('pengaturan_denda'), p.id.toString()), p);
                    });
                } else {
                    pengaturanDenda = snap.docs.map(d => d.data());
                    if(document.getElementById('modal-tipe') && !document.getElementById('modal-tipe').classList.contains('hidden')) renderTabelTipe();
                }
            }, (err) => console.error(err));

            // Denda (Tagihan)
            onSnapshot(getColl('denda'), (snap) => {
                dataDenda = snap.docs.map(d => d.data());
                if(document.getElementById('page-keuangan') && document.getElementById('page-keuangan').classList.contains('active')) renderTabelDenda();
                updateDashboard();
            }, (err) => console.error(err));

            // Mutasi (Kas)
            onSnapshot(getColl('mutasi'), (snap) => {
                dataMutasi = snap.docs.map(d => d.data());
                if(document.getElementById('page-kas-lainnya') && document.getElementById('page-kas-lainnya').classList.contains('active')) renderTabelKasLainnya();
                if(document.getElementById('page-realisasi') && document.getElementById('page-realisasi').classList.contains('active')) renderRealisasi();
                if(document.getElementById('modal-mutasi') && !document.getElementById('modal-mutasi').classList.contains('hidden')) bukaModalMutasi();
                updateDashboard();
            }, (err) => console.error(err));

            // Presensi
            onSnapshot(getColl('presensi'), (snap) => {
                dataPresensi = {};
                snap.docs.forEach(d => { dataPresensi[d.id] = d.data(); });
                if(document.getElementById('page-presensi') && document.getElementById('page-presensi').classList.contains('active')) loadPresensi();
            }, (err) => console.error(err));

            // Rencana
            onSnapshot(getColl('rencana'), (snap) => {
                if(snap.empty && dataRencana.length === 0) {
                    const defaultRencana = [{
                        id: 1, judul: 'Program "Kebonagung Bercahaya" (Penerangan Jalan)', status: 'Direncanakan',
                        deskripsi: 'Sejalan dengan visi Desa Jatinegara untuk mewujudkan lingkungan yang terang dan aman di malam hari...',
                        tanggal: new Date().toLocaleDateString('id-ID')
                    }];
                    defaultRencana.forEach(r => setDoc(doc(getColl('rencana'), r.id.toString()), r));
                } else {
                    dataRencana = snap.docs.map(d => d.data());
                    if(document.getElementById('page-aspirasi') && document.getElementById('page-aspirasi').classList.contains('active')) renderRencana();
                }
            }, (err) => console.error(err));

            // Aspirasi
            onSnapshot(getColl('aspirasi'), (snap) => {
                dataAspirasi = snap.docs.map(d => d.data());
                if(document.getElementById('page-aspirasi') && document.getElementById('page-aspirasi').classList.contains('active')) renderAspirasi();
            }, (err) => console.error(err));
        }

        // --- SISTEM ROLE UI ---
        function terapkanRoleUI() {
            // Cek apakah elemen ada sebelum mencoba mengaksesnya
            const badge = document.getElementById('badge-role');
            const navBadge = document.getElementById('nav-role-badge');
            const formKas = document.getElementById('form-kas-lainnya');
            
            // Mencegah error jika elemen belum dirender
            if(!badge || !navBadge) return; 

            if (userRole === 'warga') {
                if(document.getElementById('tab-presensi')) document.getElementById('tab-presensi').style.display = 'none';
                if(document.getElementById('btn-tambah-warga')) document.getElementById('btn-tambah-warga').style.display = 'none';
                if(document.getElementById('btn-kelola-tipe')) document.getElementById('btn-kelola-tipe').style.display = 'none';
                if(document.getElementById('btn-tambah-realisasi')) document.getElementById('btn-tambah-realisasi').style.display = 'none';
                if(document.getElementById('btn-tambah-rencana')) document.getElementById('btn-tambah-rencana').style.display = 'none';
                if(formKas) formKas.classList.add('hidden');
                
                badge.innerText = "Mode Warga (Hanya Baca)";
                badge.className = "bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded border border-green-400";
                navBadge.innerText = "WARGA";
                navBadge.className = "bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm border border-green-600";
                
                if(document.getElementById('page-presensi') && document.getElementById('page-presensi').classList.contains('active')) switchTab('dashboard');
            } else {
                if(document.getElementById('tab-presensi')) document.getElementById('tab-presensi').style.display = 'inline-block';
                if(document.getElementById('btn-tambah-warga')) document.getElementById('btn-tambah-warga').style.display = 'inline-block';
                if(document.getElementById('btn-kelola-tipe')) document.getElementById('btn-kelola-tipe').style.display = 'inline-block';
                if(document.getElementById('btn-tambah-realisasi')) document.getElementById('btn-tambah-realisasi').style.display = 'inline-block';
                if(document.getElementById('btn-tambah-rencana')) document.getElementById('btn-tambah-rencana').style.display = 'inline-block';
                if(formKas) formKas.classList.remove('hidden');
                
                badge.innerText = "Mode Admin (Akses Penuh)";
                badge.className = "bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded border border-blue-400";
                navBadge.innerText = "ADMIN";
                navBadge.className = "bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm border border-red-600 animate-pulse";
            }
            
            // Panggil render fungsi jika elemen tab-nya aktif
            if(document.getElementById('page-warga') && document.getElementById('page-warga').classList.contains('active')) renderTabelWarga();
            if(document.getElementById('page-keuangan') && document.getElementById('page-keuangan').classList.contains('active')) renderTabelDenda();
            if(document.getElementById('page-kas-lainnya') && document.getElementById('page-kas-lainnya').classList.contains('active')) renderTabelKasLainnya();
            if(document.getElementById('page-realisasi') && document.getElementById('page-realisasi').classList.contains('active')) renderRealisasi();
            if(document.getElementById('page-aspirasi') && document.getElementById('page-aspirasi').classList.contains('active')) { renderRencana(); renderAspirasi(); }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.page-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            const targetPage = document.getElementById(`page-${tabId}`);
            const targetTab = document.getElementById(`tab-${tabId}`);
            
            if(targetPage) targetPage.classList.add('active');
            if(targetTab) targetTab.classList.add('active');

            if(tabId === 'dashboard') updateDashboard();
            if(tabId === 'warga') renderTabelWarga();
            if(tabId === 'keuangan') renderTabelDenda();
            if(tabId === 'kas-lainnya') {
                renderTabelKasLainnya();
                const inputKasTgl = document.getElementById('input-kas-tgl');
                if (inputKasTgl) inputKasTgl.valueAsDate = new Date();
            }
            if(tabId === 'realisasi') renderRealisasi();
            if(tabId === 'aspirasi') { renderRencana(); renderAspirasi(); }
            if(tabId === 'presensi') {
                const inputTglPresensi = document.getElementById('input-tanggal-presensi');
                if(inputTglPresensi && !inputTglPresensi.value) {
                    inputTglPresensi.valueAsDate = new Date();
                }
                loadPresensi();
            }
        }

        function updateDashboard() {
            let piutang = dataDenda.filter(d => d.status === 'Belum Dibayar').reduce((sum, d) => sum + d.nominal, 0);
            const totalKas = hitungTotalKas();
            const dashKas = document.getElementById('dash-kas');
            
            if(dashKas) {
                dashKas.innerText = formatRp(totalKas);
                if(totalKas < 0) { dashKas.classList.remove('text-gray-800'); dashKas.classList.add('text-red-600'); } 
                else { dashKas.classList.remove('text-red-600'); dashKas.classList.add('text-gray-800'); }
            }

            const dashPiutang = document.getElementById('dash-piutang');
            if(dashPiutang) dashPiutang.innerText = formatRp(piutang);
            
            const dashWarga = document.getElementById('dash-warga');
            if(dashWarga) dashWarga.innerText = `${dataWarga.length} Orang`;
        }

        // --- PRESENSI ---
        function loadPresensi() {
            const tglInput = document.getElementById('input-tanggal-presensi');
            if(!tglInput || !tglInput.value) return;
            const dateObj = new Date(tglInput.value);
            const hariIni = namaHari[dateObj.getDay()];
            const hariPresensi = document.getElementById('input-hari-presensi');
            if(hariPresensi) hariPresensi.value = hariIni;
            renderTabelPresensi(hariIni, tglInput.value);
        }

        function renderTabelPresensi(hari, tanggalStr) {
            const tbody = document.getElementById('tabel-presensi');
            const msgKosong = document.getElementById('pesan-kosong-presensi');
            if(!tbody || !msgKosong) return;

            tbody.innerHTML = '';
            const wargaRegu = dataWarga.filter(w => w.jadwal === hari);

            if(wargaRegu.length === 0) {
                tbody.parentNode.classList.add('hidden');
                msgKosong.classList.remove('hidden'); return;
            }

            tbody.parentNode.classList.remove('hidden');
            msgKosong.classList.add('hidden');

            wargaRegu.forEach(w => {
                const status = (dataPresensi[tanggalStr] && dataPresensi[tanggalStr][w.id]) ? dataPresensi[tanggalStr][w.id] : 'Belum';
                let badgeClass = 'bg-gray-100 text-gray-800';
                if(status === 'Hadir') badgeClass = 'bg-green-100 text-green-800 border-green-200 border';
                if(status === 'Absen') badgeClass = 'bg-red-100 text-red-800 border-red-200 border';
                if(status === 'Izin') badgeClass = 'bg-yellow-100 text-yellow-800 border-yellow-200 border';

                tbody.innerHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="font-bold text-gray-800">${w.nama}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-50 text-blue-700">${w.tipe}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <div class="flex items-center justify-center space-x-2">
                                ${status !== 'Belum' ? `<span class="px-3 py-1 text-xs rounded-md ${badgeClass} font-bold mr-2">${status}</span>` : ''}
                                <button onclick="setPresensi('${tanggalStr}', ${w.id}, 'Hadir')" class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition shadow-sm" title="Hadir"><i class="fa-solid fa-check"></i></button>
                                <button onclick="setPresensi('${tanggalStr}', ${w.id}, 'Izin')" class="px-2 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600 transition shadow-sm" title="Izin"><i class="fa-solid fa-envelope"></i></button>
                                <button onclick="setPresensi('${tanggalStr}', ${w.id}, 'Absen')" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition shadow-sm" title="Absen (Denda)"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        function setPresensi(tgl, wargaId, status) {
            if(userRole !== 'admin') return;
            const prevStatus = (dataPresensi[tgl] && dataPresensi[tgl][wargaId]) ? dataPresensi[tgl][wargaId] : 'Belum';
            const warga = dataWarga.find(w => w.id === wargaId);
            
            // Simpan Data Ke Firestore (merge map fields)
            setDoc(doc(getColl('presensi'), tgl), { [wargaId]: status }, { merge: true });
            
            if(status === 'Absen' && prevStatus !== 'Absen') {
                const nominal = getNominalDenda(warga.tipe);
                if(nominal > 0) {
                    const idDenda = Date.now();
                    setDoc(doc(getColl('denda'), idDenda.toString()), {
                        id: idDenda, wargaId: warga.id, namaWarga: warga.nama,
                        tanggal: tgl, nominal: nominal, status: 'Belum Dibayar',
                        keterangan: `Tidak berangkat (${tgl})`
                    });
                }
            } else if (prevStatus === 'Absen' && status !== 'Absen') {
                const denda = dataDenda.find(d => d.wargaId === wargaId && d.tanggal === tgl && d.status === 'Belum Dibayar');
                if(denda) {
                    deleteDoc(doc(getColl('denda'), denda.id.toString()));
                }
            }
            showToast(`${warga.nama} diset: ${status}`);
        }

        // --- WARGA ---
        function renderTabelWarga() {
            const container = document.getElementById('container-warga');
            if(!container) return;
            container.innerHTML = '';
            
            const grouped = {};
            const urutanHari = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
            const todayIndex = new Date().getDay();
            const activeHariIndex = (todayIndex + 1) % 7; 
            const activeScheduleHari = namaHari[activeHariIndex];
            
            urutanHari.forEach(h => grouped[h] = []);
            dataWarga.forEach(w => { if(grouped[w.jadwal]) grouped[w.jadwal].push(w); });

            urutanHari.forEach(hari => {
                if(grouped[hari].length === 0) return;
                let malamSebelumnya = '';
                if(hari === 'Senin') malamSebelumnya = 'Minggu Malam';
                else if(hari === 'Selasa') malamSebelumnya = 'Senin Malam';
                else if(hari === 'Rabu') malamSebelumnya = 'Selasa Malam';
                else if(hari === 'Kamis') malamSebelumnya = 'Rabu Malam';
                else if(hari === 'Jumat') malamSebelumnya = 'Kamis Malam';
                else if(hari === 'Sabtu') malamSebelumnya = 'Jumat Malam';
                else if(hari === 'Minggu') malamSebelumnya = 'Sabtu Malam';

                let listHtml = grouped[hari].map(w => `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100/50 last:border-0">
                        <div><p class="font-bold text-gray-800 text-sm">${w.nama}</p><p class="text-[11px] text-gray-500">${w.tipe}</p></div>
                        ${userRole === 'admin' ? `<button onclick="hapusWarga(${w.id})" class="text-red-500 hover:text-red-700 text-xs px-2 py-1 transition"><i class="fa-solid fa-trash"></i></button>` : ''}
                    </div>
                `).join('');

                const isActive = hari === activeScheduleHari;
                const cardClass = isActive ? "bg-orange-50 rounded-lg shadow-md border-2 border-orange-400 p-4 transition relative overflow-hidden ring-4 ring-orange-100" : "bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition relative";
                const activeBadge = isActive ? `<span class="absolute top-0 right-0 bg-orange-500 text-white text-[10px] font-bold px-3 py-1 rounded-bl-lg animate-pulse shadow-sm"><i class="fa-solid fa-clock mr-1"></i> JADWAL HARI INI</span>` : "";

                container.innerHTML += `
                    <div class="${cardClass}">
                        ${activeBadge}
                        <div class="border-b-2 ${isActive ? 'border-orange-200' : 'border-blue-100'} pb-2 mb-3 mt-2">
                            <h3 class="font-bold ${isActive ? 'text-orange-800' : 'text-blue-800'} flex items-center justify-between">
                                <span><i class="fa-regular fa-calendar-check mr-2"></i>Regu ${hari}</span>
                                <span class="${isActive ? 'bg-orange-200 text-orange-800' : 'bg-blue-50 text-blue-600'} px-2 py-0.5 rounded text-[10px] uppercase font-bold shadow-sm">${grouped[hari].length} orang</span>
                            </h3>
                            <p class="text-xs ${isActive ? 'text-orange-700 bg-orange-100/70' : 'text-blue-700 bg-blue-50/50'} font-medium mt-1.5 p-1 rounded inline-block">
                                <i class="fa-solid fa-moon mr-1"></i> Berjaga pada: ${malamSebelumnya}
                            </p>
                        </div><div>${listHtml}</div>
                    </div>
                `;
            });
        }

        function bukaModalWarga() { 
            const sel = document.getElementById('form-tipe');
            if(sel) sel.innerHTML = pengaturanDenda.map(p => `<option value="${p.tipe}">${p.tipe}</option>`).join('');
            document.getElementById('form-nama').value = '';
            document.getElementById('modal-warga').classList.remove('hidden'); 
        }
        function tutupModalWarga() { document.getElementById('modal-warga').classList.add('hidden'); }
        
        function simpanWarga() {
            const nama = document.getElementById('form-nama').value.trim();
            const tipe = document.getElementById('form-tipe').value;
            const jadwal = document.getElementById('form-jadwal').value;
            if(!nama) return showDialog('alert', 'Perhatian', 'Nama lengkap wajib diisi!');
            
            const id = Date.now();
            setDoc(doc(getColl('warga'), id.toString()), { id, nama, tipe, jadwal }).then(() => {
                tutupModalWarga();
                showToast('Warga baru berhasil ditambahkan.');
            });
        }

        function hapusWarga(id) {
            showDialog('confirm', 'Hapus Warga', 'Anda yakin ingin menghapus warga ini dari sistem?', () => {
                deleteDoc(doc(getColl('warga'), id.toString())).then(() => showToast('Warga berhasil dihapus.'));
            });
        }

        // --- PENGATURAN TIPE ---
        function bukaModalTipe() { document.getElementById('modal-tipe').classList.remove('hidden'); renderTabelTipe(); }
        function tutupModalTipe() { document.getElementById('modal-tipe').classList.add('hidden'); }
        
        function renderTabelTipe() {
            const tbody = document.getElementById('tabel-tipe-denda');
            if(!tbody) return;
            tbody.innerHTML = pengaturanDenda.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-semibold text-gray-800">${p.tipe}</td>
                    <td class="px-4 py-3 text-sm text-red-600 font-bold">${formatRp(p.nominal)}</td>
                    <td class="px-4 py-3 text-center"><button onclick="hapusTipe(${p.id})" class="text-red-500 hover:bg-red-50 rounded px-2 py-1 transition text-xs"><i class="fa-solid fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        function tambahTipe() {
            const nama = document.getElementById('input-nama-tipe').value.trim();
            const nomInput = document.getElementById('input-nominal-tipe').value;
            const nom = parseInt(nomInput ? nomInput.replace(/\./g, '') : "0");
            
            if(nama && nom >= 0) {
                const id = Date.now();
                setDoc(doc(getColl('pengaturan_denda'), id.toString()), { id, tipe: nama, nominal: nom }).then(() => {
                    document.getElementById('input-nama-tipe').value = '';
                    document.getElementById('input-nominal-tipe').value = '';
                    showToast('Tipe warga ditambahkan.');
                });
            } else {
                showDialog('alert', 'Kesalahan Input', 'Nama dan nominal denda tidak valid!');
            }
        }

        function hapusTipe(id) {
            showDialog('confirm', 'Hapus Tipe Denda', 'Hapus tipe denda ini? Pastikan tidak ada warga yang masih menggunakan tipe ini.', () => {
                deleteDoc(doc(getColl('pengaturan_denda'), id.toString()));
            });
        }

        // --- TAGIHAN DENDA ---
        function renderTabelDenda() {
            const container = document.getElementById('container-denda');
            if(!container) return;
            container.innerHTML = '';
            
            const urutDenda = [...dataDenda].sort((a,b) => b.id - a.id);
            if(urutDenda.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 bg-white p-6 rounded-lg border border-gray-200">Belum ada data tagihan denda.</div>`;
                return;
            }

            urutDenda.forEach(d => {
                const isLunas = d.status === 'Lunas';
                const actionAttr = (!isLunas && userRole === 'admin') ? `onclick="bayarDenda(${d.id})"` : '';
                const pointerCls = (!isLunas && userRole === 'admin') ? 'cursor-pointer hover:border-green-400 hover:shadow-md group' : '';
                
                container.innerHTML += `
                    <div class="bg-white rounded-lg shadow-sm border ${isLunas ? 'border-green-200 opacity-70' : 'border-red-200'} p-3 flex items-center justify-between transition ${pointerCls}" ${actionAttr}>
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 shrink-0 rounded-full flex items-center justify-center font-bold text-lg ${isLunas ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600 group-hover:scale-110 transition'}">
                                <i class="fa-solid ${isLunas ? 'fa-check' : 'fa-file-invoice-dollar'}"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm leading-tight">${d.namaWarga}</h4>
                                <p class="text-[11px] text-gray-500 mt-0.5"><i class="fa-solid fa-calendar-day mr-1"></i> ${d.tanggal} &bull; ${d.keterangan}</p>
                            </div>
                        </div>
                        <div class="text-right shrink-0 ml-2 flex flex-col items-end">
                            <p class="font-bold text-sm ${isLunas ? 'text-green-600' : 'text-red-600'}">${formatRp(d.nominal)}</p>
                            ${userRole === 'admin' && !isLunas ? `<span class="text-[10px] bg-green-500 text-white px-2 py-0.5 rounded shadow-sm font-bold mt-1 inline-block group-hover:bg-green-600 transition">Klik Bayar <i class="fa-solid fa-chevron-right ml-1"></i></span>` : `<span class="text-[10px] font-bold uppercase ${isLunas ? 'text-green-500' : 'text-red-500'} mt-1 inline-block">${d.status}</span>`}
                        </div>
                    </div>
                `;
            });
        }

        function bayarDenda(id) {
            const denda = dataDenda.find(d => d.id === id);
            if(denda) {
                showDialog('confirm', 'Konfirmasi Pembayaran', `Proses pembayaran denda dari ${denda.namaWarga} sebesar ${formatRp(denda.nominal)}?`, () => {
                    setDoc(doc(getColl('denda'), denda.id.toString()), { ...denda, status: 'Lunas' });
                    
                    const today = new Date();
                    const formattedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                    const idMutasi = Date.now();
                    setDoc(doc(getColl('mutasi'), idMutasi.toString()), {
                        id: idMutasi, tanggal: formattedDate, jenis: 'Pemasukan',
                        nominal: denda.nominal, kategori: 'Denda',
                        keterangan: `Pembayaran Denda: ${denda.namaWarga} (${denda.tanggal})`
                    }).then(() => showToast('Pembayaran denda lunas & otomatis masuk ke Kas.'));
                });
            }
        }

        // --- REALISASI ANGGARAN ---
        function renderRealisasi() {
            const container = document.getElementById('container-realisasi');
            if(!container) return;
            const pengeluaran = dataMutasi.filter(m => m.jenis === 'Pengeluaran').sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));

            if(pengeluaran.length === 0) {
                container.innerHTML = `<div class="col-span-full py-16 text-center bg-white rounded-lg shadow-sm border border-gray-200"><i class="fa-solid fa-folder-open text-gray-300 text-5xl mb-4"></i><p class="text-gray-500 font-medium">Belum ada catatan realisasi penggunaan dana kas.</p></div>`;
                return;
            }

            container.innerHTML = pengeluaran.map(p => {
                let fotoHtml = '';
                if (p.bukti && p.bukti.length > 0) {
                    let thumbs = p.bukti.map(src => `<img src="${src}" onclick="bukaLightbox('${src}')" class="w-16 h-16 object-cover rounded shadow-sm border border-gray-200 cursor-pointer hover:opacity-80 hover:scale-105 transition transform flex-shrink-0">`).join('');
                    fotoHtml = `<div class="mt-3"><p class="text-[11px] font-bold text-gray-400 uppercase mb-1">Bukti Foto (${p.bukti.length}):</p><div class="flex gap-2 overflow-x-auto hide-scroll pb-2">${thumbs}</div></div>`;
                } else {
                    fotoHtml = `<div class="mt-3 text-xs text-gray-400 italic"><i class="fa-solid fa-image-slash mr-1"></i> Tidak ada foto dilampirkan.</div>`;
                }

                return `
                    <div id="realisasi-${p.id}" class="bg-white rounded-lg shadow-md border border-gray-200 p-5 hover:shadow-lg transition flex flex-col justify-between duration-300">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-red-50 text-red-700 text-xs font-bold px-2 py-1 rounded border border-red-100"><i class="fa-solid fa-calendar-day mr-1"></i> ${p.tanggal}</span>
                                <span class="font-bold text-red-600 text-lg tracking-tight">- ${formatRp(p.nominal)}</span>
                            </div>
                            <p class="text-gray-800 font-medium text-sm leading-snug mt-3 mb-1">${p.keterangan}</p>
                            <div class="border-t border-gray-100 mt-3 pt-1">${fotoHtml}</div>
                        </div>
                        ${userRole === 'admin' ? `
                        <div class="mt-4 pt-3 border-t border-dashed border-gray-200 text-right">
                            <button onclick="editPengeluaran(${p.id})" class="text-xs text-blue-500 hover:bg-blue-50 px-2 py-1 rounded font-medium transition mr-2"><i class="fa-solid fa-pen mr-1"></i> Edit Laporan</button>
                            <button onclick="hapusPengeluaran(${p.id})" class="text-xs text-red-500 hover:bg-red-50 px-2 py-1 rounded font-medium transition"><i class="fa-solid fa-trash mr-1"></i> Hapus Catatan</button>
                        </div>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function processFilesToBase64(files) {
            const promises = Array.from(files).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800; const MAX_HEIGHT = 800;
                            let width = img.width; let height = img.height;
                            if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } 
                            else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            });
            return Promise.all(promises);
        }

        function renderPreviewBukti() {
            const container = document.getElementById('preview-bukti-container');
            const btnClear = document.getElementById('btn-clear-bukti');
            if(!container || !btnClear) return;

            if(tempBuktiBase64.length > 0) {
                container.innerHTML = tempBuktiBase64.map((src, index) => `
                    <div class="relative group mt-1">
                        <img src="${src}" class="w-16 h-16 object-cover rounded border border-gray-300 shadow-sm cursor-pointer" onclick="bukaLightbox('${src}')">
                        <button onclick="hapusSatuBukti(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100 transition shadow"><i class="fa-solid fa-times"></i></button>
                    </div>
                `).join('');
                btnClear.classList.remove('hidden');
            } else {
                container.innerHTML = '<span class="text-xs text-gray-400 italic">Belum ada foto</span>';
                btnClear.classList.add('hidden');
            }
        }

        function hapusSatuBukti(index) { tempBuktiBase64.splice(index, 1); renderPreviewBukti(); }
        function clearBukti() { tempBuktiBase64 = []; document.getElementById('form-pengeluaran-bukti').value = ''; renderPreviewBukti(); }

        async function previewBukti(input) {
            const container = document.getElementById('preview-bukti-container');
            const btnSimpan = document.getElementById('btn-simpan-pengeluaran');
            if(input.files && input.files.length > 0) {
                if(tempBuktiBase64.length === 0) container.innerHTML = '';
                container.insertAdjacentHTML('beforeend', '<span id="loading-img" class="text-xs text-blue-500 font-bold animate-pulse"><i class="fa-solid fa-spinner fa-spin mr-1"></i> Memproses...</span>');
                btnSimpan.disabled = true; btnSimpan.classList.add('opacity-50', 'cursor-not-allowed');

                try {
                    const base64Baru = await processFilesToBase64(input.files);
                    tempBuktiBase64 = tempBuktiBase64.concat(base64Baru);
                    renderPreviewBukti();
                } catch (e) {
                    showDialog('alert', 'Error', 'Gagal memproses gambar.');
                    renderPreviewBukti();
                } finally {
                    btnSimpan.disabled = false; btnSimpan.classList.remove('opacity-50', 'cursor-not-allowed');
                    input.value = '';
                }
            }
        }

        function editPengeluaran(id) {
            const m = dataMutasi.find(x => x.id === id);
            if(m) {
                document.getElementById('form-pengeluaran-id').value = m.id;
                document.getElementById('form-pengeluaran-tgl').value = m.tanggal;
                document.getElementById('form-pengeluaran-nominal').value = m.nominal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                document.getElementById('form-pengeluaran-ket').value = m.keterangan;
                document.getElementById('modal-pengeluaran-title').innerHTML = '<i class="fa-solid fa-pen-to-square mr-2"></i>Edit Laporan Realisasi';
                tempBuktiBase64 = m.bukti ? [...m.bukti] : [];
                renderPreviewBukti();
                document.getElementById('modal-pengeluaran').classList.remove('hidden');
            }
        }

        function bukaModalPengeluaran() {
            document.getElementById('form-pengeluaran-id').value = '';
            document.getElementById('modal-pengeluaran-title').innerHTML = '<i class="fa-solid fa-money-check-dollar mr-2"></i>Catat Realisasi Pengeluaran';
            document.getElementById('modal-pengeluaran').classList.remove('hidden');
            document.getElementById('form-pengeluaran-tgl').valueAsDate = new Date();
            document.getElementById('form-pengeluaran-nominal').value = '';
            document.getElementById('form-pengeluaran-ket').value = '';
            document.getElementById('form-pengeluaran-bukti').value = '';
            tempBuktiBase64 = []; renderPreviewBukti();
        }
        function tutupModalPengeluaran() { document.getElementById('modal-pengeluaran').classList.add('hidden'); }
        
        function simpanPengeluaran() {
            const idForm = document.getElementById('form-pengeluaran-id').value;
            const tgl = document.getElementById('form-pengeluaran-tgl').value;
            const nominalInput = document.getElementById('form-pengeluaran-nominal').value;
            const nominal = parseInt(nominalInput ? nominalInput.replace(/\./g, '') : "0");
            const ket = document.getElementById('form-pengeluaran-ket').value.trim();
            
            if(!tgl || !nominal || isNaN(nominal) || nominal <= 0 || !ket) return showDialog('alert', 'Kesalahan Input', 'Harap isi semua kolom dengan benar!');

            const payload = { tanggal: tgl, jenis: 'Pengeluaran', nominal: nominal, keterangan: ket, bukti: tempBuktiBase64 };
            const docId = idForm ? idForm : Date.now().toString();
            if(!idForm) payload.id = Number(docId);

            setDoc(doc(getColl('mutasi'), docId), payload, { merge: true }).then(() => {
                tutupModalPengeluaran();
                showToast('Laporan pengeluaran berhasil disimpan!');
            });
        }

        function hapusPengeluaran(id) {
            showDialog('confirm', 'Hapus Catatan Laporan', 'Yakin ingin menghapus catatan pengeluaran ini? Saldo kas akan bertambah kembali.', () => {
                deleteDoc(doc(getColl('mutasi'), id.toString())).then(() => showToast('Catatan pengeluaran dihapus.'));
            });
        }

        function bukaLightbox(src) {
            const lightboxImg = document.getElementById('lightbox-img');
            if(lightboxImg) {
                lightboxImg.src = src;
                document.getElementById('modal-lightbox').classList.remove('hidden');
            }
        }
        function tutupLightbox() { document.getElementById('modal-lightbox').classList.add('hidden'); }

        // --- KAS LAINNYA ---
        function simpanKasLainnya() {
            if(userRole !== 'admin') return;
            const jenis = document.getElementById('input-kas-jenis').value;
            const tgl = document.getElementById('input-kas-tgl').value;
            const nominalInput = document.getElementById('input-kas-nominal').value;
            const nominal = parseInt(nominalInput ? nominalInput.replace(/\./g, '') : "0");
            const ket = document.getElementById('input-kas-ket').value.trim();

            if(!tgl || !nominal || isNaN(nominal) || nominal <= 0 || !ket) return showDialog('alert', 'Kesalahan Input', 'Mohon isi semua data dengan benar!');

            const id = Date.now();
            setDoc(doc(getColl('mutasi'), id.toString()), { id, tanggal: tgl, jenis, nominal, keterangan: ket, kategori: 'Lainnya' }).then(() => {
                document.getElementById('input-kas-nominal').value = '';
                document.getElementById('input-kas-ket').value = '';
                showToast('Transaksi kas manual dicatat!');
            });
        }

        function renderTabelKasLainnya() {
            const container = document.getElementById('container-kas-lainnya');
            if(!container) return;
            container.innerHTML = '';

            const dataLainnya = dataMutasi.filter(m => m.kategori === 'Lainnya' || (!m.bukti && !m.keterangan.startsWith('Pembayaran Denda:'))).sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));

            if(dataLainnya.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 bg-white p-6 rounded-lg border border-gray-200">Belum ada riwayat kas manual lainnya.</div>`;
                return;
            }

            dataLainnya.forEach(m => {
                const isMasuk = m.jenis === 'Pemasukan';
                const actionAttr = (userRole === 'admin') ? `onclick="editKasLainnya(${m.id})"` : '';
                const pointerCls = (userRole === 'admin') ? 'cursor-pointer hover:border-blue-400 hover:shadow-md group' : '';

                container.innerHTML += `
                    <div class="bg-white rounded-lg shadow-sm border ${isMasuk ? 'border-green-200' : 'border-red-200'} p-3 flex items-center justify-between transition ${pointerCls}" ${actionAttr}>
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="h-10 w-10 shrink-0 rounded-full flex items-center justify-center font-bold text-lg ${isMasuk ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">
                                <i class="fa-solid ${isMasuk ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                            </div>
                            <div class="min-w-0">
                                <span class="bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded text-[10px] font-bold border border-gray-200 inline-block mb-1"><i class="fa-solid fa-calendar-day mr-1"></i> ${m.tanggal}</span>
                                <p class="text-xs text-gray-800 font-medium leading-snug truncate">${m.keterangan}</p>
                            </div>
                        </div>
                        <div class="text-right shrink-0 ml-2 flex flex-col items-end">
                            <p class="font-bold text-sm ${isMasuk ? 'text-green-600' : 'text-red-600'}">${isMasuk ? '+' : '-'}${formatRp(m.nominal)}</p>
                            ${userRole === 'admin' ? `<span class="text-[10px] text-blue-500 font-bold opacity-0 group-hover:opacity-100 transition inline-block mt-1 bg-blue-50 px-2 py-0.5 rounded"><i class="fa-solid fa-pen mr-1"></i>Edit</span>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        function editKasLainnya(id) {
            const m = dataMutasi.find(x => x.id === id);
            if(m) {
                document.getElementById('edit-kas-id').value = m.id;
                document.getElementById('edit-kas-jenis').value = m.jenis;
                document.getElementById('edit-kas-tgl').value = m.tanggal;
                document.getElementById('edit-kas-nominal').value = m.nominal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                document.getElementById('edit-kas-ket').value = m.keterangan;
                document.getElementById('btn-hapus-kas-modal').onclick = () => hapusKasLainnya(id);
                document.getElementById('modal-edit-kas').classList.remove('hidden');
            }
        }

        function tutupModalEditKas() { document.getElementById('modal-edit-kas').classList.add('hidden'); }

        function simpanEditKas() {
            const id = document.getElementById('edit-kas-id').value;
            const jenis = document.getElementById('edit-kas-jenis').value;
            const tgl = document.getElementById('edit-kas-tgl').value;
            const nominalInput = document.getElementById('edit-kas-nominal').value;
            const nominal = parseInt(nominalInput ? nominalInput.replace(/\./g, '') : "0");
            const ket = document.getElementById('edit-kas-ket').value.trim();

            if(!tgl || !nominal || isNaN(nominal) || nominal <= 0 || !ket) return showDialog('alert', 'Kesalahan', 'Mohon isi data!');

            setDoc(doc(getColl('mutasi'), id), { jenis, tanggal: tgl, nominal, keterangan: ket }, { merge: true }).then(() => {
                tutupModalEditKas(); showToast('Perubahan transaksi disimpan.');
            });
        }

        function hapusKasLainnya(id) {
            showDialog('confirm', 'Hapus Transaksi Kas', 'Hapus riwayat transaksi ini?', () => {
                deleteDoc(doc(getColl('mutasi'), id.toString())).then(() => {
                    tutupModalEditKas(); showToast('Transaksi berhasil dihapus.');
                });
            });
        }

        function bukaModalMutasi() {
            document.getElementById('modal-mutasi').classList.remove('hidden');
            const tbody = document.getElementById('tabel-mutasi');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            const totalKas = hitungTotalKas();
            const mutasiTotalKasEl = document.getElementById('mutasi-total-kas');
            if(mutasiTotalKasEl) {
                mutasiTotalKasEl.innerText = formatRp(totalKas);
                if(totalKas < 0) { mutasiTotalKasEl.classList.remove('text-green-600'); mutasiTotalKasEl.classList.add('text-red-600'); } 
                else { mutasiTotalKasEl.classList.remove('text-red-600'); mutasiTotalKasEl.classList.add('text-green-600'); }
            }

            const mutasiUrut = [...dataMutasi].sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));
            if(mutasiUrut.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500 font-medium">Belum ada riwayat.</td></tr>`; return;
            }

            mutasiUrut.forEach(m => {
                const isMasuk = m.jenis === 'Pemasukan';
                let stringTanggal = m.tanggal;
                try {
                    const dateObj = new Date(m.tanggal);
                    if (!isNaN(dateObj.getTime())) { stringTanggal = `${namaHari[dateObj.getDay()]}, ${dateObj.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'})}`; }
                } catch(e) {}

                let btnAksi = '';
                if (!isMasuk) {
                    btnAksi = `<button onclick="lihatRealisasi(${m.id})" class="text-[10px] bg-blue-50 text-blue-600 hover:bg-blue-100 px-2 py-1 rounded border border-blue-200 font-bold transition whitespace-nowrap shadow-sm"><i class="fa-solid fa-eye mr-1"></i> Lihat</button>`;
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 font-semibold">${stringTanggal}</td>
                        <td class="px-4 py-3 whitespace-nowrap"><span class="px-2 py-1 inline-flex text-xs leading-5 font-bold rounded-full border ${isMasuk ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'}">${isMasuk ? '<i class="fa-solid fa-arrow-down mr-1"></i> Masuk' : '<i class="fa-solid fa-arrow-up mr-1"></i> Keluar'}</span></td>
                        <td class="px-4 py-3 text-sm text-gray-800 font-medium">${m.keterangan}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-bold ${isMasuk ? 'text-green-600' : 'text-red-600'}">${isMasuk ? '+' : '-'}${formatRp(m.nominal)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">${btnAksi}</td>
                    </tr>
                `;
            });
        }
        function tutupModalMutasi() { document.getElementById('modal-mutasi').classList.add('hidden'); }

        function lihatRealisasi(id) {
            tutupModalMutasi(); switchTab('realisasi');
            setTimeout(() => {
                const el = document.getElementById(`realisasi-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('ring-4', 'ring-blue-400', 'scale-[1.02]', 'z-10');
                    setTimeout(() => el.classList.remove('ring-4', 'ring-blue-400', 'scale-[1.02]', 'z-10'), 2000);
                } else showToast('Data realisasi tidak ditemukan.');
            }, 100);
        }

        // --- RENCANA PEMBANGUNAN ---
        function renderRencana() {
            const container = document.getElementById('container-rencana'); 
            if(!container) return;
            container.innerHTML = '';
            if(dataRencana.length === 0) {
                container.innerHTML = `<div class="col-span-full p-6 text-center text-gray-500 bg-white rounded-lg shadow-sm border border-gray-200">Belum ada data rencana.</div>`; return;
            }
            dataRencana.forEach(r => {
                let badgeColor = r.status === 'Selesai' ? 'bg-green-100 text-green-800 border-green-200' : (r.status === 'Sedang Berjalan' ? 'bg-yellow-100 text-yellow-800 border-yellow-200' : 'bg-blue-100 text-blue-800 border-blue-200');
                let adminHtml = userRole === 'admin' ? `
                    <div class="mt-4 pt-3 border-t border-gray-100 flex justify-end space-x-2">
                        <button onclick="bukaModalRencana(${r.id})" class="text-xs px-3 py-1 text-blue-600 hover:bg-blue-50 rounded border border-transparent hover:border-blue-200 transition"><i class="fa-solid fa-pen mr-1"></i> Edit</button>
                        <button onclick="hapusRencana(${r.id})" class="text-xs px-3 py-1 text-red-600 hover:bg-red-50 rounded border border-transparent hover:border-red-200 transition"><i class="fa-solid fa-trash mr-1"></i> Hapus</button>
                    </div>` : '';
                container.innerHTML += `
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-between hover:shadow-md transition">
                        <div>
                            <div class="flex justify-between items-start mb-2 gap-2"><h4 class="font-bold text-gray-800 text-lg leading-tight">${r.judul}</h4><span class="px-2 py-1 whitespace-nowrap text-[10px] uppercase font-bold rounded-full border ${badgeColor}">${r.status}</span></div>
                            <p class="text-xs text-gray-400 mb-2"><i class="fa-solid fa-calendar-alt mr-1"></i> Diupdate: ${r.tanggal}</p><p class="text-sm text-gray-600 leading-relaxed">${r.deskripsi}</p>
                        </div>${adminHtml}
                    </div>`;
            });
        }

        function bukaModalRencana(id = null) {
            if(userRole !== 'admin') return;
            if(id) {
                const r = dataRencana.find(x => x.id === id);
                if(r) {
                    document.getElementById('form-rencana-id').value = r.id; document.getElementById('form-rencana-judul').value = r.judul;
                    document.getElementById('form-rencana-status').value = r.status; document.getElementById('form-rencana-deskripsi').value = r.deskripsi;
                    document.getElementById('modal-rencana-title').innerHTML = '<i class="fa-solid fa-pen-to-square mr-2"></i>Edit Rencana';
                }
            } else {
                document.getElementById('form-rencana-id').value = ''; document.getElementById('form-rencana-judul').value = '';
                document.getElementById('form-rencana-status').value = 'Direncanakan'; document.getElementById('form-rencana-deskripsi').value = '';
                document.getElementById('modal-rencana-title').innerHTML = '<i class="fa-solid fa-clipboard-list mr-2"></i>Form Rencana Pembangunan';
            }
            document.getElementById('modal-rencana').classList.remove('hidden');
        }

        function tutupModalRencana() { document.getElementById('modal-rencana').classList.add('hidden'); }

        function simpanRencana() {
            if(userRole !== 'admin') return;
            const idForm = document.getElementById('form-rencana-id').value;
            const payload = {
                judul: document.getElementById('form-rencana-judul').value.trim(),
                status: document.getElementById('form-rencana-status').value,
                deskripsi: document.getElementById('form-rencana-deskripsi').value.trim(),
                tanggal: new Date().toLocaleDateString('id-ID')
            };

            if(!payload.judul || !payload.deskripsi) return showDialog('alert', 'Perhatian', 'Judul dan Deskripsi program tidak boleh kosong!');

            const docId = idForm ? idForm : Date.now().toString();
            if(!idForm) payload.id = Number(docId);

            setDoc(doc(getColl('rencana'), docId), payload, { merge: true }).then(() => {
                tutupModalRencana(); showToast('Rencana disimpan.');
            });
        }

        function hapusRencana(id) {
            if(userRole !== 'admin') return;
            showDialog('confirm', 'Hapus Rencana', 'Yakin ingin menghapus?', () => {
                deleteDoc(doc(getColl('rencana'), id.toString())).then(() => showToast('Rencana dihapus.'));
            });
        }

        // --- ASPIRASI WARGA ---
        function renderAspirasi() {
            const container = document.getElementById('container-aspirasi'); 
            if(!container) return;
            container.innerHTML = '';
            const aspirasiUrut = [...dataAspirasi].sort((a,b) => b.id - a.id);
            if(aspirasiUrut.length === 0) { container.innerHTML = `<div class="p-6 text-center text-gray-500 bg-white rounded-lg shadow-sm border border-gray-200 italic">Belum ada aspirasi.</div>`; return; }

            aspirasiUrut.forEach(a => {
                let adminTanggapanHtml = a.tanggapan ? `<div class="mt-3 bg-green-50 border-l-4 border-green-500 p-3 rounded-r-md"><p class="text-xs font-bold text-green-800 mb-1"><i class="fa-solid fa-user-shield mr-1"></i> Tanggapan Pengurus RT:</p><p class="text-sm text-green-900 whitespace-pre-line">${a.tanggapan}</p></div>` : '';
                let aksiAdminHtml = userRole === 'admin' ? `
                    <div class="mt-3 pt-3 border-t border-gray-100 flex justify-end space-x-2">
                        <button onclick="bukaModalTanggapan(${a.id})" class="text-[11px] bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded shadow-sm font-bold transition"><i class="fa-solid fa-reply mr-1"></i> ${a.tanggapan ? 'Edit Tanggapan' : 'Beri Tanggapan'}</button>
                        <button onclick="hapusAspirasi(${a.id})" class="text-[11px] bg-red-50 hover:bg-red-100 text-red-600 px-3 py-1.5 rounded shadow-sm font-bold transition"><i class="fa-solid fa-trash mr-1"></i> Hapus</button>
                    </div>` : '';
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 transition hover:shadow-md">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center"><div class="h-8 w-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold mr-3 shrink-0"><i class="fa-solid fa-user"></i></div><div><h4 class="font-bold text-sm text-gray-800">${a.nama}</h4><p class="text-[10px] text-gray-400">${a.tanggal}</p></div></div>
                        </div>
                        <p class="text-sm text-gray-700 mt-2 whitespace-pre-line pl-11">${a.teks}</p>
                        <div class="pl-11">${adminTanggapanHtml}${aksiAdminHtml}</div>
                    </div>`;
            });
        }

        function simpanAspirasi() {
            let nama = document.getElementById('form-aspirasi-nama').value.trim() || 'Warga (Anonim)';
            const teks = document.getElementById('form-aspirasi-teks').value.trim();
            if(!teks) return showDialog('alert', 'Perhatian', 'Isi teks tidak boleh kosong!');

            const id = Date.now();
            setDoc(doc(getColl('aspirasi'), id.toString()), {
                id, nama, teks, tanggapan: null,
                tanggal: new Date().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })
            }).then(() => {
                document.getElementById('form-aspirasi-nama').value = ''; document.getElementById('form-aspirasi-teks').value = '';
                showToast('Aspirasi berhasil dikirim!');
            });
        }

        function hapusAspirasi(id) {
            if(userRole !== 'admin') return;
            showDialog('confirm', 'Hapus Aspirasi', 'Yakin ingin menghapus?', () => {
                deleteDoc(doc(getColl('aspirasi'), id.toString())).then(() => showToast('Aspirasi dihapus.'));
            });
        }

        function bukaModalTanggapan(id) {
            if(userRole !== 'admin') return;
            const a = dataAspirasi.find(x => x.id === id);
            if(a) {
                document.getElementById('form-tanggapan-id').value = a.id;
                document.getElementById('form-tanggapan-teks').value = a.tanggapan || '';
                document.getElementById('modal-tanggapan').classList.remove('hidden');
            }
        }

        function tutupModalTanggapan() { document.getElementById('modal-tanggapan').classList.add('hidden'); }

        function simpanTanggapan() {
            if(userRole !== 'admin') return;
            const id = document.getElementById('form-tanggapan-id').value;
            const tanggapan = document.getElementById('form-tanggapan-teks').value.trim() || null;
            
            setDoc(doc(getColl('aspirasi'), id), { tanggapan }, { merge: true }).then(() => {
                tutupModalTanggapan(); showToast('Tanggapan berhasil disimpan.');
            });
        }

        // INIT LOAD
        window.onload = () => { 
            cekSesi(); 
            // Kita biarkan dashboard update dipanggil dari switchTab jika login, 
            // atau biarkan kosong jika belum login untuk menghemat load
        };

    </script>
</body>
</html>
