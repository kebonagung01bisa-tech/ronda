<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Ronda RT001/RW005 KebonAgung</title>
    <!-- Menggunakan Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome untuk Ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .page-content { display: none; }
        .page-content.active { display: block; }
        /* Style baru untuk Bottom Navbar */
        .tab-btn { color: #94a3b8; transition: all 0.2s ease-in-out; }
        .tab-btn.active { color: #2563eb; }
        .tab-btn.active i { transform: scale(1.25); }
        .rotate-180 { transform: rotate(180deg); }
        /* Kustom Scrollbar untuk Thumbnail Foto */
        .hide-scroll::-webkit-scrollbar { height: 6px; }
        .hide-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .hide-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .hide-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans min-h-screen pb-24">

    <!-- SPLASH SCREEN (Layar Pembuka) -->
    <div id="splash-screen" class="fixed inset-0 bg-white z-[400] flex flex-col items-center justify-center transition-opacity duration-700">
        <img src="https://i.ibb.co.com/21BpG3JY/RT-01.png" alt="Logo RT-01" class="w-3/4 max-w-xs sm:max-w-sm object-contain animate-pulse drop-shadow-2xl mb-8">
        <div class="flex flex-col items-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800 tracking-widest drop-shadow-sm">E-RONDA</h1>
            <p class="text-gray-600 font-bold mt-2 text-sm sm:text-base uppercase tracking-widest">RT.01 / RW.05 KebonAgung</p>
        </div>
    </div>

    <!-- LOGIN SCREEN (LOCK) -->
    <div id="login-screen" class="fixed inset-0 bg-blue-700 z-[300] flex flex-col items-center justify-center text-white transition-opacity duration-500 p-4">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-sm text-gray-800 transform transition-all scale-100" id="login-box">
            <div class="text-center mb-6">
                <div class="bg-blue-50 p-2 sm:p-3 rounded-full inline-block mb-3 shadow-inner">
                    <img src="https://i.ibb.co.com/21BpG3JY/RT-01.png" alt="Logo RT-01" class="h-16 sm:h-20 mx-auto object-contain">
                </div>
                <h2 class="text-xl sm:text-2xl font-bold text-blue-800 leading-tight">E-RONDA</h2>
                <p class="text-xs sm:text-sm text-gray-600 mt-1 font-bold">Dk. KebonAgung RT.01/RW.05</p>
                <p class="text-[10px] text-gray-500 mt-0.5 font-medium uppercase tracking-wide">Jatinegara, Sempor, Kebumen</p>
            </div>
            
            <div id="login-error" class="bg-red-50 text-red-600 text-xs text-center p-2 rounded mb-4 hidden border border-red-200 font-bold">
                Kredensial yang Anda masukkan salah!
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">PIN Akses Warga / Admin</label>
                <input type="password" id="input-pin" class="w-full border-2 border-gray-300 rounded-lg p-3 text-center text-2xl tracking-[0.5em] focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none mb-6 font-mono transition" placeholder="••••" onkeypress="if(event.key === 'Enter') prosesLogin()">
            </div>
            
            <button onclick="prosesLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-md flex items-center justify-center">
                <i class="fa-solid fa-lock-open mr-2"></i> Buka Aplikasi
            </button>
            
            <div class="mt-6 pt-4 border-t border-gray-100 text-[11px] text-center text-gray-500 font-medium leading-relaxed">
                Untuk PIN bisa minta sama Pak RT atau Pak Muji.<br>Klik tombol di bawah untuk meminta PIN:
                <button onclick="window.open('https://wa.me/6285157467216', '_blank')" class="mt-3 w-full bg-green-50 hover:bg-green-500 text-green-600 hover:text-white border border-green-200 hover:border-green-500 py-2.5 rounded-lg transition shadow-sm font-bold flex items-center justify-center">
                    <i class="fa-brands fa-whatsapp text-xl mr-2"></i> Chat WA Pak RT
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER (Tersembunyi sebelum login) -->
    <div id="app-container" class="hidden">
        
        <!-- Navbar Header -->
        <nav class="bg-blue-600 text-white shadow-md relative z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Header Title dengan Logo Baru -->
                    <div class="flex items-center">
                        <div class="bg-white p-0.5 sm:p-1 rounded-full mr-2 sm:mr-3 shadow-md h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center shrink-0 overflow-hidden">
                            <img src="https://i.ibb.co.com/21BpG3JY/RT-01.png" alt="Logo RT-01" class="max-h-full max-w-full object-contain">
                        </div>
                        <div class="flex flex-col min-w-0">
                            <span class="font-bold text-base sm:text-lg md:text-xl tracking-tight leading-tight truncate">E-Ronda RT001</span>
                            <span class="text-[10px] sm:text-xs font-normal leading-tight text-blue-100 truncate mt-0.5">
                                <i class="fa-solid fa-map-location-dot mr-1"></i> Dk.KebonAgung
                            </span>
                        </div>
                    </div>
                    
                    <!-- Role Indicator & Logout -->
                    <div class="flex items-center space-x-2 sm:space-x-3 shrink-0 ml-2">
                        <!-- Tombol Informasi & Aturan -->
                        <button onclick="bukaModalInfo()" class="text-blue-100 hover:text-white bg-blue-700 hover:bg-blue-800 h-8 w-8 sm:h-9 sm:w-9 rounded-full flex items-center justify-center transition shadow-inner mr-1" title="Informasi & Aturan">
                            <i class="fa-solid fa-circle-info text-lg"></i>
                        </button>
                        
                        <div class="flex flex-col items-end">
                            <span class="text-[8px] sm:text-[10px] text-blue-200 uppercase font-bold tracking-wider">Akses</span>
                            <span id="nav-role-badge" class="bg-blue-800 text-white text-[10px] sm:text-xs font-bold px-1.5 sm:px-2 py-0.5 rounded shadow-inner">Admin</span>
                        </div>
                        <button onclick="logoutAplikasi()" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 sm:w-auto sm:h-auto sm:px-4 sm:py-2 rounded-lg text-sm font-bold shadow-md transition flex items-center justify-center">
                            <i class="fa-solid fa-power-off sm:mr-2"></i> <span class="hidden sm:inline">Keluar</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative pt-6">

            <!-- DASHBOARD -->
            <div id="page-dashboard" class="page-content active">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl sm:text-2xl font-bold">Transparansi Dashboard</h2>
                    <span id="badge-role" class="bg-blue-100 text-blue-800 text-[10px] sm:text-xs font-semibold px-2 sm:px-2.5 py-0.5 rounded border border-blue-400">Mode Admin</span>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                    <!-- Card Saldo Kas -->
                    <div class="bg-white rounded-lg shadow-sm sm:shadow p-4 sm:p-6 border-l-4 border-green-500 cursor-pointer hover:shadow-lg hover:border-green-600 transition relative overflow-hidden group" onclick="switchTab('riwayat-kas')">
                        <div class="absolute inset-0 bg-green-50 opacity-0 group-hover:opacity-100 transition"></div>
                        <div class="relative flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="p-2 sm:p-3 rounded-full bg-green-100 text-green-500 mr-3 sm:mr-4 group-hover:scale-110 transition shrink-0">
                                    <i class="fa-solid fa-money-bill-wave text-xl sm:text-2xl"></i>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-[10px] sm:text-sm text-gray-500 font-semibold uppercase truncate">Total Kas Terkumpul</p>
                                    <p class="text-lg sm:text-2xl font-bold text-gray-800 truncate" id="dash-kas">Rp 0</p>
                                </div>
                            </div>
                            <div class="text-green-500 opacity-30 group-hover:opacity-100 transition shrink-0 ml-2">
                                <i class="fa-solid fa-chevron-right text-lg sm:text-xl"></i>
                            </div>
                        </div>
                        <div class="relative mt-2 sm:mt-3 text-[10px] sm:text-xs text-green-700 font-medium opacity-0 group-hover:opacity-100 transition">
                            <i class="fa-solid fa-hand-pointer mr-1"></i> Klik untuk riwayat mutasi
                        </div>
                    </div>
                    <!-- Card Piutang Denda -->
                    <div class="bg-white rounded-lg shadow-sm sm:shadow p-4 sm:p-6 border-l-4 border-red-500 cursor-pointer hover:shadow-lg hover:border-red-600 transition relative overflow-hidden group" onclick="switchTab('keuangan')">
                        <div class="absolute inset-0 bg-red-50 opacity-0 group-hover:opacity-100 transition"></div>
                        <div class="relative flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="p-2 sm:p-3 rounded-full bg-red-100 text-red-500 mr-3 sm:mr-4 group-hover:scale-110 transition shrink-0">
                                    <i class="fa-solid fa-file-invoice-dollar text-xl sm:text-2xl"></i>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-[10px] sm:text-sm text-gray-500 font-semibold uppercase truncate">Denda Belum Dibayar</p>
                                    <p class="text-lg sm:text-2xl font-bold text-gray-800 truncate" id="dash-piutang">Rp 0</p>
                                </div>
                            </div>
                            <div class="text-red-500 opacity-30 group-hover:opacity-100 transition shrink-0 ml-2">
                                <i class="fa-solid fa-chevron-right text-lg sm:text-xl"></i>
                            </div>
                        </div>
                        <div class="relative mt-2 sm:mt-3 text-[10px] sm:text-xs text-red-700 font-medium opacity-0 group-hover:opacity-100 transition">
                            <i class="fa-solid fa-hand-pointer mr-1"></i> Klik untuk kelola denda
                        </div>
                    </div>
                    <!-- Card Total Warga -->
                    <div class="bg-white rounded-lg shadow-sm sm:shadow p-4 sm:p-6 border-l-4 border-blue-500 cursor-pointer hover:shadow-lg hover:border-blue-600 transition relative overflow-hidden group" onclick="switchTab('warga')">
                        <div class="absolute inset-0 bg-blue-50 opacity-0 group-hover:opacity-100 transition"></div>
                        <div class="relative flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="p-2 sm:p-3 rounded-full bg-blue-100 text-blue-500 mr-3 sm:mr-4 group-hover:scale-110 transition shrink-0">
                                    <i class="fa-solid fa-users-viewfinder text-xl sm:text-2xl"></i>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-[10px] sm:text-sm text-gray-500 font-semibold uppercase truncate">Total Warga Aktif</p>
                                    <p class="text-lg sm:text-2xl font-bold text-gray-800 truncate" id="dash-warga">0 Orang</p>
                                </div>
                            </div>
                            <div class="text-blue-500 opacity-30 group-hover:opacity-100 transition shrink-0 ml-2">
                                <i class="fa-solid fa-chevron-right text-lg sm:text-xl"></i>
                            </div>
                        </div>
                        <div class="relative mt-2 sm:mt-3 text-[10px] sm:text-xs text-blue-700 font-medium opacity-0 group-hover:opacity-100 transition">
                            <i class="fa-solid fa-hand-pointer mr-1"></i> Klik untuk kelola warga
                        </div>
                    </div>
                </div>

                <!-- Riwayat Kehadiran Dashboard -->
                <div id="wrapper-riwayat-presensi" class="bg-white shadow-sm sm:shadow rounded-lg p-4 sm:p-6 mb-6 border-t-4 border-indigo-500 hidden">
                    <div class="flex justify-between items-center mb-3 sm:mb-4">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800 flex items-center"><i class="fa-solid fa-clipboard-check text-indigo-500 mr-2"></i>Riwayat Kehadiran</h3>
                        <button id="btn-catat-presensi" onclick="switchTab('presensi')" class="text-[10px] sm:text-xs text-blue-600 font-bold hover:underline transition">Catat Baru</button>
                    </div>
                    <div id="dashboard-riwayat-presensi" class="flex flex-col gap-2">
                        <!-- Konten digenerate via Javascript -->
                    </div>
                </div>
            </div>

            <!-- PRESENSI RONDA (Hanya Admin) -->
            <div id="page-presensi" class="page-content">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 sm:p-4 mb-4 rounded-r-lg">
                    <div class="flex">
                        <div class="flex-shrink-0"><i class="fa-solid fa-triangle-exclamation text-yellow-500 mt-0.5"></i></div>
                        <div class="ml-3"><p class="text-xs sm:text-sm text-yellow-800 font-medium">Halaman ini hanya dapat diakses oleh Admin/Pengurus untuk mendata kehadiran.</p></div>
                    </div>
                </div>
                <h2 class="text-xl sm:text-2xl font-bold mb-4">Catat Presensi Ronda</h2>
                
                <div class="bg-white shadow-sm sm:shadow rounded-lg p-4 sm:p-6 mb-4 sm:mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Pilih Tanggal</label>
                            <input type="date" id="input-tanggal-presensi" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500 text-sm" onchange="loadPresensi()">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Jadwal Regu Hari</label>
                            <input type="text" id="input-hari-presensi" class="w-full border-gray-300 bg-gray-100 rounded-md shadow-sm border p-2 font-bold text-blue-800 text-sm" readonly>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow-sm sm:shadow rounded-lg overflow-hidden mb-6">
                    <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                        <h3 class="text-sm sm:text-base font-semibold text-gray-800">Daftar Warga Bertugas</h3>
                    </div>
                    <div class="p-3 bg-gray-50">
                        <div id="container-presensi" class="flex flex-col gap-3"></div>
                    </div>
                    <div id="pesan-kosong-presensi" class="p-6 text-center text-gray-500 hidden bg-white text-sm">
                        Pilih tanggal untuk melihat jadwal warga. Jika tidak ada, berarti tidak ada jadwal ronda di hari tersebut.
                    </div>
                </div>
            </div>

            <!-- KAS & DENDA (Tagihan & Denda) -->
            <div id="page-keuangan" class="page-content">
                <h2 class="text-xl sm:text-2xl font-bold mb-4">Tagihan & Denda</h2>
                
                <div class="bg-white shadow-sm sm:shadow rounded-lg overflow-hidden mb-6">
                    <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                        <h3 class="text-sm sm:text-lg font-semibold text-gray-800">Daftar Tagihan & Riwayat Denda</h3>
                    </div>
                    <div class="p-3 sm:p-4 bg-gray-50">
                        <div id="container-denda" class="flex flex-col gap-3"></div>
                    </div>
                </div>
            </div>

            <!-- KAS LAINNYA (Pemasukan & Pengeluaran Lainnya) -->
            <div id="page-kas-lainnya" class="page-content">
                <h2 class="text-xl sm:text-2xl font-bold mb-4">Pemasukan & Pengeluaran Manual</h2>
                
                <!-- Form Catat Kas Lainnya (Hanya Admin) -->
                <div id="form-kas-lainnya" class="bg-white shadow-sm sm:shadow rounded-lg p-4 sm:p-6 mb-6 border-t-4 border-green-500 hidden">
                    <h3 class="text-sm sm:text-lg font-bold mb-3 sm:mb-4 text-green-800 flex items-center"><i class="fa-solid fa-money-bill-transfer mr-2 text-green-600"></i>Catat Transaksi Kas</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Jenis Transaksi</label>
                            <select id="input-kas-jenis" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-green-500 focus:border-green-500 text-sm">
                                <option value="Pemasukan">Pemasukan (+)</option>
                                <option value="Pengeluaran">Pengeluaran (-)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="input-kas-tgl" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-green-500 focus:border-green-500 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Nominal (Rp)</label>
                            <input type="text" id="input-kas-nominal" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-green-500 focus:border-green-500 text-sm" placeholder="0" oninput="formatInputRupiah(this)">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Keterangan</label>
                            <input type="text" id="input-kas-ket" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-green-500 focus:border-green-500 text-sm" placeholder="Cth: Donasi, Beli Kopi...">
                        </div>
                    </div>
                    <div class="mt-4 text-right">
                        <button onclick="simpanKasLainnya()" class="w-full sm:w-auto bg-green-600 text-white px-5 py-2.5 rounded-md hover:bg-green-700 transition shadow font-bold text-sm">
                            <i class="fa-solid fa-save mr-1"></i> Simpan Transaksi
                        </button>
                    </div>
                </div>

                <div class="bg-white shadow-sm sm:shadow rounded-lg overflow-hidden mb-6">
                    <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                        <h3 class="text-sm sm:text-lg font-semibold text-gray-800">Riwayat Seluruh Transaksi Kas</h3>
                    </div>
                    <div class="p-3 sm:p-4 bg-gray-50">
                        <div id="container-kas-lainnya" class="flex flex-col gap-3"></div>
                    </div>
                </div>
            </div>

            <!-- HALAMAN RIWAYAT KAS -->
            <div id="page-riwayat-kas" class="page-content">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <h2 class="text-xl sm:text-2xl font-bold">Riwayat Kas Keseluruhan</h2>
                    <div class="bg-white px-4 py-2 rounded-lg shadow-sm border border-gray-200 flex items-center justify-between w-full sm:w-auto">
                        <p class="text-xs sm:text-sm text-gray-600 font-bold uppercase mr-4">Saldo Saat Ini</p>
                        <p class="text-xl sm:text-2xl font-bold text-green-600" id="halaman-total-kas">Rp 0</p>
                    </div>
                </div>

                <div class="bg-white shadow-sm sm:shadow rounded-lg overflow-hidden mb-6">
                    <div class="p-3 sm:p-4 bg-gray-50">
                        <div id="container-riwayat-kas" class="flex flex-col gap-3"></div>
                    </div>
                </div>
            </div>

            <!-- REALISASI ANGGARAN -->
            <div id="page-realisasi" class="page-content">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2 sm:gap-3">
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold">Realisasi Anggaran</h2>
                        <p class="text-xs sm:text-sm text-gray-600 mt-0.5">Laporan transparan penggunaan uang kas RT.</p>
                    </div>
                    <button id="btn-tambah-realisasi" onclick="bukaModalPengeluaran()" class="w-full sm:w-auto bg-red-600 text-white px-4 py-2 sm:py-2.5 rounded-md hover:bg-red-700 transition shadow text-sm font-bold flex items-center justify-center hidden">
                        <i class="fa-solid fa-plus mr-1.5"></i> Catat Pengeluaran
                    </button>
                </div>

                <div id="container-realisasi" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                    <!-- Konten digenerate via Javascript -->
                </div>
            </div>

            <!-- ASPIRASI & RENCANA PEMBANGUNAN -->
            <div id="page-aspirasi" class="page-content">
                <!-- Rencana Pembangunan -->
                <div class="mb-8 sm:mb-10">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2 sm:gap-3">
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Rencana Pembangunan RT01</h2>
                            <p class="text-xs sm:text-sm text-gray-600 mt-0.5">Program kerja dan rencana pengurus RT ke depan.</p>
                        </div>
                        <button id="btn-tambah-rencana" onclick="bukaModalRencana()" class="w-full sm:w-auto bg-blue-600 text-white px-4 py-2 sm:py-2.5 rounded-md hover:bg-blue-700 transition shadow text-sm font-bold flex items-center justify-center hidden">
                            <i class="fa-solid fa-plus mr-1.5"></i> Tambah Rencana
                        </button>
                    </div>
                    <div id="container-rencana" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <!-- Aspirasi Warga -->
                <div class="border-t border-gray-200 pt-6 sm:pt-8">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1 sm:mb-2">Suara & Aspirasi Warga</h2>
                    <p class="text-xs sm:text-sm text-gray-600 mb-4">Sampaikan kritik, saran, atau ide Anda untuk lingkungan kita di sini.</p>
                    
                    <div class="bg-white p-4 sm:p-5 rounded-lg shadow-sm border border-gray-200 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 mb-3">
                            <div>
                                <input type="text" id="form-aspirasi-nama" placeholder="Nama Anda (Boleh Anonim)" class="w-full border border-gray-300 rounded-md p-2.5 focus:ring-blue-500 text-sm">
                            </div>
                        </div>
                        <textarea id="form-aspirasi-teks" placeholder="Tuliskan aspirasi, usulan, atau kritik membangun..." class="w-full border border-gray-300 rounded-md p-2.5 focus:ring-blue-500 text-sm mb-3" rows="3"></textarea>
                        <div class="text-right">
                            <button onclick="simpanAspirasi()" class="w-full sm:w-auto bg-green-600 text-white px-5 py-2.5 rounded-md hover:bg-green-700 transition shadow-sm text-sm font-bold flex items-center justify-center">
                                <i class="fa-solid fa-paper-plane mr-1.5"></i> Kirim Aspirasi
                            </button>
                        </div>
                    </div>

                    <div id="container-aspirasi" class="space-y-4"></div>
                </div>
            </div>

            <!-- DATA WARGA -->
            <div id="page-warga" class="page-content">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <h2 class="text-xl sm:text-2xl font-bold">Jadwal Regu & Warga</h2>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                        <button id="btn-kelola-tipe" onclick="bukaModalTipe()" class="w-full sm:w-auto bg-purple-600 text-white px-4 py-2 sm:py-2.5 rounded-md hover:bg-purple-700 transition text-sm font-bold shadow-sm flex justify-center items-center">
                            <i class="fa-solid fa-tags mr-1.5"></i> Tipe & Denda
                        </button>
                        <button id="btn-tambah-warga" onclick="bukaModalWarga()" class="w-full sm:w-auto bg-blue-600 text-white px-4 py-2 sm:py-2.5 rounded-md hover:bg-blue-700 transition text-sm font-bold shadow-sm flex justify-center items-center">
                            <i class="fa-solid fa-user-plus mr-1.5"></i> Tambah Warga
                        </button>
                    </div>
                </div>
                <!-- Grid 3 Kolom di Mobile, 4 Kolom di Desktop -->
                <div id="container-warga" class="grid grid-cols-3 md:grid-cols-4 gap-2 sm:gap-4 pb-8"></div>
            </div>

        </main>

        <!-- BOTTOM NAVIGATION BAR -->
        <nav id="bottom-navbar" class="fixed bottom-0 w-full bg-white border-t border-gray-200 shadow-[0_-4px_10px_rgba(0,0,0,0.05)] z-50">
            <div class="flex justify-between items-end h-16 max-w-7xl mx-auto px-1 pb-1">
                
                <!-- Beranda -->
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn active flex-1 flex flex-col items-center justify-end h-full pb-1">
                    <i class="fa-solid fa-chart-line text-lg sm:text-xl mb-1"></i>
                    <span class="text-[8px] sm:text-[10px] font-bold leading-none">Beranda</span>
                </button>
                
                <!-- Presensi -->
                <button onclick="switchTab('presensi')" id="tab-presensi" class="tab-btn flex-1 flex flex-col items-center justify-end h-full pb-1">
                    <i class="fa-solid fa-clipboard-user text-lg sm:text-xl mb-1"></i>
                    <span class="text-[8px] sm:text-[10px] font-bold leading-none">Presensi</span>
                </button>
                
                <!-- Kas -->
                <button onclick="switchTab('kas-lainnya')" id="tab-kas-lainnya" class="tab-btn flex-1 flex flex-col items-center justify-end h-full pb-1">
                    <i class="fa-solid fa-money-bill-transfer text-lg sm:text-xl mb-1"></i>
                    <span class="text-[8px] sm:text-[10px] font-bold leading-none">Kas</span>
                </button>
                
                <!-- WA Center Floating Action Button -->
                <div id="btn-wa-container" class="relative flex-shrink-0 w-16 flex justify-center pb-1">
                    <button onclick="bukaModalWA()" class="absolute bottom-2 bg-green-500 hover:bg-green-600 text-white w-14 h-14 sm:w-16 sm:h-16 rounded-full flex items-center justify-center shadow-[0_5px_15px_rgba(34,197,94,0.4)] border-4 border-white transition transform hover:scale-105 z-[60]">
                        <i class="fa-brands fa-whatsapp text-2xl sm:text-3xl"></i>
                    </button>
                </div>

                <!-- Realisasi -->
                <button onclick="switchTab('realisasi')" id="tab-realisasi" class="tab-btn flex-1 flex flex-col items-center justify-end h-full pb-1">
                    <i class="fa-solid fa-camera-retro text-lg sm:text-xl mb-1"></i>
                    <span class="text-[8px] sm:text-[10px] font-bold leading-none">Realisasi</span>
                </button>
                
                <!-- Aspirasi -->
                <button onclick="switchTab('aspirasi')" id="tab-aspirasi" class="tab-btn flex-1 flex flex-col items-center justify-end h-full pb-1">
                    <i class="fa-solid fa-bullhorn text-lg sm:text-xl mb-1"></i>
                    <span class="text-[8px] sm:text-[10px] font-bold leading-none">Aspirasi</span>
                </button>
                
            </div>
        </nav>

    </div> <!-- END APP CONTAINER -->

    <!-- Modal WhatsApp / Hubungi Pak RT -->
    <div id="modal-wa" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-[200] p-4 transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden text-center transform scale-100 transition-transform">
            <div class="bg-gradient-to-br from-green-400 to-green-600 p-6 flex flex-col items-center relative">
                <button onclick="tutupModalWA()" class="absolute top-3 right-3 text-green-100 hover:text-white transition"><i class="fa-solid fa-times text-xl"></i></button>
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg mb-3 mt-2">
                    <i class="fa-brands fa-whatsapp text-4xl text-green-500"></i>
                </div>
                <h3 class="text-xl font-bold text-white">Hubungi Pak RT</h3>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-6 font-medium leading-relaxed">Akses cepat hubungi Pak RT.01 /05 KebonAgung, Jatinegara, Sempor.</p>
                <div class="flex flex-col gap-3">
                    <button onclick="window.open('https://wa.me/6285157467216', '_blank')" class="w-full bg-green-500 text-white px-5 py-3 rounded-xl hover:bg-green-600 font-bold transition shadow-md flex items-center justify-center text-sm">
                        <i class="fa-brands fa-whatsapp mr-2 text-lg"></i> Chat WhatsApp Sekarang
                    </button>
                    <button onclick="tutupModalWA()" class="w-full bg-gray-50 text-gray-600 px-5 py-3 rounded-xl hover:bg-gray-100 border border-gray-200 font-bold transition shadow-sm text-sm">
                        Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tambah/Edit Warga -->
    <div id="modal-warga" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-[100] p-4 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="px-5 py-4 border-b bg-gray-50">
                <h3 id="modal-warga-title" class="text-lg font-bold text-gray-800">Tambah Warga Baru</h3>
            </div>
            <div class="p-5 space-y-4">
                <input type="hidden" id="form-id-warga">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="form-nama" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Status / Tipe Warga</label>
                    <select id="form-tipe" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 text-sm"></select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">No. WhatsApp <span class="text-xs text-gray-400 font-normal">(Opsional)</span></label>
                    <input type="number" id="form-wa" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 text-sm" placeholder="Contoh: 08123456789">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Jadwal Ronda</label>
                    <select id="form-jadwal" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 text-sm">
                        <option value="Senin">Senin</option><option value="Selasa">Selasa</option><option value="Rabu">Rabu</option>
                        <option value="Kamis">Kamis</option><option value="Jumat">Jumat</option><option value="Sabtu">Sabtu</option><option value="Minggu">Minggu</option>
                    </select>
                </div>
            </div>
            <div class="px-5 py-4 bg-gray-50 flex justify-end space-x-2 border-t">
                <button onclick="tutupModalWarga()" class="flex-1 sm:flex-none bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 font-bold text-sm">Batal</button>
                <button onclick="simpanWarga()" class="flex-1 sm:flex-none bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-bold text-sm shadow-sm">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Kelola Tipe & Tarif Denda -->
    <div id="modal-tipe" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-[100] p-4 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-5 py-4 border-b bg-purple-50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-purple-900"><i class="fa-solid fa-tags mr-2"></i>Tipe & Tarif Denda</h3>
                <button onclick="tutupModalTipe()" class="text-gray-500 hover:text-red-500 transition"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-4 sm:p-5 flex-grow overflow-y-auto">
                <div class="bg-gray-50 p-3 sm:p-4 rounded-lg border border-gray-200 mb-4 sm:mb-5">
                    <h4 class="text-sm font-bold text-gray-700 mb-2">Tambah Tipe Baru</h4>
                    <div class="flex flex-col gap-2">
                        <input type="text" id="input-nama-tipe" placeholder="Nama Tipe" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                        <div class="flex gap-2">
                            <input type="text" id="input-nominal-tipe" placeholder="Denda (Rp)" class="flex-1 border border-gray-300 rounded-md p-2 text-sm" oninput="formatInputRupiah(this)">
                            <button onclick="tambahTipe()" class="bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 text-sm font-bold shadow-sm shrink-0"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                </div>
                <!-- Mengganti Table dengan Card List agar responsive -->
                <div id="container-tipe-denda" class="flex flex-col gap-2"></div>
            </div>
        </div>
    </div>

    <!-- Modal Form Catat Pengeluaran & Upload Foto -->
    <div id="modal-pengeluaran" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-[120] p-4 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl p-5 sm:p-6 w-full max-w-sm sm:max-w-md border-t-4 border-red-500 max-h-[95vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4 text-red-700 flex items-center" id="modal-pengeluaran-title"><i class="fa-solid fa-money-check-dollar mr-2"></i>Catat Realisasi</h3>
            <div class="space-y-3 sm:space-y-4">
                <input type="hidden" id="form-pengeluaran-id">
                <div>
                    <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Tanggal</label>
                    <input type="date" id="form-pengeluaran-tgl" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 text-sm">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Nominal (Rp)</label>
                    <input type="text" id="form-pengeluaran-nominal" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 text-sm" placeholder="50.000" oninput="formatInputRupiah(this)">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Keperluan / Keterangan</label>
                    <textarea id="form-pengeluaran-ket" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 text-sm" rows="2" placeholder="Cth: Servis lampu jalan..."></textarea>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-2"><i class="fa-solid fa-camera mr-1"></i> Upload Bukti Foto</label>
                    <input type="file" id="form-pengeluaran-bukti" multiple accept="image/*" class="w-full text-xs text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-bold file:bg-red-100 file:text-red-700 hover:file:bg-red-200 cursor-pointer" onchange="previewBukti(this)">
                    <div class="flex justify-between items-center mt-3 border-t border-gray-200 pt-2">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">Preview:</span>
                        <button type="button" onclick="clearBukti()" class="text-[10px] text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 px-2 py-1 rounded font-bold transition hidden shadow-sm" id="btn-clear-bukti"><i class="fa-solid fa-trash mr-1"></i> Hapus Semua</button>
                    </div>
                    <div id="preview-bukti-container" class="mt-2 flex flex-wrap gap-2 hide-scroll"></div>
                </div>
            </div>
            <div class="mt-5 flex justify-end space-x-2">
                <button onclick="tutupModalPengeluaran()" class="flex-1 sm:flex-none bg-gray-200 text-gray-800 px-4 py-2.5 rounded-lg hover:bg-gray-300 text-sm font-bold transition">Batal</button>
                <button id="btn-simpan-pengeluaran" onclick="simpanPengeluaran()" class="flex-1 sm:flex-none bg-red-600 text-white px-4 py-2.5 rounded-lg hover:bg-red-700 text-sm font-bold shadow-sm transition flex items-center justify-center">
                    Simpan Laporan
                </button>
            </div>
        </div>
    </div>

    <!-- Lightbox Modal untuk Zoom Gambar -->
    <div id="modal-lightbox" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center z-[300] p-2 sm:p-4 transition-opacity cursor-zoom-out" onclick="tutupLightbox()">
        <img id="lightbox-img" src="" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl cursor-default" onclick="event.stopPropagation()">
        <button onclick="tutupLightbox()" class="absolute top-4 right-4 sm:top-6 sm:right-6 bg-black/50 text-white hover:text-red-400 text-2xl sm:text-3xl w-10 h-10 rounded-full flex items-center justify-center cursor-pointer transition"><i class="fa-solid fa-times"></i></button>
    </div>

    <!-- Modal Rencana Pembangunan -->
    <div id="modal-rencana" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-[100] p-4 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl p-5 sm:p-6 w-full max-w-sm border-t-4 border-blue-500">
            <h3 class="text-lg font-bold mb-4 text-blue-800 flex items-center" id="modal-rencana-title"><i class="fa-solid fa-clipboard-list mr-2"></i>Form Rencana</h3>
            <div class="space-y-3">
                <input type="hidden" id="form-rencana-id">
                <div>
                    <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Judul / Nama Program</label>
                    <input type="text" id="form-rencana-judul" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 text-sm" placeholder="Contoh: Perbaikan Pos Kamling">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Status Pengerjaan</label>
                    <select id="form-rencana-status" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 text-sm font-semibold">
                        <option value="Direncanakan">Direncanakan</option>
                        <option value="Sedang Berjalan">Sedang Berjalan</option>
                        <option value="Selesai">Selesai</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Deskripsi Detail</label>
                    <textarea id="form-rencana-deskripsi" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 text-sm" rows="3"></textarea>
                </div>
            </div>
            <div class="mt-5 flex justify-end space-x-2">
                <button onclick="tutupModalRencana()" class="flex-1 sm:flex-none bg-gray-200 text-gray-800 px-4 py-2.5 rounded-lg hover:bg-gray-300 text-sm font-bold transition">Batal</button>
                <button onclick="simpanRencana()" class="flex-1 sm:flex-none bg-blue-600 text-white px-4 py-2.5 rounded-lg hover:bg-blue-700 text-sm font-bold shadow-sm transition">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Detail Rencana Pembangunan -->
    <div id="modal-detail-rencana" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-[150] p-4 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-5 py-4 border-b bg-blue-50 flex justify-between items-start gap-3">
                <h3 id="detail-rencana-judul" class="text-base sm:text-lg font-bold text-blue-900 leading-tight">Judul</h3>
                <button onclick="tutupDetailRencana()" class="text-gray-500 hover:text-red-500 transition shrink-0"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-4 sm:p-5 flex-grow overflow-y-auto">
                <div class="flex items-center gap-2 mb-4">
                    <span id="detail-rencana-status" class="px-2.5 py-1 text-[10px] sm:text-xs font-bold rounded-md border inline-block uppercase">Status</span>
                    <span id="detail-rencana-tgl" class="text-xs text-gray-500"><i class="fa-solid fa-calendar-alt mr-1"></i> Tanggal</span>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                    <p id="detail-rencana-deskripsi" class="text-sm text-gray-800 leading-relaxed whitespace-pre-line"></p>
                </div>
            </div>
            <div class="px-5 py-3 bg-gray-50 border-t flex justify-end">
                <button onclick="tutupDetailRencana()" class="bg-gray-200 text-gray-800 px-5 py-2.5 rounded-lg font-bold text-sm hover:bg-gray-300 transition shadow-sm">Tutup Detail</button>
            </div>
        </div>
    </div>

    <!-- Modal Tanggapan Aspirasi (Admin) -->
    <div id="modal-tanggapan" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-[100] p-4 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl p-5 sm:p-6 w-full max-w-sm border-t-4 border-green-500">
            <h3 class="text-lg font-bold mb-4 text-green-800 flex items-center"><i class="fa-solid fa-reply mr-2"></i>Beri Tanggapan RT</h3>
            <div class="space-y-3">
                <input type="hidden" id="form-tanggapan-id">
                <div>
                    <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Komentar / Jawaban Admin</label>
                    <textarea id="form-tanggapan-teks" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-green-500 text-sm" rows="4"></textarea>
                </div>
            </div>
            <div class="mt-5 flex justify-end space-x-2">
                <button onclick="tutupModalTanggapan()" class="flex-1 sm:flex-none bg-gray-200 text-gray-800 px-4 py-2.5 rounded-lg hover:bg-gray-300 text-sm font-bold transition">Batal</button>
                <button onclick="simpanTanggapan()" class="flex-1 sm:flex-none bg-green-600 text-white px-4 py-2.5 rounded-lg hover:bg-green-700 text-sm font-bold shadow-sm transition">Kirim</button>
            </div>
        </div>
    </div>

    <!-- Modal Edit Kas Lainnya -->
    <div id="modal-edit-kas" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-[100] p-4 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm border-t-4 border-yellow-500 overflow-hidden">
            <div class="px-5 py-4 border-b bg-yellow-50 flex justify-between items-center">
                <h3 class="text-base sm:text-lg font-bold text-yellow-900 flex items-center"><i class="fa-solid fa-pen-to-square mr-2"></i>Edit Transaksi</h3>
                <button onclick="tutupModalEditKas()" class="text-gray-500 hover:text-red-500 transition"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-5 space-y-3">
                <input type="hidden" id="edit-kas-id">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2">
                        <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Jenis Transaksi</label>
                        <select id="edit-kas-jenis" class="w-full border-gray-300 rounded-lg p-2.5 focus:ring-yellow-500 text-sm font-semibold">
                            <option value="Pemasukan">Pemasukan (+)</option>
                            <option value="Pengeluaran">Pengeluaran (-)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="edit-kas-tgl" class="w-full border-gray-300 rounded-lg p-2.5 focus:ring-yellow-500 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Nominal (Rp)</label>
                        <input type="text" id="edit-kas-nominal" class="w-full border-gray-300 rounded-lg p-2.5 focus:ring-yellow-500 text-sm" oninput="formatInputRupiah(this)">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Keterangan Detail</label>
                        <input type="text" id="edit-kas-ket" class="w-full border-gray-300 rounded-lg p-2.5 focus:ring-yellow-500 text-sm">
                    </div>
                </div>
            </div>
            <div class="px-5 py-4 bg-gray-50 flex justify-between items-center border-t">
                <button id="btn-hapus-kas-modal" class="bg-red-100 text-red-600 p-2.5 rounded-lg hover:bg-red-200 transition shadow-sm" title="Hapus Transaksi"><i class="fa-solid fa-trash"></i></button>
                <div class="flex space-x-2">
                    <button onclick="tutupModalEditKas()" class="bg-gray-200 text-gray-800 px-4 py-2.5 rounded-lg hover:bg-gray-300 text-sm font-bold transition">Batal</button>
                    <button onclick="simpanEditKas()" class="bg-yellow-500 text-white px-4 py-2.5 rounded-lg hover:bg-yellow-600 text-sm font-bold shadow-sm transition">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Detail Kehadiran Harian -->
    <div id="modal-detail-presensi" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-[150] p-4 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm sm:max-w-md overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-5 py-4 border-b bg-indigo-50 flex justify-between items-center">
                <div>
                    <h3 class="text-sm font-bold text-indigo-900 leading-none">Detail Kehadiran</h3>
                    <p class="text-[11px] text-indigo-600 font-medium mt-1" id="detail-presensi-tgl">-</p>
                </div>
                <button onclick="tutupDetailPresensi()" class="text-gray-500 hover:text-red-500 transition"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-4 sm:p-5 flex-grow overflow-y-auto space-y-4">
                <!-- Hadir -->
                <div>
                    <h4 class="text-xs font-bold text-green-700 bg-green-50 px-2 py-1 rounded inline-block mb-2"><i class="fa-solid fa-check mr-1"></i> Hadir</h4>
                    <ul id="list-detail-hadir" class="pl-1 space-y-1 mt-1"></ul>
                </div>
                <hr class="border-gray-100">
                <!-- Tidak Hadir -->
                <div>
                    <h4 class="text-xs font-bold text-red-700 bg-red-50 px-2 py-1 rounded inline-block mb-2"><i class="fa-solid fa-xmark mr-1"></i> Tidak Hadir</h4>
                    <ul id="list-detail-tidakhadir" class="pl-1 space-y-1 mt-1"></ul>
                </div>
                <hr class="border-gray-100">
                <!-- Bukti Foto -->
                <div>
                    <h4 class="text-xs font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded inline-block mb-2"><i class="fa-solid fa-camera mr-1"></i> Bukti Foto Kegiatan</h4>
                    <div id="container-bukti-presensi" class="flex flex-wrap gap-2 mb-2 hide-scroll"></div>
                    <!-- Upload Input (Khusus Admin) -->
                    <div id="admin-upload-presensi" class="hidden mt-2 border-t border-dashed border-gray-200 pt-2">
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase tracking-wider">Tambah Foto (Admin)</label>
                        <input type="file" id="input-foto-presensi" multiple accept="image/*" class="w-full text-xs text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-bold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 cursor-pointer" onchange="prosesUploadBuktiPresensi(this)">
                        <span id="loading-upload-presensi" class="hidden text-xs text-blue-500 font-bold mt-1 inline-block"><i class="fa-solid fa-spinner fa-spin mr-1"></i> Mengunggah...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Informasi & Aturan -->
    <div id="modal-informasi" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-[200] p-4 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="px-5 py-4 border-b bg-blue-50 flex justify-between items-center">
                <h3 class="text-base font-bold text-blue-900 flex items-center"><i class="fa-solid fa-circle-info mr-2 text-blue-600"></i>Informasi & Aturan</h3>
                <button onclick="tutupModalInfo()" class="text-gray-500 hover:text-red-500 transition"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-5 text-sm">
                <ul class="list-disc list-outside ml-4 text-gray-600 space-y-2.5">
                    <li>Sistem ini terhubung ke <b>Database Cloud</b>. Perubahan tersimpan secara real-time.</li>
                    <li>Warga wajib mengikuti jadwal ronda. Jika berhalangan/absen akan dikenakan denda kedisiplinan.</li>
                    <li>Besaran tarif denda bervariasi tergantung status warga yang sudah disepakati bersama.</li>
                    <li>Uang hasil denda 100% masuk ke Kas RT. Pengeluaran serta bukti foto realisasinya transparan dan dapat dilihat oleh semua warga.</li>
                </ul>
            </div>
            <div class="px-5 py-3 bg-gray-50 border-t text-center">
                <button onclick="tutupModalInfo()" class="w-full bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold shadow-sm hover:bg-blue-700 transition">Tutup Informasi</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modal -->
    <div id="custom-dialog" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden flex items-center justify-center z-[500] p-4 transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs overflow-hidden transform scale-100 transition-transform">
            <div class="p-6 text-center">
                <div id="dialog-icon" class="mb-4 text-5xl"></div>
                <h3 id="dialog-title" class="text-lg font-bold text-gray-800 mb-2">Konfirmasi</h3>
                <p id="dialog-message" class="text-sm text-gray-600 mb-6 leading-relaxed"></p>
                <div class="flex flex-col sm:flex-row justify-center gap-2">
                    <button id="btn-dialog-cancel" class="w-full sm:w-auto bg-gray-100 text-gray-700 px-5 py-2.5 rounded-lg hover:bg-gray-200 font-bold transition shadow-sm hidden">Batal</button>
                    <button id="btn-dialog-ok" class="w-full sm:w-auto bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 font-bold transition shadow-sm">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Sukses (Toast) -->
    <div id="toast" class="fixed bottom-5 right-5 sm:bottom-8 sm:right-8 bg-gray-800 text-white px-4 sm:px-6 py-3 rounded-lg shadow-2xl transition-opacity duration-300 opacity-0 pointer-events-none z-[600] border-l-4 border-green-500 flex items-center font-medium text-sm sm:text-base max-w-[90vw]">
        <i class="fa-solid fa-circle-check text-green-400 mr-2 sm:mr-3 text-lg"></i> <span id="toast-msg">Berhasil!</span>
    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script>
        // --- KONFIGURASI KEAMANAN ---
        const SECRET_KODE_RT = 'KBN01'; 
        const PIN_WARGA = '12345'; 
        const PIN_ADMIN = '987654'; 

        // --- SISTEM LOGIN ---
        function prosesLogin() {
            const inputPin = document.getElementById('input-pin').value;
            
            if (inputPin === PIN_ADMIN) {
                userRole = 'admin';
                masukAplikasi(SECRET_KODE_RT);
            } else if (inputPin === PIN_WARGA) {
                userRole = 'warga';
                masukAplikasi(SECRET_KODE_RT);
            } else {
                tampilkanError('PIN yang Anda masukkan salah!');
            }
        }

        function tampilkanError(msg) {
            const errorBox = document.getElementById('login-error');
            errorBox.innerText = msg;
            errorBox.classList.remove('hidden');
            document.getElementById('input-pin').value = '';
            document.getElementById('login-box').classList.add('animate-bounce');
            setTimeout(() => document.getElementById('login-box').classList.remove('animate-bounce'), 500);
        }

        function masukAplikasi(kodeRT) {
            sessionStorage.setItem('ronda_logged_in', 'true');
            sessionStorage.setItem('ronda_role', userRole);
            sessionStorage.setItem('ronda_kode_rt', kodeRT); 
            
            document.getElementById('login-screen').classList.add('opacity-0', 'pointer-events-none');
            
            // Tampilkan kembali Splash Screen sebagai indikator loading
            const splash = document.getElementById('splash-screen');
            splash.classList.remove('hidden', 'opacity-0', 'pointer-events-none');

            setTimeout(() => {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                
                initFirebase().then(() => {
                    terapkanRoleUI();
                });
            }, 500);
        }

        function logoutAplikasi() {
            showDialog('confirm', 'Keluar Aplikasi', 'Anda yakin ingin mengunci kembali aplikasi?', () => {
                // 1. Hapus memori sesi
                sessionStorage.removeItem('ronda_logged_in');
                sessionStorage.removeItem('ronda_role');
                sessionStorage.removeItem('ronda_kode_rt');
                
                // 2. Sembunyikan aplikasi utama
                document.getElementById('app-container').classList.add('hidden');
                
                // 3. Munculkan kembali Lock Screen secara instan
                const loginScreen = document.getElementById('login-screen');
                loginScreen.classList.remove('hidden');
                
                // Sedikit jeda untuk efek transisi
                setTimeout(() => {
                    loginScreen.classList.remove('opacity-0', 'pointer-events-none');
                }, 50);

                // 4. Bersihkan form inputan sebelumnya
                document.getElementById('input-pin').value = '';
                
                showToast('Aplikasi berhasil dikunci.');
            });
        }

        function cekSesi() {
            const isLoggedIn = sessionStorage.getItem('ronda_logged_in');
            const savedKodeRT = sessionStorage.getItem('ronda_kode_rt');
            
            if (isLoggedIn === 'true' && savedKodeRT) {
                userRole = sessionStorage.getItem('ronda_role') || 'warga';
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                
                initFirebase().then(() => {
                    terapkanRoleUI();
                });
            } else {
                 sessionStorage.clear(); 
                 // Sembunyikan splash screen jika tidak login (kasih jeda agar terlihat dulu)
                 setTimeout(() => {
                     const splash = document.getElementById('splash-screen');
                     if(splash) {
                         splash.classList.add('opacity-0', 'pointer-events-none');
                         setTimeout(() => splash.classList.add('hidden'), 700);
                     }
                 }, 1500);
            }
        }

        // --- CUSTOM DIALOG & UI HELPERS ---
        function showDialog(type, title, message, onConfirm) {
            const dialog = document.getElementById('custom-dialog');
            const icon = document.getElementById('dialog-icon');
            const btnCancel = document.getElementById('btn-dialog-cancel');
            const btnOk = document.getElementById('btn-dialog-ok');
            
            document.getElementById('dialog-title').innerText = title;
            document.getElementById('dialog-message').innerText = message;

            const newBtnOk = btnOk.cloneNode(true);
            const newBtnCancel = btnCancel.cloneNode(true);
            btnOk.parentNode.replaceChild(newBtnOk, btnOk);
            btnCancel.parentNode.replaceChild(newBtnCancel, btnCancel);

            if (type === 'alert') {
                icon.innerHTML = '<i class="fa-solid fa-circle-exclamation text-yellow-500"></i>';
                newBtnCancel.classList.add('hidden');
                newBtnOk.className = "w-full sm:w-auto bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 font-bold shadow-sm";
                newBtnOk.innerText = "Mengerti";
                newBtnOk.onclick = () => { dialog.classList.add('hidden'); if(onConfirm) onConfirm(); };
            } else if (type === 'confirm') {
                icon.innerHTML = '<i class="fa-solid fa-circle-question text-blue-500"></i>';
                newBtnCancel.classList.remove('hidden');
                newBtnOk.className = "w-full sm:w-auto bg-green-600 text-white px-6 py-2.5 rounded-lg hover:bg-green-700 font-bold shadow-sm";
                newBtnOk.innerText = "Ya, Lanjutkan";
                newBtnCancel.onclick = () => { dialog.classList.add('hidden'); };
                newBtnOk.onclick = () => { dialog.classList.add('hidden'); if(onConfirm) onConfirm(); };
            }

            dialog.classList.remove('hidden');
        }

        function formatInputRupiah(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value) {
                input.value = parseInt(value, 10).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            } else {
                input.value = '';
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-10');
            setTimeout(() => toast.classList.add('opacity-0', 'pointer-events-none', 'translate-y-10'), 3000);
        }

        // --- FUNGSI MODAL INFORMASI & WHATSAPP ---
        function bukaModalInfo() {
            document.getElementById('modal-informasi').classList.remove('hidden');
        }
        function tutupModalInfo() {
            document.getElementById('modal-informasi').classList.add('hidden');
        }

        function bukaModalWA() {
            document.getElementById('modal-wa').classList.remove('hidden');
        }
        function tutupModalWA() {
            document.getElementById('modal-wa').classList.add('hidden');
        }

        // --- GLOBAL STATE ---
        let userRole = 'admin'; 
        const namaHari = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        
        let pengaturanDenda = [];
        let dataWarga = [];
        let dataDenda = [];
        let dataMutasi = [];
        let dataPresensi = {};
        let dataRencana = [];
        let dataAspirasi = [];
        let tempBuktiBase64 = []; 
        let currentModalDateStr = ''; // Menyimpan tanggal modal presensi yang sedang terbuka

        function getNominalDenda(tipeText) {
            const p = pengaturanDenda.find(x => x.tipe === tipeText);
            return p ? p.nominal : 0; 
        }

        function hitungTotalKas() {
            return dataMutasi.reduce((total, m) => m.jenis === 'Pemasukan' ? total + m.nominal : total - m.nominal, 0);
        }

        function formatNoWA(no) {
            let formatted = no.replace(/\D/g, '');
            if (formatted.startsWith('0')) {
                formatted = '62' + formatted.substring(1);
            }
            return formatted;
        }

        const formatRp = (angka) => {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
        };

        // --- FIREBASE SETUP ---
        let db, collection, doc, setDoc, deleteDoc, onSnapshot, deleteField;
        let currentUser = null;
        let initialLoadCount = 0;

        function cekSelesaiLoading() {
            initialLoadCount++;
            // Tunggu beberapa koleksi utama selesai ditarik agar UI tidak berkedip
            if (initialLoadCount >= 4) {
                setTimeout(() => {
                    const splash = document.getElementById('splash-screen');
                    if (splash) {
                        splash.classList.add('opacity-0', 'pointer-events-none');
                        setTimeout(() => splash.classList.add('hidden'), 700);
                    }
                }, 300); // Sedikit jeda agar layar beranda sempat ter-render sebelum splash menghilang
            }
        }

        const getColl = (name) => {
            const prefix = sessionStorage.getItem('ronda_kode_rt') || 'DEFAULT';
            return collection(db, `${prefix}_${name}`);
        };

        async function initFirebase() {
            try {
                const appModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const authModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const firestoreModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                
                db = firestoreModule.getFirestore;
                collection = firestoreModule.collection;
                doc = firestoreModule.doc;
                setDoc = firestoreModule.setDoc;
                deleteDoc = firestoreModule.deleteDoc;
                onSnapshot = firestoreModule.onSnapshot;
                deleteField = firestoreModule.deleteField;

                const firebaseConfig = {
                    apiKey: "AIzaSyAmQN1gOPKs6Up2rxLK0d94t1_9f3flRAw",
                    authDomain: "e-ronda-kebonagung.firebaseapp.com",
                    projectId: "e-ronda-kebonagung",
                    storageBucket: "e-ronda-kebonagung.firebasestorage.app",
                    messagingSenderId: "892632721018",
                    appId: "1:892632721018:web:f412f57a7de8f010d9bdc3"
                };

                const app = appModule.initializeApp(firebaseConfig);
                const auth = authModule.getAuth(app);
                db = firestoreModule.getFirestore(app);

                await authModule.signInAnonymously(auth);

                return new Promise((resolve) => {
                    authModule.onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUser = user;
                            initialLoadCount = 0; // Reset counter
                            setupRealtimeListeners();
                            // Splash screen disembunyikan oleh cekSelesaiLoading() nanti
                            resolve(); 
                        }
                    });
                });
                
            } catch(e) {
                console.error("Firebase init error:", e);
                const splash = document.getElementById('splash-screen');
                if (splash) {
                     splash.classList.add('opacity-0', 'pointer-events-none');
                     setTimeout(() => splash.classList.add('hidden'), 700);
                }
                showDialog('alert', 'Error Server', 'Gagal terhubung ke Database Cloud. Periksa koneksi internet Anda.');
                return Promise.reject(e); 
            }
        }

        // --- REAL-TIME DATA SYNC ---
        function setupRealtimeListeners() {
            if (!currentUser) return;

            let isFirstWarga = true, isFirstDenda = true, isFirstMutasi = true, isFirstPresensi = true;

            onSnapshot(getColl('warga'), (snap) => {
                if(snap.empty && dataWarga.length === 0) {
                    const baseWarga = [
                        { id: 1, nama: 'Eko hadi', tipe: 'Reguler', jadwal: 'Senin' }, { id: 2, nama: 'Nanang', tipe: 'Reguler', jadwal: 'Senin' },
                        { id: 8, nama: 'Dodo', tipe: 'Reguler', jadwal: 'Selasa' }, { id: 13, nama: 'Suminem', tipe: 'Janda', jadwal: 'Selasa' },
                        { id: 15, nama: 'Samirin', tipe: 'Reguler', jadwal: 'Rabu' }, { id: 22, nama: 'Sadimin', tipe: 'Reguler', jadwal: 'Kamis' },
                        { id: 29, nama: 'Sidik', tipe: 'Reguler', jadwal: 'Jumat' }, { id: 36, nama: 'Kirno', tipe: 'Reguler', jadwal: 'Sabtu' },
                        { id: 43, nama: 'Minarto', tipe: 'Reguler', jadwal: 'Minggu' }
                    ];
                    baseWarga.forEach(w => setDoc(doc(getColl('warga'), w.id.toString()), w));
                } else {
                    dataWarga = snap.docs.map(d => d.data());
                    if(document.getElementById('page-warga') && document.getElementById('page-warga').classList.contains('active')) renderTabelWarga();
                    updateDashboard();
                    if(document.getElementById('page-presensi') && document.getElementById('page-presensi').classList.contains('active')) loadPresensi();
                }
                if(isFirstWarga) { isFirstWarga = false; cekSelesaiLoading(); }
            }, (err) => console.error(err));

            onSnapshot(getColl('pengaturan_denda'), (snap) => {
                if(snap.empty && pengaturanDenda.length === 0) {
                    [{ id: 1, tipe: 'Reguler', nominal: 10000 }, { id: 2, tipe: 'Janda', nominal: 5000 }].forEach(p => {
                        setDoc(doc(getColl('pengaturan_denda'), p.id.toString()), p);
                    });
                } else {
                    pengaturanDenda = snap.docs.map(d => d.data());
                    if(document.getElementById('modal-tipe') && !document.getElementById('modal-tipe').classList.contains('hidden')) renderTabelTipe();
                }
            }, (err) => console.error(err));

            onSnapshot(getColl('denda'), (snap) => {
                dataDenda = snap.docs.map(d => d.data());
                if(document.getElementById('page-keuangan') && document.getElementById('page-keuangan').classList.contains('active')) renderTabelDenda();
                updateDashboard();
                if(isFirstDenda) { isFirstDenda = false; cekSelesaiLoading(); }
            }, (err) => console.error(err));

            onSnapshot(getColl('mutasi'), (snap) => {
                // Gunakan setTimeout agar proses rendering data besar tidak memblokir UI thread secara bersamaan
                setTimeout(() => {
                    dataMutasi = snap.docs.map(d => d.data());
                    if(document.getElementById('page-kas-lainnya') && document.getElementById('page-kas-lainnya').classList.contains('active')) renderTabelKasLainnya();
                    if(document.getElementById('page-realisasi') && document.getElementById('page-realisasi').classList.contains('active')) renderRealisasi();
                    if(document.getElementById('page-riwayat-kas') && document.getElementById('page-riwayat-kas').classList.contains('active')) renderRiwayatKas();
                    updateDashboard();
                    if(isFirstMutasi) { isFirstMutasi = false; cekSelesaiLoading(); }
                }, 0);
            }, (err) => console.error(err));

            onSnapshot(getColl('presensi'), (snap) => {
                setTimeout(() => {
                    dataPresensi = {};
                    snap.docs.forEach(d => { dataPresensi[d.id] = d.data(); });
                    
                    // Render ulang dashboard langsung setelah data presensi masuk
                    if(document.getElementById('page-dashboard') && document.getElementById('page-dashboard').classList.contains('active')) {
                        renderDashboardPresensi();
                    }

                    if(document.getElementById('page-presensi') && document.getElementById('page-presensi').classList.contains('active')) loadPresensi();
                    
                    // Segarkan pop-up riwayat kehadiran secara otomatis jika terbuka
                    if (currentModalDateStr && !document.getElementById('modal-detail-presensi').classList.contains('hidden')) {
                        bukaDetailPresensi(currentModalDateStr);
                    }
                    if(isFirstPresensi) { isFirstPresensi = false; cekSelesaiLoading(); }
                }, 0);
            }, (err) => console.error(err));

            onSnapshot(getColl('rencana'), (snap) => {
                if(snap.empty && dataRencana.length === 0) {
                    const defaultRencana = [{
                        id: 1, judul: 'Program "Kebonagung Bercahaya" (Penerangan Jalan)', status: 'Direncanakan',
                        deskripsi: 'Sejalan dengan visi Desa Jatinegara untuk mewujudkan lingkungan yang terang dan aman di malam hari...',
                        tanggal: new Date().toLocaleDateString('id-ID')
                    }];
                    defaultRencana.forEach(r => setDoc(doc(getColl('rencana'), r.id.toString()), r));
                } else {
                    dataRencana = snap.docs.map(d => d.data());
                    if(document.getElementById('page-aspirasi') && document.getElementById('page-aspirasi').classList.contains('active')) renderRencana();
                }
            }, (err) => console.error(err));

            onSnapshot(getColl('aspirasi'), (snap) => {
                dataAspirasi = snap.docs.map(d => d.data());
                if(document.getElementById('page-aspirasi') && document.getElementById('page-aspirasi').classList.contains('active')) renderAspirasi();
            }, (err) => console.error(err));
        }

        // --- SISTEM ROLE UI ---
        function terapkanRoleUI() {
            const badge = document.getElementById('badge-role');
            const navBadge = document.getElementById('nav-role-badge');
            const formKas = document.getElementById('form-kas-lainnya');
            const waContainer = document.getElementById('btn-wa-container');
            
            if(!badge || !navBadge) return; 

            if (userRole === 'warga') {
                if(document.getElementById('tab-presensi')) document.getElementById('tab-presensi').style.display = 'none';
                if(document.getElementById('btn-tambah-warga')) document.getElementById('btn-tambah-warga').style.display = 'none';
                if(document.getElementById('btn-kelola-tipe')) document.getElementById('btn-kelola-tipe').style.display = 'none';
                if(document.getElementById('btn-tambah-realisasi')) document.getElementById('btn-tambah-realisasi').style.display = 'none';
                if(document.getElementById('btn-tambah-rencana')) document.getElementById('btn-tambah-rencana').style.display = 'none';
                if(document.getElementById('btn-catat-presensi')) document.getElementById('btn-catat-presensi').style.display = 'none';
                if(formKas) formKas.classList.add('hidden');
                if(waContainer) waContainer.style.display = 'flex'; // Tampilkan icon WA untuk Warga
                
                badge.innerText = "Mode Warga (Hanya Baca)";
                badge.className = "bg-green-100 text-green-800 text-[10px] sm:text-xs font-semibold px-2 sm:px-2.5 py-0.5 rounded border border-green-400";
                navBadge.innerText = "WARGA";
                navBadge.className = "bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm border border-green-600";
                
                if(document.getElementById('page-presensi') && document.getElementById('page-presensi').classList.contains('active')) switchTab('dashboard');
            } else {
                if(document.getElementById('tab-presensi')) document.getElementById('tab-presensi').style.display = 'flex';
                if(document.getElementById('btn-tambah-warga')) document.getElementById('btn-tambah-warga').style.display = 'inline-flex';
                if(document.getElementById('btn-kelola-tipe')) document.getElementById('btn-kelola-tipe').style.display = 'inline-flex';
                if(document.getElementById('btn-tambah-realisasi')) document.getElementById('btn-tambah-realisasi').style.display = 'inline-flex';
                if(document.getElementById('btn-tambah-rencana')) document.getElementById('btn-tambah-rencana').style.display = 'inline-flex';
                if(document.getElementById('btn-catat-presensi')) document.getElementById('btn-catat-presensi').style.display = 'inline-block';
                if(formKas) formKas.classList.remove('hidden');
                if(waContainer) waContainer.style.display = 'none'; // Sembunyikan icon WA untuk Admin
                
                badge.innerText = "Mode Admin (Akses Penuh)";
                badge.className = "bg-blue-100 text-blue-800 text-[10px] sm:text-xs font-semibold px-2 sm:px-2.5 py-0.5 rounded border border-blue-400";
                navBadge.innerText = "ADMIN";
                navBadge.className = "bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm border border-red-600 animate-pulse";
            }
            
            if(document.getElementById('page-warga') && document.getElementById('page-warga').classList.contains('active')) renderTabelWarga();
            if(document.getElementById('page-keuangan') && document.getElementById('page-keuangan').classList.contains('active')) renderTabelDenda();
            if(document.getElementById('page-kas-lainnya') && document.getElementById('page-kas-lainnya').classList.contains('active')) renderTabelKasLainnya();
            if(document.getElementById('page-riwayat-kas') && document.getElementById('page-riwayat-kas').classList.contains('active')) renderRiwayatKas();
            if(document.getElementById('page-realisasi') && document.getElementById('page-realisasi').classList.contains('active')) renderRealisasi();
            if(document.getElementById('page-aspirasi') && document.getElementById('page-aspirasi').classList.contains('active')) { renderRencana(); renderAspirasi(); }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.page-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            const targetPage = document.getElementById(`page-${tabId}`);
            const targetTab = document.getElementById(`tab-${tabId}`);
            
            if(targetPage) targetPage.classList.add('active');
            if(targetTab) targetTab.classList.add('active');

            if(tabId === 'dashboard') updateDashboard();
            if(tabId === 'warga') renderTabelWarga();
            if(tabId === 'keuangan') renderTabelDenda();
            if(tabId === 'riwayat-kas') renderRiwayatKas();
            if(tabId === 'kas-lainnya') {
                renderTabelKasLainnya();
                const inputKasTgl = document.getElementById('input-kas-tgl');
                if (inputKasTgl) inputKasTgl.valueAsDate = new Date();
            }
            if(tabId === 'realisasi') renderRealisasi();
            if(tabId === 'aspirasi') { renderRencana(); renderAspirasi(); }
            if(tabId === 'presensi') {
                const inputTglPresensi = document.getElementById('input-tanggal-presensi');
                if(inputTglPresensi && !inputTglPresensi.value) {
                    inputTglPresensi.valueAsDate = new Date();
                }
                loadPresensi();
            }
        }

        function updateDashboard() {
            let piutang = dataDenda.filter(d => d.status === 'Belum Dibayar').reduce((sum, d) => sum + d.nominal, 0);
            const totalKas = hitungTotalKas();
            const dashKas = document.getElementById('dash-kas');
            
            if(dashKas) {
                dashKas.innerText = formatRp(totalKas);
                if(totalKas < 0) { dashKas.classList.remove('text-gray-800'); dashKas.classList.add('text-red-600'); } 
                else { dashKas.classList.remove('text-red-600'); dashKas.classList.add('text-gray-800'); }
            }

            const dashPiutang = document.getElementById('dash-piutang');
            if(dashPiutang) dashPiutang.innerText = formatRp(piutang);
            
            const dashWarga = document.getElementById('dash-warga');
            if(dashWarga) dashWarga.innerText = `${dataWarga.length} Orang`;

            renderDashboardPresensi();
        }

        // --- PRESENSI DASHBOARD ---
        function renderDashboardPresensi() {
            const wrapper = document.getElementById('wrapper-riwayat-presensi');
            const container = document.getElementById('dashboard-riwayat-presensi');
            if (!container || !wrapper) return;
            container.innerHTML = '';

            // Filter data kosong (hanya tampilkan yang ada isinya / fotonya)
            const validDates = Object.keys(dataPresensi).filter(date => {
                const records = dataPresensi[date];
                if (!records) return false;
                const keys = Object.keys(records);
                const hasPresensi = keys.some(k => k !== 'bukti_foto' && records[k] !== 'Belum' && records[k] !== null);
                const hasFoto = records.bukti_foto && records.bukti_foto.length > 0;
                return hasPresensi || hasFoto;
            }).sort((a, b) => b.localeCompare(a)); // Urut sesuai tanggal dari atas ke bawah (terbaru di atas)

            if (validDates.length === 0) {
                wrapper.classList.add('hidden');
                return;
            } else {
                wrapper.classList.remove('hidden');
            }

            // Ambil maksimal 7 riwayat terbaru
            const recentDates = validDates.slice(0, 7);

            recentDates.forEach(date => {
                let stringTanggal = date;
                let adaFoto = false;
                try {
                    const dateObj = new Date(date);
                    if (!isNaN(dateObj.getTime())) {
                        const namaHariStr = namaHari[dateObj.getDay()];
                        stringTanggal = `${namaHariStr}, ${dateObj.toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}`;
                    }
                    if (dataPresensi[date] && dataPresensi[date].bukti_foto && dataPresensi[date].bukti_foto.length > 0) {
                        adaFoto = true;
                    }
                } catch(e) {}

                // Membuat desain list vertikal
                container.innerHTML += `
                    <button onclick="bukaDetailPresensi('${date}')" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-800 border border-indigo-200 px-3 sm:px-4 py-3 rounded-lg text-xs sm:text-sm font-bold transition shadow-sm flex items-center justify-between w-full text-left group">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="bg-white rounded-full shadow-sm text-indigo-500 w-8 h-8 flex items-center justify-center shrink-0 group-hover:scale-110 transition">
                                <i class="fa-solid fa-calendar-check"></i>
                            </div>
                            <span class="truncate">${stringTanggal}</span>
                        </div>
                        ${adaFoto ? '<span class="bg-blue-500 text-white text-[9px] sm:text-[10px] px-2 py-1.5 rounded-md flex items-center gap-1.5 shadow-sm shrink-0 ml-2"><i class="fa-solid fa-image"></i> <span class="hidden sm:inline">Ada Foto</span></span>' : '<i class="fa-solid fa-chevron-right text-indigo-300 shrink-0 ml-2"></i>'}
                    </button>
                `;
            });
        }

        function bukaDetailPresensi(dateStr) {
            currentModalDateStr = dateStr;
            const records = dataPresensi[dateStr];
            let stringTanggal = dateStr;
            let hariStr = '';
            
            try {
                const dateObj = new Date(dateStr);
                if (!isNaN(dateObj.getTime())) {
                    stringTanggal = dateObj.toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
                    hariStr = namaHari[dateObj.getDay()];
                }
            } catch(e) {}

            document.getElementById('detail-presensi-tgl').innerText = `${hariStr}, ${stringTanggal}`;
            
            let hadirList = [];
            let tidakHadirList = []; 

            // Cek jadwal warga pada hari tersebut
            const wargaRegu = dataWarga.filter(w => w.jadwal === hariStr);
            
            wargaRegu.forEach(w => {
                const status = records && records[w.id] && records[w.id] !== 'Belum' ? records[w.id] : 'Belum';
                
                let actionBtns = '';
                // Jika Admin, munculkan tombol inline untuk merubah atau menghapus status langsung dari list
                if (userRole === 'admin') {
                    actionBtns = `
                        <div class="flex gap-1 ml-2 shrink-0">
                            ${status !== 'Hadir' ? `<button onclick="setPresensi('${dateStr}', ${w.id}, 'Hadir')" class="w-6 h-6 sm:w-7 sm:h-7 rounded bg-green-50 border border-green-200 text-green-600 hover:bg-green-500 hover:text-white transition flex items-center justify-center text-[10px] sm:text-xs shadow-sm" title="Ubah ke Hadir"><i class="fa-solid fa-check"></i></button>` : ''}
                            ${status !== 'Izin' ? `<button onclick="setPresensi('${dateStr}', ${w.id}, 'Izin')" class="w-6 h-6 sm:w-7 sm:h-7 rounded bg-yellow-50 border border-yellow-200 text-yellow-600 hover:bg-yellow-500 hover:text-white transition flex items-center justify-center text-[10px] sm:text-xs shadow-sm" title="Ubah ke Izin"><i class="fa-solid fa-envelope"></i></button>` : ''}
                            ${status !== 'Absen' ? `<button onclick="setPresensi('${dateStr}', ${w.id}, 'Absen')" class="w-6 h-6 sm:w-7 sm:h-7 rounded bg-red-50 border border-red-200 text-red-600 hover:bg-red-500 hover:text-white transition flex items-center justify-center text-[10px] sm:text-xs shadow-sm" title="Ubah ke Absen"><i class="fa-solid fa-times"></i></button>` : ''}
                            <button onclick="hapusPresensiWarga('${dateStr}', ${w.id})" class="w-6 h-6 sm:w-7 sm:h-7 rounded bg-gray-100 border border-gray-200 text-gray-500 hover:bg-gray-500 hover:text-white transition flex items-center justify-center text-[10px] sm:text-xs shadow-sm ml-1" title="Hapus/Reset Data"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                }

                if (status === 'Hadir') {
                    hadirList.push(`<li class="text-sm font-medium text-gray-800 flex items-center justify-between border-b border-gray-100 pb-1.5 pt-1"><div class="flex items-center min-w-0 pr-2"><i class="fa-solid fa-user text-gray-300 text-xs mr-2 w-3 shrink-0"></i><span class="truncate">${w.nama}</span></div> ${actionBtns}</li>`);
                } else if (status === 'Izin' || status === 'Absen') {
                    tidakHadirList.push(`<li class="text-sm font-medium text-gray-800 flex items-center justify-between border-b border-gray-100 pb-1.5 pt-1"><div class="flex items-center min-w-0 pr-2"><i class="fa-solid fa-user text-gray-300 text-xs mr-2 w-3 shrink-0"></i><span class="truncate">${w.nama}</span> <span class="text-[9px] bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded ml-2 tracking-widest uppercase shrink-0">${status}</span></div> ${actionBtns}</li>`);
                }
            });

            document.getElementById('list-detail-hadir').innerHTML = hadirList.length > 0 
                ? hadirList.join('') 
                : '<li class="text-xs text-gray-400 italic py-1">Tidak ada/Belum didata</li>';
                
            document.getElementById('list-detail-tidakhadir').innerHTML = tidakHadirList.length > 0 
                ? tidakHadirList.join('') 
                : '<li class="text-xs text-gray-400 italic py-1">Tidak ada/Semua Hadir</li>';

            // Atur Tampilan Upload Gambar Berdasarkan Role
            const adminUploadDiv = document.getElementById('admin-upload-presensi');
            if (userRole === 'admin') {
                adminUploadDiv.classList.remove('hidden');
            } else {
                adminUploadDiv.classList.add('hidden');
            }

            renderBuktiPresensi(dateStr);
            document.getElementById('modal-detail-presensi').classList.remove('hidden');
        }

        function renderBuktiPresensi(tgl) {
            const container = document.getElementById('container-bukti-presensi');
            const records = dataPresensi[tgl] || {};
            const fotos = records.bukti_foto || [];

            if (fotos.length > 0) {
                container.innerHTML = fotos.map((src, idx) => `
                    <div class="relative group mt-1">
                        <img src="${src}" class="w-16 h-16 sm:w-20 sm:h-20 object-cover rounded-lg border border-gray-300 shadow-sm cursor-pointer hover:opacity-80 transition" onclick="bukaLightbox('${src}')">
                        ${userRole === 'admin' ? `<button onclick="hapusBuktiPresensi('${tgl}', ${idx})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] sm:opacity-0 group-hover:opacity-100 transition shadow"><i class="fa-solid fa-times"></i></button>` : ''}
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<span class="text-xs text-gray-400 italic">Belum ada foto bukti.</span>';
            }
        }

        async function prosesUploadBuktiPresensi(input) {
            if(!input.files || input.files.length === 0) return;
            const tgl = currentModalDateStr;
            if(!tgl) return;

            const loadingStr = document.getElementById('loading-upload-presensi');
            loadingStr.classList.remove('hidden');
            input.disabled = true;

            try {
                // Konversi gambar yang diupload ke Base64 (menggunakan fungsi processFilesToBase64 yang sudah ada)
                const base64Baru = await processFilesToBase64(input.files);
                const records = dataPresensi[tgl] || {};
                const existingFotos = records.bukti_foto || [];
                const updatedFotos = existingFotos.concat(base64Baru);

                // Update ke Firebase khusus untuk tanggal ini
                await setDoc(doc(getColl('presensi'), tgl), { bukti_foto: updatedFotos }, { merge: true });
                showToast('Foto bukti kegiatan berhasil ditambahkan.');
            } catch (e) {
                showDialog('alert', 'Error', 'Gagal memproses gambar. Pastikan ukuran file tidak terlalu besar.');
            } finally {
                loadingStr.classList.add('hidden');
                input.disabled = false;
                input.value = '';
            }
        }

        function hapusBuktiPresensi(tgl, idx) {
            showDialog('confirm', 'Hapus Foto', 'Yakin ingin menghapus foto bukti ini?', () => {
                const records = dataPresensi[tgl] || {};
                let fotos = records.bukti_foto || [];
                fotos.splice(idx, 1);
                
                setDoc(doc(getColl('presensi'), tgl), { bukti_foto: fotos }, { merge: true }).then(() => {
                    showToast('Foto bukti berhasil dihapus.');
                });
            });
        }

        function tutupDetailPresensi() {
            currentModalDateStr = '';
            document.getElementById('modal-detail-presensi').classList.add('hidden');
        }
        
        function hapusPresensiWarga(tgl, wargaId) {
            showDialog('confirm', 'Hapus Data Kehadiran', 'Hapus riwayat presensi warga ini? (Denda akan otomatis dibatalkan jika sebelumnya status adalah Absen)', () => {
                setPresensi(tgl, wargaId, 'Hapus');
            });
        }

        // --- PRESENSI ---
        function loadPresensi() {
            const tglInput = document.getElementById('input-tanggal-presensi');
            if(!tglInput || !tglInput.value) return;
            const dateObj = new Date(tglInput.value);
            const hariIni = namaHari[dateObj.getDay()];
            const hariPresensi = document.getElementById('input-hari-presensi');
            if(hariPresensi) hariPresensi.value = hariIni;
            renderTabelPresensi(hariIni, tglInput.value);
        }

        function renderTabelPresensi(hari, tanggalStr) {
            const container = document.getElementById('container-presensi');
            const msgKosong = document.getElementById('pesan-kosong-presensi');
            if(!container || !msgKosong) return;

            container.innerHTML = '';
            const wargaRegu = dataWarga.filter(w => w.jadwal === hari);

            if(wargaRegu.length === 0) {
                container.parentNode.classList.add('hidden');
                msgKosong.classList.remove('hidden'); return;
            }

            container.parentNode.classList.remove('hidden');
            msgKosong.classList.add('hidden');

            wargaRegu.forEach(w => {
                const status = (dataPresensi[tanggalStr] && dataPresensi[tanggalStr][w.id]) ? dataPresensi[tanggalStr][w.id] : 'Belum';
                let badgeClass = 'bg-gray-100 text-gray-800 border-gray-200';
                if(status === 'Hadir') badgeClass = 'bg-green-100 text-green-800 border-green-200';
                if(status === 'Absen') badgeClass = 'bg-red-100 text-red-800 border-red-200';
                if(status === 'Izin') badgeClass = 'bg-yellow-100 text-yellow-800 border-yellow-200';

                container.innerHTML += `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 sm:p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 transition hover:shadow-md">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1.5">
                                <h4 class="font-bold text-gray-800 text-sm truncate">${w.nama}</h4>
                                <span class="px-2 py-0.5 inline-flex text-[10px] font-bold rounded-full bg-blue-50 text-blue-700 shrink-0 border border-blue-100">${w.tipe}</span>
                            </div>
                            ${status !== 'Belum' ? `<span class="px-2 py-0.5 text-[10px] rounded border ${badgeClass} font-bold inline-block uppercase tracking-wider">Status: ${status}</span>` : '<span class="text-[10px] text-gray-400 italic bg-gray-50 px-2 py-0.5 rounded border border-gray-100">Belum diproses</span>'}
                        </div>
                        <div class="flex flex-wrap items-center gap-2 w-full sm:w-auto mt-1 sm:mt-0 pt-3 sm:pt-0 border-t sm:border-0 border-gray-100">
                            <button onclick="setPresensi('${tanggalStr}', ${w.id}, 'Hadir')" class="flex-1 sm:flex-none px-3 py-2 bg-green-50 text-green-600 hover:bg-green-500 hover:text-white border border-green-200 hover:border-green-500 rounded text-xs transition shadow-sm font-bold flex items-center justify-center gap-1.5"><i class="fa-solid fa-check"></i> Hadir</button>
                            <button onclick="setPresensi('${tanggalStr}', ${w.id}, 'Izin')" class="flex-1 sm:flex-none px-3 py-2 bg-yellow-50 text-yellow-600 hover:bg-yellow-500 hover:text-white border border-yellow-200 hover:border-yellow-500 rounded text-xs transition shadow-sm font-bold flex items-center justify-center gap-1.5"><i class="fa-solid fa-envelope"></i> Izin</button>
                            <button onclick="setPresensi('${tanggalStr}', ${w.id}, 'Absen')" class="flex-1 sm:flex-none px-3 py-2 bg-red-50 text-red-600 hover:bg-red-500 hover:text-white border border-red-200 hover:border-red-500 rounded text-xs transition shadow-sm font-bold flex items-center justify-center gap-1.5"><i class="fa-solid fa-times"></i> Absen</button>
                        </div>
                    </div>
                `;
            });
        }

        function setPresensi(tgl, wargaId, status) {
            if(userRole !== 'admin') return;
            const prevStatus = (dataPresensi[tgl] && dataPresensi[tgl][wargaId]) ? dataPresensi[tgl][wargaId] : 'Belum';
            const warga = dataWarga.find(w => w.id === wargaId);
            
            let updatePayload = {};
            if (status === 'Hapus') {
                updatePayload[wargaId] = deleteField();
            } else {
                updatePayload[wargaId] = status;
            }

            setDoc(doc(getColl('presensi'), tgl), updatePayload, { merge: true });
            
            if(status === 'Absen' && prevStatus !== 'Absen') {
                const nominal = getNominalDenda(warga.tipe);
                if(nominal > 0) {
                    const idDenda = Date.now();
                    setDoc(doc(getColl('denda'), idDenda.toString()), {
                        id: idDenda, wargaId: warga.id, namaWarga: warga.nama,
                        tanggal: tgl, nominal: nominal, status: 'Belum Dibayar',
                        keterangan: `Tidak berangkat (${tgl})`
                    });
                }
            } else if (prevStatus === 'Absen' && status !== 'Absen') {
                const denda = dataDenda.find(d => d.wargaId === wargaId && d.tanggal === tgl && d.status === 'Belum Dibayar');
                if(denda) {
                    deleteDoc(doc(getColl('denda'), denda.id.toString()));
                }
            }
            showToast(`Status ${warga.nama} ${status === 'Hapus' ? 'berhasil dihapus.' : 'diubah: ' + status}`);
        }

        // --- WARGA ---
        function renderTabelWarga() {
            const container = document.getElementById('container-warga');
            if(!container) return;
            container.innerHTML = '';
            
            const grouped = {};
            const urutanHari = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
            const todayIndex = new Date().getDay();
            const activeHariIndex = (todayIndex + 1) % 7; 
            const activeScheduleHari = namaHari[activeHariIndex];
            
            urutanHari.forEach(h => grouped[h] = []);
            dataWarga.forEach(w => { if(grouped[w.jadwal]) grouped[w.jadwal].push(w); });

            // Tema Warna Unik untuk Setiap Hari
            const colors = {
                'Senin': { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-800', badge: 'bg-blue-200 text-blue-800' },
                'Selasa': { bg: 'bg-pink-50', border: 'border-pink-200', text: 'text-pink-800', badge: 'bg-pink-200 text-pink-800' },
                'Rabu': { bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-800', badge: 'bg-emerald-200 text-emerald-800' },
                'Kamis': { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-800', badge: 'bg-amber-200 text-amber-800' },
                'Jumat': { bg: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-800', badge: 'bg-purple-200 text-purple-800' },
                'Sabtu': { bg: 'bg-cyan-50', border: 'border-cyan-200', text: 'text-cyan-800', badge: 'bg-cyan-200 text-cyan-800' },
                'Minggu': { bg: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-800', badge: 'bg-rose-200 text-rose-800' }
            };

            urutanHari.forEach(hari => {
                if(grouped[hari].length === 0) return;
                const c = colors[hari];

                let listHtml = grouped[hari].map((w, index) => {
                    let actionBtns = '';
                    if (userRole === 'admin') {
                        actionBtns = `
                            <div class="flex gap-2 items-center ml-2 shrink-0">
                                <button onclick="editWarga(${w.id}, event)" class="text-blue-400 hover:text-blue-600 transition p-1 bg-white rounded shadow-sm border border-gray-100" title="Edit Warga"><i class="fa-solid fa-pen text-[9px] sm:text-[10px]"></i></button>
                                <button onclick="hapusWarga(${w.id})" class="text-red-400 hover:text-red-600 transition p-1 bg-white rounded shadow-sm border border-gray-100" title="Hapus Warga"><i class="fa-solid fa-trash text-[9px] sm:text-[10px]"></i></button>
                            </div>
                        `;
                    }
                    return `
                    <div class="flex flex-col py-2 border-b border-black/5 last:border-0 hover:bg-black/5 transition px-1.5 rounded min-w-0">
                        <div class="flex justify-between items-center w-full min-w-0">
                            <p class="font-bold text-gray-800 text-[10px] sm:text-xs truncate w-full pr-1">${index + 1}. ${w.nama}</p>
                            ${actionBtns}
                        </div>
                        <div class="flex justify-between items-center mt-0.5">
                            <span class="text-[8px] sm:text-[9px] ${c.text} opacity-80 inline-block uppercase tracking-wider font-bold truncate">${w.tipe}</span>
                            ${w.wa ? `<span class="text-[8px] sm:text-[9px] text-green-600 font-bold bg-green-50 px-1 rounded truncate ml-1"><i class="fa-brands fa-whatsapp"></i> Aktif</span>` : ''}
                        </div>
                    </div>
                `}).join('');

                const isActive = hari === activeScheduleHari;
                const cardClass = `${c.bg} rounded-xl shadow-sm border ${isActive ? 'border-orange-400 ring-2 ring-orange-200' : c.border} p-2 sm:p-4 transition relative overflow-hidden`;
                const activeBadge = isActive ? `<span class="absolute top-0 right-0 bg-orange-500 text-white text-[7px] sm:text-[9px] font-bold px-1.5 py-0.5 rounded-bl-lg shadow-sm">HARI INI</span>` : "";

                container.innerHTML += `
                    <div class="${cardClass}">
                        ${activeBadge}
                        <div class="border-b border-black/10 pb-1.5 sm:pb-2 mb-1.5 sm:mb-2 text-center sm:text-left flex flex-col sm:flex-row sm:items-center justify-between gap-1">
                            <h3 class="font-extrabold ${c.text} text-[11px] sm:text-sm uppercase tracking-wider">
                                ${hari}
                            </h3>
                            <span class="${c.badge} px-1.5 py-0.5 rounded text-[7px] sm:text-[9px] font-bold inline-block mx-auto sm:mx-0 shadow-sm whitespace-nowrap">${grouped[hari].length} org</span>
                        </div>
                        <div class="flex flex-col mt-1">${listHtml}</div>
                    </div>
                `;
            });
        }

        function bukaModalWarga() { 
            document.getElementById('form-id-warga').value = '';
            const sel = document.getElementById('form-tipe');
            if(sel) sel.innerHTML = pengaturanDenda.map(p => `<option value="${p.tipe}">${p.tipe}</option>`).join('');
            document.getElementById('form-nama').value = '';
            document.getElementById('form-wa').value = '';
            document.getElementById('modal-warga-title').innerText = 'Tambah Warga Baru';
            document.getElementById('modal-warga').classList.remove('hidden'); 
        }
        function tutupModalWarga() { document.getElementById('modal-warga').classList.add('hidden'); }
        
        function editWarga(id, event) {
            if(event) event.stopPropagation();
            const w = dataWarga.find(x => x.id === id);
            if(w) {
                document.getElementById('form-id-warga').value = w.id;
                document.getElementById('form-nama').value = w.nama;
                const sel = document.getElementById('form-tipe');
                sel.innerHTML = pengaturanDenda.map(p => `<option value="${p.tipe}">${p.tipe}</option>`).join('');
                sel.value = w.tipe;
                document.getElementById('form-jadwal').value = w.jadwal;
                document.getElementById('form-wa').value = w.wa || '';
                document.getElementById('modal-warga-title').innerText = 'Edit Data Warga';
                document.getElementById('modal-warga').classList.remove('hidden');
            }
        }

        function simpanWarga() {
            const idForm = document.getElementById('form-id-warga').value;
            const nama = document.getElementById('form-nama').value.trim();
            const tipe = document.getElementById('form-tipe').value;
            const jadwal = document.getElementById('form-jadwal').value;
            const wa = document.getElementById('form-wa').value.trim();
            if(!nama) return showDialog('alert', 'Perhatian', 'Nama lengkap wajib diisi!');
            
            const payload = { nama, tipe, jadwal, wa };
            const id = idForm ? Number(idForm) : Date.now();
            if(!idForm) payload.id = id;

            setDoc(doc(getColl('warga'), id.toString()), payload, { merge: true }).then(() => {
                tutupModalWarga();
                showToast(`Data warga berhasil ${idForm ? 'diperbarui' : 'ditambahkan'}.`);
            });
        }

        function hapusWarga(id) {
            showDialog('confirm', 'Hapus Warga', 'Anda yakin ingin menghapus warga ini dari sistem?', () => {
                deleteDoc(doc(getColl('warga'), id.toString())).then(() => showToast('Warga berhasil dihapus.'));
            });
        }

        // --- PENGATURAN TIPE ---
        function bukaModalTipe() { document.getElementById('modal-tipe').classList.remove('hidden'); renderTabelTipe(); }
        function tutupModalTipe() { document.getElementById('modal-tipe').classList.add('hidden'); }
        
        function renderTabelTipe() {
            const container = document.getElementById('container-tipe-denda');
            if(!container) return;
            container.innerHTML = pengaturanDenda.map(p => `
                <div class="bg-white border border-gray-200 rounded-lg p-3 sm:p-4 flex justify-between items-center shadow-sm">
                    <div>
                        <p class="text-sm font-bold text-gray-800">${p.tipe}</p>
                        <p class="text-xs text-red-600 font-bold mt-0.5"><i class="fa-solid fa-coins text-[10px] mr-1"></i>${formatRp(p.nominal)}</p>
                    </div>
                    <button onclick="hapusTipe(${p.id})" class="bg-red-50 text-red-500 hover:bg-red-100 hover:text-red-700 rounded p-2.5 transition text-xs shadow-sm"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        }

        function tambahTipe() {
            const nama = document.getElementById('input-nama-tipe').value.trim();
            const nomInput = document.getElementById('input-nominal-tipe').value;
            const nom = parseInt(nomInput ? nomInput.replace(/\./g, '') : "0");
            
            if(nama && nom >= 0) {
                const id = Date.now();
                setDoc(doc(getColl('pengaturan_denda'), id.toString()), { id, tipe: nama, nominal: nom }).then(() => {
                    document.getElementById('input-nama-tipe').value = '';
                    document.getElementById('input-nominal-tipe').value = '';
                    showToast('Tipe warga ditambahkan.');
                });
            } else {
                showDialog('alert', 'Kesalahan Input', 'Nama dan nominal denda tidak valid!');
            }
        }

        function hapusTipe(id) {
            showDialog('confirm', 'Hapus Tipe Denda', 'Hapus tipe denda ini? Pastikan tidak ada warga yang masih menggunakan tipe ini.', () => {
                deleteDoc(doc(getColl('pengaturan_denda'), id.toString()));
            });
        }

        // --- TAGIHAN DENDA ---
        function renderTabelDenda() {
            const container = document.getElementById('container-denda');
            if(!container) return;
            container.innerHTML = '';
            
            const urutDenda = [...dataDenda].sort((a,b) => b.id - a.id);
            if(urutDenda.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 bg-white p-6 rounded-lg border border-gray-200 text-sm">Belum ada data tagihan denda.</div>`;
                return;
            }

            urutDenda.forEach(d => {
                const isLunas = d.status === 'Lunas';
                const actionAttr = (!isLunas && userRole === 'admin') ? `onclick="bayarDenda(${d.id})"` : '';
                const pointerCls = (!isLunas && userRole === 'admin') ? 'cursor-pointer hover:border-green-400 hover:shadow-md group' : '';
                
                const wargaData = dataWarga.find(w => w.id === d.wargaId);
                const noWA = wargaData && wargaData.wa ? formatNoWA(wargaData.wa) : '';

                let tagihBtn = '';
                if (userRole === 'admin' && !isLunas && noWA) {
                    const pesan = `Halo Bpk/Ibu ${d.namaWarga},%0A%0AMengingatkan bahwa terdapat tunggakan denda ronda sebesar *${formatRp(d.nominal)}* untuk tanggal ${d.tanggal} (${d.keterangan}).%0A%0AMohon agar segera diselesaikan. Terima kasih.%0A%0A- Pengurus RT 01`;
                    tagihBtn = `<a href="https://wa.me/${noWA}?text=${pesan}" target="_blank" onclick="event.stopPropagation()" class="text-[10px] bg-green-50 hover:bg-green-500 text-green-600 hover:text-white border border-green-200 hover:border-green-500 px-2.5 py-1.5 rounded transition shadow-sm font-bold inline-flex items-center group-hover:opacity-100 sm:opacity-50"><i class="fa-brands fa-whatsapp mr-1 text-sm"></i> Tagih</a>`;
                }

                container.innerHTML += `
                    <div class="bg-white rounded-lg shadow-sm border ${isLunas ? 'border-green-200 opacity-70' : 'border-red-200'} p-3 sm:p-4 flex flex-col sm:flex-row items-start sm:items-center justify-between transition ${pointerCls}" ${actionAttr}>
                        <div class="flex items-center gap-3 min-w-0 w-full sm:w-auto mb-3 sm:mb-0">
                            <div class="h-10 w-10 sm:h-12 sm:w-12 shrink-0 rounded-full flex items-center justify-center font-bold text-lg sm:text-xl ${isLunas ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600 group-hover:scale-110 transition'}">
                                <i class="fa-solid ${isLunas ? 'fa-check' : 'fa-file-invoice-dollar'}"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <h4 class="font-bold text-gray-800 text-sm sm:text-base leading-tight truncate">${d.namaWarga}</h4>
                                <p class="text-[10px] sm:text-xs text-gray-500 mt-1 truncate"><i class="fa-solid fa-calendar-day mr-1"></i> ${d.tanggal} &bull; ${d.keterangan}</p>
                            </div>
                        </div>
                        <div class="w-full sm:w-auto flex flex-row sm:flex-col items-center sm:items-end justify-between border-t sm:border-0 border-gray-100 pt-3 sm:pt-0 shrink-0 sm:ml-2 gap-2">
                            <div class="flex items-center gap-2 sm:hidden">
                                <p class="font-bold text-sm ${isLunas ? 'text-green-600' : 'text-red-600'}">${formatRp(d.nominal)}</p>
                            </div>
                            <div class="hidden sm:block text-right mb-1.5">
                                <p class="font-bold text-base ${isLunas ? 'text-green-600' : 'text-red-600'}">${formatRp(d.nominal)}</p>
                            </div>
                            <div class="flex items-center gap-1.5">
                                ${tagihBtn}
                                ${userRole === 'admin' ? `<button onclick="hapusDenda(${d.id}, event)" class="bg-red-50 hover:bg-red-500 text-red-500 hover:text-white px-2.5 py-1.5 rounded transition shadow-sm sm:opacity-50 group-hover:opacity-100" title="Hapus Denda"><i class="fa-solid fa-trash text-xs"></i></button>` : ''}
                                ${userRole === 'admin' && !isLunas ? `<span class="text-[10px] bg-blue-500 text-white px-3 py-1.5 rounded shadow-sm font-bold inline-block hover:bg-blue-600 transition cursor-pointer">Bayar <i class="fa-solid fa-chevron-right ml-1"></i></span>` : `<span class="text-[10px] font-bold uppercase ${isLunas ? 'text-green-500 bg-green-50 border border-green-100' : 'text-red-500 bg-red-50 border border-red-100'} px-2 py-0.5 rounded inline-block">${d.status}</span>`}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function hapusDenda(id, event) {
            if(event) event.stopPropagation(); // Mencegah klik card secara tidak sengaja
            showDialog('confirm', 'Hapus Tagihan Denda', 'Anda yakin ingin menghapus tagihan denda ini secara manual?', () => {
                deleteDoc(doc(getColl('denda'), id.toString())).then(() => {
                    showToast('Tagihan denda berhasil dihapus.');
                });
            });
        }

        function bayarDenda(id) {
            const denda = dataDenda.find(d => d.id === id);
            if(denda) {
                showDialog('confirm', 'Konfirmasi Pembayaran', `Proses pembayaran denda dari ${denda.namaWarga} sebesar ${formatRp(denda.nominal)}?`, () => {
                    setDoc(doc(getColl('denda'), denda.id.toString()), { ...denda, status: 'Lunas' });
                    
                    const today = new Date();
                    const formattedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                    const idMutasi = Date.now();
                    setDoc(doc(getColl('mutasi'), idMutasi.toString()), {
                        id: idMutasi, tanggal: formattedDate, jenis: 'Pemasukan',
                        nominal: denda.nominal, kategori: 'Denda',
                        keterangan: `Pembayaran Denda: ${denda.namaWarga} (${denda.tanggal})`
                    }).then(() => showToast('Pembayaran denda lunas & otomatis masuk ke Kas.'));
                });
            }
        }

        // --- HALAMAN RIWAYAT KAS (PENGGANTI POP-UP MODAL MUTASI) ---
        function renderRiwayatKas() {
            const container = document.getElementById('container-riwayat-kas');
            if(!container) return;
            container.innerHTML = '';
            
            const totalKas = hitungTotalKas();
            const halamanTotalKas = document.getElementById('halaman-total-kas');
            if(halamanTotalKas) {
                halamanTotalKas.innerText = formatRp(totalKas);
                if(totalKas < 0) { halamanTotalKas.classList.remove('text-green-600'); halamanTotalKas.classList.add('text-red-600'); } 
                else { halamanTotalKas.classList.remove('text-red-600'); halamanTotalKas.classList.add('text-green-600'); }
            }

            const mutasiUrut = [...dataMutasi].sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));
            if(mutasiUrut.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500 font-medium bg-white rounded-lg border border-gray-200">Belum ada riwayat kas yang tercatat.</div>`; return;
            }

            mutasiUrut.forEach(m => {
                const isMasuk = m.jenis === 'Pemasukan';
                let stringTanggal = m.tanggal;
                try {
                    const dateObj = new Date(m.tanggal);
                    if (!isNaN(dateObj.getTime())) { stringTanggal = `${namaHari[dateObj.getDay()]}, ${dateObj.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'})}`; }
                } catch(e) {}

                let btnAksi = '';
                if (!isMasuk) {
                    // Tombol Lihat Laporan untuk Pengeluaran
                    btnAksi = `<button onclick="switchTab('realisasi'); setTimeout(() => lihatRealisasi(${m.id}), 300)" class="text-[10px] sm:text-xs bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white px-3 py-1.5 rounded-lg border border-blue-200 hover:border-blue-600 font-bold transition shadow-sm flex items-center"><i class="fa-solid fa-eye mr-1.5"></i> Lihat Laporan</button>`;
                } else if (isMasuk && userRole === 'admin') {
                    // Tombol Revisi Hapus untuk Pemasukan (Admin Only)
                    btnAksi = `<button onclick="hapusRiwayatKas('${m.id}')" class="text-[10px] sm:text-xs bg-red-50 text-red-600 hover:bg-red-600 hover:text-white px-3 py-1.5 rounded-lg border border-red-200 hover:border-red-600 font-bold transition shadow-sm flex items-center"><i class="fa-solid fa-trash mr-1.5"></i> Revisi Hapus</button>`;
                }

                container.innerHTML += `
                    <div class="bg-white border ${isMasuk ? 'border-green-200' : 'border-red-200'} rounded-xl p-3 sm:p-4 shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 hover:shadow-md transition">
                        <div class="w-full sm:w-auto min-w-0">
                            <div class="flex items-center gap-2 mb-1.5">
                                <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-[10px] font-bold border border-gray-200 whitespace-nowrap"><i class="fa-solid fa-calendar-day mr-1"></i> ${stringTanggal}</span>
                                <span class="px-2 py-1 inline-flex text-[10px] leading-tight font-bold rounded-full border ${isMasuk ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'} whitespace-nowrap">
                                    ${isMasuk ? '<i class="fa-solid fa-arrow-down mr-1"></i> Masuk' : '<i class="fa-solid fa-arrow-up mr-1"></i> Keluar'}
                                </span>
                            </div>
                            <p class="text-xs sm:text-sm text-gray-800 font-medium break-words whitespace-normal leading-snug">${m.keterangan}</p>
                        </div>
                        <div class="flex flex-row sm:flex-col items-center sm:items-end justify-between w-full sm:w-auto mt-1 sm:mt-0 pt-3 sm:pt-0 border-t sm:border-0 border-gray-100 shrink-0 gap-2">
                            <p class="font-bold text-sm sm:text-base ${isMasuk ? 'text-green-600' : 'text-red-600'}">${isMasuk ? '+' : '-'}${formatRp(m.nominal)}</p>
                            ${btnAksi}
                        </div>
                    </div>
                `;
            });
        }

        function hapusRiwayatKas(id) {
            showDialog('confirm', 'Revisi Hapus Pemasukan', 'Yakin ingin menghapus riwayat pemasukan ini? Saldo total kas akan berkurang.', () => {
                deleteDoc(doc(getColl('mutasi'), id.toString())).then(() => {
                    showToast('Riwayat kas berhasil dihapus.');
                    // Realtime listener will auto-update the page, 
                    // but we can also force refresh just in case
                });
            });
        }

        // --- REALISASI ANGGARAN ---
        function renderRealisasi() {
            const container = document.getElementById('container-realisasi');
            if(!container) return;
            const pengeluaran = dataMutasi.filter(m => m.jenis === 'Pengeluaran').sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));

            if(pengeluaran.length === 0) {
                container.innerHTML = `<div class="col-span-full py-16 text-center bg-white rounded-lg shadow-sm border border-gray-200"><i class="fa-solid fa-folder-open text-gray-300 text-4xl sm:text-5xl mb-4"></i><p class="text-sm sm:text-base text-gray-500 font-medium">Belum ada catatan realisasi penggunaan dana kas.</p></div>`;
                return;
            }

            container.innerHTML = pengeluaran.map(p => {
                let fotoHtml = '';
                if (p.bukti && p.bukti.length > 0) {
                    let thumbs = p.bukti.map(src => `<img src="${src}" onclick="bukaLightbox('${src}')" class="w-16 h-16 sm:w-20 sm:h-20 object-cover rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:opacity-80 hover:scale-105 transition transform flex-shrink-0">`).join('');
                    fotoHtml = `<div class="mt-3 sm:mt-4"><p class="text-[10px] sm:text-[11px] font-bold text-gray-400 uppercase mb-1.5">Bukti Foto (${p.bukti.length}):</p><div class="flex gap-2 overflow-x-auto hide-scroll pb-2">${thumbs}</div></div>`;
                } else {
                    fotoHtml = `<div class="mt-3 sm:mt-4 text-xs text-gray-400 italic bg-gray-50 p-2 rounded border border-gray-100 inline-block"><i class="fa-solid fa-image-slash mr-1"></i> Tidak ada foto dilampirkan</div>`;
                }

                return `
                    <div id="realisasi-${p.id}" class="bg-white rounded-xl shadow-sm sm:shadow border border-gray-200 p-4 sm:p-5 hover:shadow-md transition flex flex-col justify-between duration-300">
                        <div>
                            <div class="flex justify-between items-start mb-3 gap-2">
                                <span class="bg-red-50 text-red-700 text-[10px] sm:text-xs font-bold px-2.5 py-1 rounded-md border border-red-100 shrink-0"><i class="fa-solid fa-calendar-day mr-1"></i> ${p.tanggal}</span>
                                <span class="font-bold text-red-600 text-base sm:text-lg tracking-tight whitespace-nowrap">- ${formatRp(p.nominal)}</span>
                            </div>
                            <p class="text-gray-800 font-medium text-sm sm:text-base leading-relaxed mt-2">${p.keterangan}</p>
                            <div class="border-t border-gray-100 mt-4 pt-1">${fotoHtml}</div>
                        </div>
                        ${userRole === 'admin' ? `
                        <div class="mt-4 pt-3 border-t border-dashed border-gray-200 flex justify-end gap-2">
                            <button onclick="editPengeluaran(${p.id})" class="text-xs text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-2 rounded-lg font-bold transition shadow-sm"><i class="fa-solid fa-pen mr-1"></i> Edit Laporan</button>
                            <button onclick="hapusPengeluaran(${p.id})" class="text-xs text-red-600 bg-red-50 hover:bg-red-100 px-3 py-2 rounded-lg font-bold transition shadow-sm"><i class="fa-solid fa-trash mr-1"></i> Hapus</button>
                        </div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function lihatRealisasi(id) {
            const el = document.getElementById(`realisasi-${id}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.classList.add('ring-4', 'ring-blue-400', 'scale-[1.02]', 'z-10');
                setTimeout(() => el.classList.remove('ring-4', 'ring-blue-400', 'scale-[1.02]', 'z-10'), 2000);
            } else {
                showToast('Data realisasi tidak ditemukan di halaman ini.');
            }
        }

        async function processFilesToBase64(files) {
            // Load logo watermark terlebih dahulu
            let logoImg = null;
            try {
                logoImg = new Image();
                logoImg.crossOrigin = "Anonymous";
                await new Promise((resolve, reject) => {
                    logoImg.onload = resolve;
                    logoImg.onerror = reject;
                    logoImg.src = "https://i.ibb.co.com/21BpG3JY/RT-01.png";
                });
            } catch (e) {
                console.warn("Gagal memuat watermark logo", e);
            }

            const promises = Array.from(files).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800; const MAX_HEIGHT = 800;
                            let width = img.width; let height = img.height;
                            
                            if (width > height) { 
                                if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } 
                            } else { 
                                if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } 
                            }
                            
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            
                            // 1. Gambar foto asli
                            ctx.drawImage(img, 0, 0, width, height);

                            // 2. Siapkan ukuran dan posisi teks tanggal di pojok kanan bawah
                            const now = new Date();
                            const dateStr = now.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) + " " + now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                            
                            const fontSize = Math.max(12, Math.floor(width * 0.035));
                            ctx.font = `bold ${fontSize}px sans-serif`;
                            const textWidth = ctx.measureText(dateStr).width;
                            const padding = fontSize * 0.5;
                            
                            const textX = width - textWidth - padding * 2 - 10;
                            const textY = height - fontSize - padding * 2 - 10;

                            // 3. Tambahkan Watermark Logo (Tidak Transparan, Di atas tanggal)
                            if (logoImg) {
                                ctx.save();
                                const logoSize = Math.max(50, Math.floor(width * 0.12)); // Ukuran proporsional sekitar 12% dari lebar gambar
                                const logoX = width - logoSize - 10; // Rata kanan (margin 10)
                                const logoY = textY - logoSize - 8; // 8px tepat di atas kotak teks tanggal
                                ctx.globalAlpha = 1.0; // Pastikan solid/tidak transparan
                                ctx.drawImage(logoImg, logoX, logoY, logoSize, logoSize);
                                ctx.restore();
                            }

                            // 4. Gambar background teks dan teks tanggal
                            ctx.save();
                            ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
                            ctx.fillRect(textX, textY, textWidth + padding * 2, fontSize + padding * 2);
                            
                            ctx.fillStyle = "white";
                            ctx.textAlign = "left";
                            ctx.textBaseline = "top";
                            ctx.font = `bold ${fontSize}px sans-serif`;
                            ctx.fillText(dateStr, textX + padding, textY + padding);
                            ctx.restore();

                            try {
                                resolve(canvas.toDataURL('image/jpeg', 0.8)); 
                            } catch (err) {
                                // Fallback darurat jika terkena policy CORS dari server gambar
                                console.warn("CORS taint pada canvas, menggunakan fallback tanpa logo", err);
                                const fallbackCanvas = document.createElement('canvas');
                                fallbackCanvas.width = width; fallbackCanvas.height = height;
                                const fCtx = fallbackCanvas.getContext('2d');
                                fCtx.drawImage(img, 0, 0, width, height);
                                
                                fCtx.fillStyle = "rgba(0, 0, 0, 0.6)";
                                fCtx.fillRect(textX, textY, textWidth + padding * 2, fontSize + padding * 2);
                                fCtx.fillStyle = "white"; fCtx.textAlign = "left"; fCtx.textBaseline = "top"; fCtx.font = `bold ${fontSize}px sans-serif`;
                                fCtx.fillText(dateStr, textX + padding, textY + padding);
                                
                                resolve(fallbackCanvas.toDataURL('image/jpeg', 0.8));
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            });
            return Promise.all(promises);
        }

        function renderPreviewBukti() {
            const container = document.getElementById('preview-bukti-container');
            const btnClear = document.getElementById('btn-clear-bukti');
            if(!container || !btnClear) return;

            if(tempBuktiBase64.length > 0) {
                container.innerHTML = tempBuktiBase64.map((src, index) => `
                    <div class="relative group mt-1">
                        <img src="${src}" class="w-14 h-14 sm:w-16 sm:h-16 object-cover rounded-lg border border-gray-300 shadow-sm cursor-pointer" onclick="bukaLightbox('${src}')">
                        <button onclick="hapusSatuBukti(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] sm:opacity-0 group-hover:opacity-100 transition shadow"><i class="fa-solid fa-times"></i></button>
                    </div>
                `).join('');
                btnClear.classList.remove('hidden');
            } else {
                container.innerHTML = '<span class="text-xs text-gray-400 italic">Belum ada foto</span>';
                btnClear.classList.add('hidden');
            }
        }

        function hapusSatuBukti(index) { tempBuktiBase64.splice(index, 1); renderPreviewBukti(); }
        function clearBukti() { tempBuktiBase64 = []; document.getElementById('form-pengeluaran-bukti').value = ''; renderPreviewBukti(); }

        async function previewBukti(input) {
            const container = document.getElementById('preview-bukti-container');
            const btnSimpan = document.getElementById('btn-simpan-pengeluaran');
            if(input.files && input.files.length > 0) {
                if(tempBuktiBase64.length === 0) container.innerHTML = '';
                container.insertAdjacentHTML('beforeend', '<span id="loading-img" class="text-xs text-blue-500 font-bold animate-pulse mt-2"><i class="fa-solid fa-spinner fa-spin mr-1"></i> Memproses...</span>');
                btnSimpan.disabled = true; btnSimpan.classList.add('opacity-50', 'cursor-not-allowed');

                try {
                    const base64Baru = await processFilesToBase64(input.files);
                    tempBuktiBase64 = tempBuktiBase64.concat(base64Baru);
                    renderPreviewBukti();
                } catch (e) {
                    showDialog('alert', 'Error', 'Gagal memproses gambar.');
                    renderPreviewBukti();
                } finally {
                    btnSimpan.disabled = false; btnSimpan.classList.remove('opacity-50', 'cursor-not-allowed');
                    input.value = '';
                }
            }
        }

        function editPengeluaran(id) {
            const m = dataMutasi.find(x => x.id === id);
            if(m) {
                document.getElementById('form-pengeluaran-id').value = m.id;
                document.getElementById('form-pengeluaran-tgl').value = m.tanggal;
                document.getElementById('form-pengeluaran-nominal').value = m.nominal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                document.getElementById('form-pengeluaran-ket').value = m.keterangan;
                document.getElementById('modal-pengeluaran-title').innerHTML = '<i class="fa-solid fa-pen-to-square mr-2"></i>Edit Laporan Realisasi';
                tempBuktiBase64 = m.bukti ? [...m.bukti] : [];
                renderPreviewBukti();
                document.getElementById('modal-pengeluaran').classList.remove('hidden');
            }
        }

        function bukaModalPengeluaran() {
            document.getElementById('form-pengeluaran-id').value = '';
            document.getElementById('modal-pengeluaran-title').innerHTML = '<i class="fa-solid fa-money-check-dollar mr-2"></i>Catat Realisasi Pengeluaran';
            document.getElementById('modal-pengeluaran').classList.remove('hidden');
            document.getElementById('form-pengeluaran-tgl').valueAsDate = new Date();
            document.getElementById('form-pengeluaran-nominal').value = '';
            document.getElementById('form-pengeluaran-ket').value = '';
            document.getElementById('form-pengeluaran-bukti').value = '';
            tempBuktiBase64 = []; renderPreviewBukti();
        }
        function tutupModalPengeluaran() { document.getElementById('modal-pengeluaran').classList.add('hidden'); }
        
        function simpanPengeluaran() {
            const idForm = document.getElementById('form-pengeluaran-id').value;
            const tgl = document.getElementById('form-pengeluaran-tgl').value;
            const nominalInput = document.getElementById('form-pengeluaran-nominal').value;
            const nominal = parseInt(nominalInput ? nominalInput.replace(/\./g, '') : "0");
            const ket = document.getElementById('form-pengeluaran-ket').value.trim();
            
            if(!tgl || !nominal || isNaN(nominal) || nominal <= 0 || !ket) return showDialog('alert', 'Kesalahan Input', 'Harap isi semua kolom dengan benar!');

            const payload = { tanggal: tgl, jenis: 'Pengeluaran', nominal: nominal, keterangan: ket, bukti: tempBuktiBase64 };
            const docId = idForm ? idForm : Date.now().toString();
            if(!idForm) payload.id = Number(docId);

            setDoc(doc(getColl('mutasi'), docId), payload, { merge: true }).then(() => {
                tutupModalPengeluaran();
                showToast('Laporan pengeluaran berhasil disimpan!');
            });
        }

        function hapusPengeluaran(id) {
            showDialog('confirm', 'Hapus Catatan Laporan', 'Yakin ingin menghapus catatan pengeluaran ini? Saldo kas akan bertambah kembali.', () => {
                deleteDoc(doc(getColl('mutasi'), id.toString())).then(() => showToast('Catatan pengeluaran dihapus.'));
            });
        }

        function bukaLightbox(src) {
            const lightboxImg = document.getElementById('lightbox-img');
            if(lightboxImg) {
                lightboxImg.src = src;
                document.getElementById('modal-lightbox').classList.remove('hidden');
            }
        }
        function tutupLightbox() { document.getElementById('modal-lightbox').classList.add('hidden'); }

        // --- KAS LAINNYA ---
        function simpanKasLainnya() {
            if(userRole !== 'admin') return;
            const jenis = document.getElementById('input-kas-jenis').value;
            const tgl = document.getElementById('input-kas-tgl').value;
            const nominalInput = document.getElementById('input-kas-nominal').value;
            const nominal = parseInt(nominalInput ? nominalInput.replace(/\./g, '') : "0");
            const ket = document.getElementById('input-kas-ket').value.trim();

            if(!tgl || !nominal || isNaN(nominal) || nominal <= 0 || !ket) return showDialog('alert', 'Kesalahan Input', 'Mohon isi semua data dengan benar!');

            const id = Date.now();
            setDoc(doc(getColl('mutasi'), id.toString()), { id, tanggal: tgl, jenis, nominal, keterangan: ket, kategori: 'Lainnya' }).then(() => {
                document.getElementById('input-kas-nominal').value = '';
                document.getElementById('input-kas-ket').value = '';
                showToast('Transaksi kas manual dicatat!');
            });
        }

        function renderTabelKasLainnya() {
            const container = document.getElementById('container-kas-lainnya');
            if(!container) return;
            container.innerHTML = '';

            // Menampilkan SELURUH riwayat mutasi kas (Manual + Otomatis Denda/Realisasi)
            const dataLainnya = [...dataMutasi].sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));

            if(dataLainnya.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 bg-white p-6 rounded-lg border border-gray-200 text-sm">Belum ada riwayat transaksi kas.</div>`;
                return;
            }

            dataLainnya.forEach(m => {
                const isMasuk = m.jenis === 'Pemasukan';
                const isManual = m.kategori === 'Lainnya'; // Hanya transaksi manual yang bisa di-edit dari menu ini
                const actionAttr = (userRole === 'admin' && isManual) ? `onclick="editKasLainnya(${m.id})"` : '';
                const pointerCls = (userRole === 'admin' && isManual) ? 'cursor-pointer hover:border-blue-400 hover:shadow-md group' : '';

                container.innerHTML += `
                    <div class="bg-white rounded-lg shadow-sm border ${isMasuk ? 'border-green-200' : 'border-red-200'} p-3 sm:p-4 flex flex-col sm:flex-row items-start sm:items-center justify-between transition ${pointerCls}" ${actionAttr}>
                        <div class="flex items-center gap-3 w-full sm:w-auto overflow-hidden">
                            <div class="h-10 w-10 sm:h-12 sm:w-12 shrink-0 rounded-full flex items-center justify-center font-bold text-lg sm:text-xl ${isMasuk ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">
                                <i class="fa-solid ${isMasuk ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="flex items-center gap-2 mb-1.5">
                                    <span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px] font-bold border border-gray-200 whitespace-nowrap"><i class="fa-solid fa-calendar-day mr-1"></i> ${m.tanggal}</span>
                                    ${!isManual ? `<span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold border border-blue-200 whitespace-nowrap"><i class="fa-solid fa-robot mr-1"></i> Sistem</span>` : ''}
                                </div>
                                <p class="text-xs sm:text-sm text-gray-800 font-medium leading-snug break-words whitespace-normal">${m.keterangan}</p>
                            </div>
                        </div>
                        <div class="flex flex-row sm:flex-col justify-between items-center sm:items-end w-full sm:w-auto mt-2 sm:mt-0 pt-2 sm:pt-0 border-t sm:border-0 border-gray-100 shrink-0 pl-0 sm:pl-2">
                            <p class="font-bold text-sm sm:text-base ${isMasuk ? 'text-green-600' : 'text-red-600'}">${isMasuk ? '+' : '-'}${formatRp(m.nominal)}</p>
                            ${userRole === 'admin' && isManual ? `<span class="text-[10px] text-blue-600 font-bold sm:opacity-0 group-hover:opacity-100 transition inline-block mt-1 bg-blue-50 px-2 py-1 rounded border border-blue-100 shadow-sm"><i class="fa-solid fa-pen mr-1"></i>Edit</span>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        function editKasLainnya(id) {
            const m = dataMutasi.find(x => x.id === id);
            if(m) {
                document.getElementById('edit-kas-id').value = m.id;
                document.getElementById('edit-kas-jenis').value = m.jenis;
                document.getElementById('edit-kas-tgl').value = m.tanggal;
                document.getElementById('edit-kas-nominal').value = m.nominal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                document.getElementById('edit-kas-ket').value = m.keterangan;
                document.getElementById('btn-hapus-kas-modal').onclick = () => hapusKasLainnya(id);
                document.getElementById('modal-edit-kas').classList.remove('hidden');
            }
        }

        function tutupModalEditKas() { document.getElementById('modal-edit-kas').classList.add('hidden'); }

        function simpanEditKas() {
            const id = document.getElementById('edit-kas-id').value;
            const jenis = document.getElementById('edit-kas-jenis').value;
            const tgl = document.getElementById('edit-kas-tgl').value;
            const nominalInput = document.getElementById('edit-kas-nominal').value;
            const nominal = parseInt(nominalInput ? nominalInput.replace(/\./g, '') : "0");
            const ket = document.getElementById('edit-kas-ket').value.trim();

            if(!tgl || !nominal || isNaN(nominal) || nominal <= 0 || !ket) return showDialog('alert', 'Kesalahan', 'Mohon isi data!');

            setDoc(doc(getColl('mutasi'), id), { jenis, tanggal: tgl, nominal, keterangan: ket }, { merge: true }).then(() => {
                tutupModalEditKas(); showToast('Perubahan transaksi disimpan.');
            });
        }

        function hapusKasLainnya(id) {
            showDialog('confirm', 'Hapus Transaksi Kas', 'Hapus riwayat transaksi ini?', () => {
                deleteDoc(doc(getColl('mutasi'), id.toString())).then(() => {
                    tutupModalEditKas(); showToast('Transaksi berhasil dihapus.');
                });
            });
        }

        // --- RENCANA PEMBANGUNAN ---
        function renderRencana() {
            const container = document.getElementById('container-rencana'); 
            if(!container) return;
            container.innerHTML = '';
            if(dataRencana.length === 0) {
                container.innerHTML = `<div class="col-span-full p-6 text-center text-gray-500 bg-white rounded-lg shadow-sm border border-gray-200 text-sm">Belum ada data rencana.</div>`; return;
            }
            dataRencana.forEach(r => {
                let badgeColor = r.status === 'Selesai' ? 'bg-green-100 text-green-800 border-green-200' : (r.status === 'Sedang Berjalan' ? 'bg-yellow-100 text-yellow-800 border-yellow-200' : 'bg-blue-100 text-blue-800 border-blue-200');
                let adminHtml = userRole === 'admin' ? `
                    <div class="mt-4 pt-3 border-t border-gray-100 flex justify-end gap-2">
                        <button onclick="bukaModalRencana(${r.id}); event.stopPropagation();" class="text-[11px] sm:text-xs px-3 py-2 text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg font-bold transition shadow-sm"><i class="fa-solid fa-pen mr-1"></i> Edit</button>
                        <button onclick="hapusRencana(${r.id}); event.stopPropagation();" class="text-[11px] sm:text-xs px-3 py-2 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg font-bold transition shadow-sm"><i class="fa-solid fa-trash mr-1"></i> Hapus</button>
                    </div>` : '';
                container.innerHTML += `
                    <div onclick="bukaDetailRencana(${r.id})" class="bg-white p-4 sm:p-5 rounded-xl shadow-sm border border-gray-200 flex flex-col justify-between hover:shadow-md transition cursor-pointer group">
                        <div>
                            <div class="flex justify-between items-start mb-2 gap-3">
                                <h4 class="font-bold text-gray-800 text-base sm:text-lg leading-tight break-words group-hover:text-blue-600 transition">${r.judul}</h4>
                                <span class="px-2 py-1 whitespace-nowrap text-[9px] sm:text-[10px] uppercase font-bold rounded-md border ${badgeColor} shrink-0">${r.status}</span>
                            </div>
                            <p class="text-[10px] sm:text-xs text-gray-400 mb-3"><i class="fa-solid fa-calendar-alt mr-1"></i> Diupdate: ${r.tanggal}</p>
                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed line-clamp-2">${r.deskripsi}</p>
                            <p class="text-[10px] text-blue-500 font-bold mt-2 opacity-0 group-hover:opacity-100 transition inline-block bg-blue-50 px-2 py-1 rounded">Klik untuk selengkapnya <i class="fa-solid fa-arrow-right ml-1"></i></p>
                        </div>${adminHtml}
                    </div>`;
            });
        }

        function bukaDetailRencana(id) {
            const r = dataRencana.find(x => x.id === id);
            if(r) {
                document.getElementById('detail-rencana-judul').innerText = r.judul;
                let badgeColor = r.status === 'Selesai' ? 'bg-green-100 text-green-800 border-green-200' : (r.status === 'Sedang Berjalan' ? 'bg-yellow-100 text-yellow-800 border-yellow-200' : 'bg-blue-100 text-blue-800 border-blue-200');
                const statusEl = document.getElementById('detail-rencana-status');
                statusEl.className = `px-2.5 py-1 text-[10px] sm:text-xs font-bold rounded-md border inline-block uppercase ${badgeColor}`;
                statusEl.innerText = r.status;
                document.getElementById('detail-rencana-tgl').innerHTML = `<i class="fa-solid fa-calendar-alt mr-1"></i> Diupdate: ${r.tanggal}`;
                document.getElementById('detail-rencana-deskripsi').innerText = r.deskripsi;
                document.getElementById('modal-detail-rencana').classList.remove('hidden');
            }
        }

        function tutupDetailRencana() {
            document.getElementById('modal-detail-rencana').classList.add('hidden');
        }

        function bukaModalRencana(id = null) {
            if(userRole !== 'admin') return;
            if(id) {
                const r = dataRencana.find(x => x.id === id);
                if(r) {
                    document.getElementById('form-rencana-id').value = r.id; document.getElementById('form-rencana-judul').value = r.judul;
                    document.getElementById('form-rencana-status').value = r.status; document.getElementById('form-rencana-deskripsi').value = r.deskripsi;
                    document.getElementById('modal-rencana-title').innerHTML = '<i class="fa-solid fa-pen-to-square mr-2"></i>Edit Rencana';
                }
            } else {
                document.getElementById('form-rencana-id').value = ''; document.getElementById('form-rencana-judul').value = '';
                document.getElementById('form-rencana-status').value = 'Direncanakan'; document.getElementById('form-rencana-deskripsi').value = '';
                document.getElementById('modal-rencana-title').innerHTML = '<i class="fa-solid fa-clipboard-list mr-2"></i>Form Rencana Pembangunan';
            }
            document.getElementById('modal-rencana').classList.remove('hidden');
        }

        function tutupModalRencana() { document.getElementById('modal-rencana').classList.add('hidden'); }

        function simpanRencana() {
            if(userRole !== 'admin') return;
            const idForm = document.getElementById('form-rencana-id').value;
            const payload = {
                judul: document.getElementById('form-rencana-judul').value.trim(),
                status: document.getElementById('form-rencana-status').value,
                deskripsi: document.getElementById('form-rencana-deskripsi').value.trim(),
                tanggal: new Date().toLocaleDateString('id-ID')
            };

            if(!payload.judul || !payload.deskripsi) return showDialog('alert', 'Perhatian', 'Judul dan Deskripsi program tidak boleh kosong!');

            const docId = idForm ? idForm : Date.now().toString();
            if(!idForm) payload.id = Number(docId);

            setDoc(doc(getColl('rencana'), docId), payload, { merge: true }).then(() => {
                tutupModalRencana(); showToast('Rencana disimpan.');
            });
        }

        function hapusRencana(id) {
            if(userRole !== 'admin') return;
            showDialog('confirm', 'Hapus Rencana', 'Yakin ingin menghapus?', () => {
                deleteDoc(doc(getColl('rencana'), id.toString())).then(() => showToast('Rencana dihapus.'));
            });
        }

        // --- ASPIRASI WARGA ---
        function renderAspirasi() {
            const container = document.getElementById('container-aspirasi'); 
            if(!container) return;
            container.innerHTML = '';
            const aspirasiUrut = [...dataAspirasi].sort((a,b) => b.id - a.id);
            if(aspirasiUrut.length === 0) { container.innerHTML = `<div class="p-6 text-center text-gray-500 bg-white rounded-lg shadow-sm border border-gray-200 italic text-sm">Belum ada aspirasi.</div>`; return; }

            aspirasiUrut.forEach(a => {
                let adminTanggapanHtml = a.tanggapan ? `<div class="mt-3 bg-green-50 border-l-4 border-green-500 p-3 sm:p-4 rounded-r-lg"><p class="text-[10px] sm:text-xs font-bold text-green-800 mb-1.5"><i class="fa-solid fa-user-shield mr-1"></i> Tanggapan Pengurus RT:</p><p class="text-xs sm:text-sm text-green-900 whitespace-pre-line leading-relaxed">${a.tanggapan}</p></div>` : '';
                let aksiAdminHtml = userRole === 'admin' ? `
                    <div class="mt-3 sm:mt-4 pt-3 border-t border-gray-100 flex justify-end gap-2">
                        <button onclick="bukaModalTanggapan(${a.id})" class="text-[10px] sm:text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg shadow-sm font-bold transition"><i class="fa-solid fa-reply mr-1"></i> ${a.tanggapan ? 'Edit Tanggapan' : 'Beri Tanggapan'}</button>
                        <button onclick="hapusAspirasi(${a.id})" class="text-[10px] sm:text-xs bg-red-50 hover:bg-red-100 text-red-600 px-3 py-2 rounded-lg shadow-sm font-bold transition"><i class="fa-solid fa-trash mr-1"></i> Hapus</button>
                    </div>` : '';
                container.innerHTML += `
                    <div class="bg-white p-4 sm:p-5 rounded-xl shadow-sm border border-gray-200 transition hover:shadow-md">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center w-full">
                                <div class="h-8 w-8 sm:h-10 sm:w-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold mr-3 shrink-0"><i class="fa-solid fa-user"></i></div>
                                <div class="min-w-0 flex-1">
                                    <h4 class="font-bold text-sm sm:text-base text-gray-800 truncate">${a.nama}</h4>
                                    <p class="text-[9px] sm:text-[10px] text-gray-400 mt-0.5 truncate">${a.tanggal}</p>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs sm:text-sm text-gray-700 mt-2 whitespace-pre-line pl-0 sm:pl-12 leading-relaxed">${a.teks}</p>
                        <div class="pl-0 sm:pl-12">${adminTanggapanHtml}${aksiAdminHtml}</div>
                    </div>`;
            });
        }

        function simpanAspirasi() {
            let nama = document.getElementById('form-aspirasi-nama').value.trim() || 'Warga (Anonim)';
            const teks = document.getElementById('form-aspirasi-teks').value.trim();
            if(!teks) return showDialog('alert', 'Perhatian', 'Isi teks tidak boleh kosong!');

            const id = Date.now();
            setDoc(doc(getColl('aspirasi'), id.toString()), {
                id, nama, teks, tanggapan: null,
                tanggal: new Date().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })
            }).then(() => {
                document.getElementById('form-aspirasi-nama').value = ''; document.getElementById('form-aspirasi-teks').value = '';
                showToast('Aspirasi berhasil dikirim!');
            });
        }

        function hapusAspirasi(id) {
            if(userRole !== 'admin') return;
            showDialog('confirm', 'Hapus Aspirasi', 'Yakin ingin menghapus?', () => {
                deleteDoc(doc(getColl('aspirasi'), id.toString())).then(() => showToast('Aspirasi dihapus.'));
            });
        }

        function bukaModalTanggapan(id) {
            if(userRole !== 'admin') return;
            const a = dataAspirasi.find(x => x.id === id);
            if(a) {
                document.getElementById('form-tanggapan-id').value = a.id;
                document.getElementById('form-tanggapan-teks').value = a.tanggapan || '';
                document.getElementById('modal-tanggapan').classList.remove('hidden');
            }
        }

        function tutupModalTanggapan() { document.getElementById('modal-tanggapan').classList.add('hidden'); }

        function simpanTanggapan() {
            if(userRole !== 'admin') return;
            const id = document.getElementById('form-tanggapan-id').value;
            const tanggapan = document.getElementById('form-tanggapan-teks').value.trim() || null;
            
            setDoc(doc(getColl('aspirasi'), id), { tanggapan }, { merge: true }).then(() => {
                tutupModalTanggapan(); showToast('Tanggapan berhasil disimpan.');
            });
        }

        // --- HANDLER TOMBOL KEMBALI (BACK BUTTON) ---
        function setupBackButtonHandler() {
            try {
                // Memasukkan state awal agar tombol kembali bisa ditangkap
                history.pushState(null, null, location.href);

                window.addEventListener('popstate', function(event) {
                    const appContainer = document.getElementById('app-container');
                    
                    // Cek apakah pengguna sedang login dan berada di dalam aplikasi
                    if (appContainer && !appContainer.classList.contains('hidden')) {
                        const pageDashboard = document.getElementById('page-dashboard');
                        
                        if (pageDashboard && !pageDashboard.classList.contains('active')) {
                            // Jika berada di menu lain, arahkan ke Beranda
                            switchTab('dashboard');
                        } else {
                            // Jika sudah di Beranda, munculkan peringatan
                            showToast('Gunakan tombol Keluar (Power) di pojok atas untuk keluar aplikasi.');
                        }
                        
                        try {
                            // Dorong kembali state agar browser tetap tertahan di halaman ini
                            history.pushState(null, null, location.href);
                        } catch (e) {
                            console.warn('History API terbatas di lingkungan ini.');
                        }
                    } else {
                        // Jika berada di halaman login (Lock Screen), biarkan mereka keluar/menutup browser
                    }
                });
            } catch (error) {
                console.warn("Pencegahan tombol kembali dinonaktifkan secara otomatis (terkendala keamanan Sandbox).");
            }
        }

        // INIT LOAD
        window.onload = () => { 
            cekSesi(); 
            setupBackButtonHandler();
        };

    </script>
</body>
</html>
